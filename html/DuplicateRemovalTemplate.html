<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <?!= include('SharedStyles'); ?>
</head>
<body>
  <div class="nav-header">
    <button class="nav-back" onclick="backToMain()">‚Üê</button>
    <div class="nav-title">
      <h2>Remove Duplicates</h2>
      <p>Clean up duplicate data in your selection</p>
    </div>
  </div>
  
  <div class="container">
    <div id="statusMessage"></div>
    
    <div class="card">
      <div class="card-title">Detection Settings</div>
      <div class="card-description">Configure how duplicates are identified</div>
      
      <div class="form-group">
        <label class="form-label">Similarity Threshold</label>
        <input type="range" id="threshold" class="form-input" min="0.5" max="1" step="0.05" value="0.85">
        <div class="form-help">
          <span id="thresholdValue">85%</span> - Higher values require exact matches
        </div>
      </div>
      
      <div class="form-group">
        <div class="form-checkbox-group">
          <input type="checkbox" id="caseSensitive" class="form-checkbox">
          <label for="caseSensitive" class="form-checkbox-label">Case Sensitive Matching</label>
        </div>
      </div>
      
      <div class="form-group">
        <div class="form-checkbox-group">
          <input type="checkbox" id="trimWhitespace" class="form-checkbox" checked>
          <label for="trimWhitespace" class="form-checkbox-label">Trim Whitespace</label>
        </div>
      </div>
      
      <div class="form-group">
        <div class="form-checkbox-group">
          <input type="checkbox" id="ignoreSpecialChars" class="form-checkbox">
          <label for="ignoreSpecialChars" class="form-checkbox-label">Ignore Special Characters</label>
        </div>
      </div>
    </div>
    
    <div class="btn-group">
      <button class="btn btn-secondary" onclick="previewChanges()">
        <span class="spinner" id="previewSpinner" style="display:none"></span>
        Preview Changes
      </button>
      <button class="btn btn-primary" onclick="applyChanges()">
        <span class="spinner" id="applySpinner" style="display:none"></span>
        Remove Duplicates
      </button>
    </div>
    
    <div id="previewContainer" style="display: none;">
      <div class="preview-section">
        <div class="preview-title">Preview of Changes</div>
        <div id="previewContent"></div>
      </div>
    </div>
  </div>
  
  <script>
    // Update threshold display
    document.getElementById('threshold').addEventListener('input', function(e) {
      document.getElementById('thresholdValue').textContent = Math.round(e.target.value * 100) + '%';
    });
    
    function backToMain() {
      google.script.run.showCellPilotSidebar();
    }
    
    function getOptions() {
      return {
        threshold: parseFloat(document.getElementById('threshold').value),
        caseSensitive: document.getElementById('caseSensitive').checked,
        trimWhitespace: document.getElementById('trimWhitespace').checked,
        ignoreSpecialChars: document.getElementById('ignoreSpecialChars').checked
      };
    }
    
    function showStatus(message, type = 'info') {
      const statusDiv = document.getElementById('statusMessage');
      statusDiv.className = 'alert alert-' + type;
      statusDiv.textContent = message;
      statusDiv.style.display = 'block';
    }
    
    function hideStatus() {
      document.getElementById('statusMessage').style.display = 'none';
    }
    
    function previewChanges() {
      hideStatus();
      document.getElementById('previewSpinner').style.display = 'inline-block';
      document.getElementById('previewContainer').style.display = 'none';
      
      google.script.run
        .withSuccessHandler(function(result) {
          document.getElementById('previewSpinner').style.display = 'none';
          
          if (result.success) {
            if (result.duplicates && result.duplicates.length > 0) {
              let previewHtml = '<div class="stats-grid mb-2">';
              previewHtml += '<div class="stat-card"><div class="stat-value">' + result.totalRows + '</div><div class="stat-label">Total Rows</div></div>';
              previewHtml += '<div class="stat-card"><div class="stat-value">' + result.duplicates.length + '</div><div class="stat-label">Duplicates</div></div>';
              previewHtml += '<div class="stat-card"><div class="stat-value">' + (result.totalRows - result.duplicates.length) + '</div><div class="stat-label">Unique</div></div>';
              previewHtml += '</div>';
              
              // Show sample duplicates
              const sampleSize = Math.min(5, result.duplicates.length);
              for (let i = 0; i < sampleSize; i++) {
                const dup = result.duplicates[i];
                previewHtml += '<div class="preview-item">';
                previewHtml += '<span class="preview-item-old">Row ' + (dup.row + 1) + ': ' + dup.preview + '</span>';
                previewHtml += '</div>';
              }
              
              if (result.duplicates.length > sampleSize) {
                previewHtml += '<div class="text-center text-muted text-small mt-2">... and ' + (result.duplicates.length - sampleSize) + ' more duplicates</div>';
              }
              
              document.getElementById('previewContent').innerHTML = previewHtml;
              document.getElementById('previewContainer').style.display = 'block';
            } else {
              showStatus('No duplicates found with current settings', 'success');
            }
          } else {
            showStatus(result.error || 'Failed to preview duplicates', 'error');
          }
        })
        .withFailureHandler(function(error) {
          document.getElementById('previewSpinner').style.display = 'none';
          showStatus('Error: ' + error.message, 'error');
        })
        .previewDuplicates(getOptions());
    }
    
    function applyChanges() {
      if (!confirm('This will remove duplicate rows from your selection. Continue?')) {
        return;
      }
      
      hideStatus();
      document.getElementById('applySpinner').style.display = 'inline-block';
      
      google.script.run
        .withSuccessHandler(function(result) {
          document.getElementById('applySpinner').style.display = 'none';
          
          if (result.success) {
            showStatus(result.message, 'success');
            document.getElementById('previewContainer').style.display = 'none';
            
            // Return to main after 2 seconds
            setTimeout(function() {
              backToMain();
            }, 2000);
          } else {
            showStatus(result.error || 'Failed to remove duplicates', 'error');
            
            if (result.showUpgrade) {
              setTimeout(function() {
                google.script.run.showUpgradeOptions();
              }, 2000);
            }
          }
        })
        .withFailureHandler(function(error) {
          document.getElementById('applySpinner').style.display = 'none';
          showStatus('Error: ' + error.message, 'error');
        })
        .removeDuplicatesProcess(getOptions());
    }
  </script>
</body>
</html>