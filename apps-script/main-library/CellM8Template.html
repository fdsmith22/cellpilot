<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <?!= include('SharedStyles'); ?>
  <style>
    /* Enhanced styles matching main panel */
    .nav-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .nav-back {
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 18px;
      font-weight: 600;
    }
    
    .nav-back:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateX(-2px);
    }
    
    .nav-title h2 {
      color: white;
      margin: 0;
      font-size: 20px;
      font-weight: 700;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }
    
    .nav-title p {
      color: rgba(255, 255, 255, 0.9);
      margin: 2px 0 0 0;
      font-size: 12px;
    }
    
    /* Card styles matching main panel */
    .card {
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 12px;
      margin-bottom: 16px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      transition: all 0.2s ease;
    }
    
    .card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }
    
    .card-header {
      background: linear-gradient(135deg, #fafbfc 0%, #f0f7ff 100%);
      padding: 12px 16px;
      border-bottom: 1px solid var(--gray-100);
    }
    
    .card-header h3 {
      margin: 0;
      font-size: 14px;
      font-weight: 600;
      color: var(--gray-800);
    }
    
    .card-header p {
      margin: 2px 0 0 0;
      font-size: 11px;
      color: var(--gray-600);
    }
    
    /* Status messages with gradient */
    .status-message {
      padding: 12px;
      margin: 10px 0;
      border-radius: 8px;
      font-size: 13px;
      position: relative;
      overflow: hidden;
    }
    
    .status-success {
      background: linear-gradient(135deg, #d4f4dd 0%, #c8f1d6 100%);
      border: 1px solid var(--success-300);
      color: var(--success-800);
    }
    
    .status-error {
      background: linear-gradient(135deg, #fee4e2 0%, #fecaca 100%);
      border: 1px solid var(--error-300);
      color: var(--error-800);
    }
    
    .status-info {
      background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
      border: 1px solid var(--info-300);
      color: var(--info-800);
    }
    
    /* Enhanced buttons */
    .btn {
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(99, 102, 241, 0.2);
    }
    
    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }
    
    .btn-secondary {
      background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
      color: var(--gray-700);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .btn-secondary:hover {
      background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%);
    }
    
    .btn-success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
    }
    
    .btn-success:hover {
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    
    /* Preview container with gradient */
    .preview-container {
      background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      padding: 12px;
      margin: 12px 0;
    }
    
    .slide-preview {
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 6px;
      padding: 10px;
      margin: 8px 0;
      transition: all 0.2s ease;
    }
    
    .slide-preview:hover {
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      transform: translateX(2px);
    }
    
    .slide-preview h4 {
      margin: 0 0 4px 0;
      font-size: 12px;
      color: var(--gray-700);
      font-weight: 600;
    }
    
    .slide-preview p {
      margin: 0;
      font-size: 11px;
      color: var(--gray-600);
      line-height: 1.4;
    }
    
    /* Selection info box */
    #currentSelection {
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      border: 1px solid var(--info-200);
    }
    
    #currentSelection code {
      background: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 11px;
      color: var(--primary-600);
      border: 1px solid var(--gray-200);
    }
    
    /* Form controls enhancement */
    .form-control {
      border: 1px solid var(--gray-300);
      transition: all 0.2s ease;
    }
    
    .form-control:focus {
      border-color: var(--primary-500);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
      outline: none;
    }
    
    .form-label {
      font-weight: 600;
      color: var(--gray-700);
    }
    
    /* Result container with gradient */
    .status-success {
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
      padding: 16px;
      border-radius: 8px;
      border: 1px solid var(--success-300);
    }
    
    #presentationUrl {
      font-family: 'SF Mono', Monaco, 'Courier New', monospace;
      font-size: 11px;
      background: linear-gradient(135deg, #fafbfc 0%, #f0f7ff 100%);
    }
  </style>
</head>
<body>
  <div class="nav-header">
    <button class="nav-back" onclick="backToMain()">←</button>
    <div class="nav-title">
      <h2>Cell<span style="color: var(--primary-600);">M8</span></h2>
      <p>Create presentations from your data</p>
    </div>
  </div>
  
  <div class="container">
    <!-- Status Message -->
    <div id="statusMessage" style="display: none;"></div>
    
    <!-- Data Selection Card -->
    <div class="card">
      <div class="card-header">
        <h3>Data Selection</h3>
        <p>Choose the data to include</p>
      </div>
      <div class="card-body">
        <div id="currentSelection" style="padding: 8px; background: var(--gray-50); border-radius: 4px; margin-bottom: 12px;">
          <p style="margin: 0; font-size: 12px; color: var(--gray-600);">Loading selection...</p>
        </div>
        
        <div style="display: flex; gap: 8px; margin-bottom: 12px;">
          <button class="btn btn-sm" onclick="selectEntireData()" style="flex: 1;">
            Use All Data
          </button>
          <button class="btn btn-sm" onclick="useCurrentSelection()" style="flex: 1;">
            Use Selected Range
          </button>
        </div>
        
        <div class="form-group">
          <label class="form-label">Or enter specific range:</label>
          <input type="text" id="customRange" class="form-control" placeholder="e.g., A1:E10">
          <button class="btn btn-sm btn-secondary" onclick="selectCustomRange()" style="margin-top: 8px; width: 100%;">
            Apply Range
          </button>
        </div>
      </div>
    </div>
    
    <!-- Basic Settings Card -->
    <div class="card">
      <div class="card-header">
        <h3>Presentation Settings</h3>
        <p>Configure your presentation</p>
      </div>
      <div class="card-body">
        <div class="form-group">
          <label class="form-label">Presentation Title</label>
          <input type="text" id="presentationTitle" class="form-control" 
                 placeholder="Enter presentation title" value="Data Presentation">
        </div>
        
        <div class="form-group">
          <label class="form-label">Subtitle (optional)</label>
          <input type="text" id="presentationSubtitle" class="form-control" 
                 placeholder="Enter subtitle">
        </div>
        
        <div class="form-group">
          <label class="form-label">Number of Slides</label>
          <select id="slideCount" class="form-control">
            <option value="3">3 slides</option>
            <option value="5" selected>5 slides</option>
            <option value="7">7 slides</option>
            <option value="10">10 slides</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">Template Style</label>
          <select id="templateStyle" class="form-control">
            <option value="simple" selected>Simple</option>
            <option value="professional">Professional</option>
            <option value="modern">Modern</option>
          </select>
        </div>
      </div>
    </div>
    
    <!-- Preview Section -->
    <div class="card">
      <div class="card-header">
        <h3>Preview</h3>
        <p>See what will be created</p>
      </div>
      <div class="card-body">
        <button class="btn btn-secondary btn-block" onclick="generatePreview()">
          Generate Preview
        </button>
        
        <div id="previewContainer" class="preview-container" style="display: none;">
          <div id="previewContent"></div>
        </div>
      </div>
    </div>
    
    <!-- Action Buttons -->
    <div class="card">
      <div class="card-body">
        <button class="btn btn-primary btn-block" onclick="createPresentation()">
          Create Presentation
        </button>
        
        <div id="resultContainer" style="display: none; margin-top: 12px;">
          <div class="status-success">
            <p style="margin: 0; font-weight: 600;">Presentation Created!</p>
            <p style="margin: 4px 0 8px 0; font-size: 12px;" id="resultMessage"></p>
            
            <div style="background: white; padding: 8px; border-radius: 4px; margin: 8px 0;">
              <p style="margin: 0 0 4px 0; font-size: 11px; color: var(--gray-600);">Presentation Link:</p>
              <input type="text" id="presentationUrl" readonly style="width: 100%; padding: 4px; font-size: 11px; border: 1px solid var(--gray-200); border-radius: 3px; background: var(--gray-50);">
            </div>
            
            <div style="display: flex; gap: 8px;">
              <button class="btn btn-sm btn-success" onclick="openPresentation()" style="flex: 1;">
                Open in Google Slides
              </button>
              <button class="btn btn-sm" onclick="copyPresentationLink()" style="flex: 1;">
                Copy Link
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // Global variables
    var currentPreview = null;
    var presentationUrl = null;
    var currentSelectionInfo = null;
    
    // Initialize on load
    window.onload = function() {
      updateSelectionInfo();
    };
    
    // Navigation function
    function backToMain() {
      google.script.run.showCellPilotSidebar();
    }
    
    // Update selection info
    function updateSelectionInfo() {
      google.script.run
        .withSuccessHandler(function(result) {
          currentSelectionInfo = result;
          const selDiv = document.getElementById('currentSelection');
          if (result.success) {
            let html = '<p style="margin: 0; font-size: 12px;">';
            html += '<strong>Current: </strong>';
            if (result.hasSelection) {
              html += 'Selected range <code>' + result.range + '</code>';
            } else {
              html += 'Entire sheet';
            }
            html += ' (' + result.rows + ' rows × ' + result.cols + ' columns)';
            html += '</p>';
            selDiv.innerHTML = html;
          } else {
            selDiv.innerHTML = '<p style="margin: 0; font-size: 12px; color: var(--error-600);">Unable to get selection</p>';
          }
        })
        .withFailureHandler(function(error) {
          const selDiv = document.getElementById('currentSelection');
          selDiv.innerHTML = '<p style="margin: 0; font-size: 12px; color: var(--error-600);">Error: ' + error.message + '</p>';
        })
        .getCellM8Selection();
    }
    
    // Select entire data
    function selectEntireData() {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showStatus('Selected entire data range', 'success');
            updateSelectionInfo();
          } else {
            showStatus('Failed to select data', 'error');
          }
        })
        .withFailureHandler(function(error) {
          showStatus('Error: ' + error.message, 'error');
        })
        .selectCellM8EntireDataRange();
    }
    
    // Use current selection
    function useCurrentSelection() {
      updateSelectionInfo();
      showStatus('Using current selection', 'info');
    }
    
    // Select custom range
    function selectCustomRange() {
      const rangeInput = document.getElementById('customRange').value;
      if (!rangeInput) {
        showStatus('Please enter a range', 'error');
        return;
      }
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showStatus('Selected range: ' + result.range, 'success');
            updateSelectionInfo();
            document.getElementById('customRange').value = '';
          } else {
            showStatus('Invalid range: ' + rangeInput, 'error');
          }
        })
        .withFailureHandler(function(error) {
          showStatus('Error: ' + error.message, 'error');
        })
        .selectCellM8Range(rangeInput);
    }
    
    // Show status message
    function showStatus(message, type) {
      const statusDiv = document.getElementById('statusMessage');
      statusDiv.className = 'status-message status-' + type;
      statusDiv.textContent = message;
      statusDiv.style.display = 'block';
      
      // Auto-hide after 5 seconds
      setTimeout(function() {
        statusDiv.style.display = 'none';
      }, 5000);
    }
    
    // Generate preview
    function generatePreview() {
      const config = {
        title: document.getElementById('presentationTitle').value,
        subtitle: document.getElementById('presentationSubtitle').value,
        slideCount: parseInt(document.getElementById('slideCount').value),
        template: document.getElementById('templateStyle').value
      };
      
      if (!config.title) {
        showStatus('Please enter a presentation title', 'error');
        return;
      }
      
      // Show loading
      showStatus('Analyzing data and generating preview...', 'info');
      
      // First extract and analyze data
      google.script.run
        .withSuccessHandler(function(dataResult) {
          if (dataResult.success) {
            // Now analyze the data
            google.script.run
              .withSuccessHandler(function(analysisResult) {
                if (analysisResult.success) {
                  config.analysis = analysisResult.analysis;
                  config.data = dataResult;
                  
                  // Generate preview with analyzed data
                  google.script.run
                    .withSuccessHandler(function(result) {
                      if (result.success) {
                        currentPreview = result;
                        currentPreview.analysis = analysisResult.analysis;
                        displayPreview(result);
                        showStatus('Preview generated with data analysis', 'success');
                      } else {
                        showStatus(result.error || 'Failed to generate preview', 'error');
                      }
                    })
                    .withFailureHandler(function(error) {
                      showStatus('Error: ' + error.message, 'error');
                    })
                    .previewCellM8Presentation(config);
                } else {
                  showStatus('Failed to analyze data', 'error');
                }
              })
              .withFailureHandler(function(error) {
                showStatus('Error analyzing data: ' + error.message, 'error');
              })
              .analyzeCellM8Data(dataResult);
          } else {
            showStatus('No data found to preview', 'error');
          }
        })
        .withFailureHandler(function(error) {
          showStatus('Error extracting data: ' + error.message, 'error');
        })
        .extractCellM8Data();
    }
    
    // Display preview
    function displayPreview(preview) {
      const container = document.getElementById('previewContainer');
      const content = document.getElementById('previewContent');
      
      let html = '<h4 style="margin: 0 0 8px 0; font-size: 13px;">Preview (' + preview.slideCount + ' slides)</h4>';
      
      if (preview.dataInfo) {
        html += '<p style="font-size: 11px; color: var(--gray-600); margin-bottom: 8px;">';
        html += 'Data: ' + preview.dataInfo.rows + ' rows × ' + preview.dataInfo.columns + ' columns';
        
        if (preview.analysis && preview.analysis.completeness) {
          html += ' | Completeness: ' + preview.analysis.completeness + '%';
        }
        html += '</p>';
      }
      
      // Show analysis insights if available
      if (preview.analysis && preview.analysis.statistics) {
        html += '<div style="background: var(--info-50); padding: 8px; border-radius: 4px; margin-bottom: 8px;">';
        html += '<p style="font-size: 11px; margin: 0; font-weight: 600;">Data Analysis:</p>';
        html += '<ul style="margin: 4px 0 0 16px; padding: 0; font-size: 11px;">';
        
        const stats = Object.keys(preview.analysis.statistics).slice(0, 3);
        stats.forEach(function(key) {
          const stat = preview.analysis.statistics[key];
          if (stat && stat.average) {
            html += '<li>' + key + ': Avg ' + Math.round(stat.average) + '</li>';
          }
        });
        
        html += '</ul>';
        html += '</div>';
      }
      
      // Show slide previews
      if (preview.slides && preview.slides.length > 0) {
        preview.slides.forEach(function(slide, index) {
          html += '<div class="slide-preview">';
          html += '<h4>Slide ' + (index + 1) + ': ' + slide.title + '</h4>';
          
          if (slide.bullets && slide.bullets.length > 0) {
            html += '<ul style="margin: 4px 0 0 16px; padding: 0; font-size: 10px;">';
            slide.bullets.forEach(function(bullet) {
              html += '<li>' + bullet + '</li>';
            });
            html += '</ul>';
          } else {
            html += '<p>' + (slide.subtitle || slide.content || '') + '</p>';
          }
          
          html += '</div>';
        });
      }
      
      content.innerHTML = html;
      container.style.display = 'block';
    }
    
    // Create presentation
    function createPresentation() {
      const config = {
        title: document.getElementById('presentationTitle').value,
        subtitle: document.getElementById('presentationSubtitle').value,
        slideCount: parseInt(document.getElementById('slideCount').value),
        template: document.getElementById('templateStyle').value,
        content: currentPreview ? currentPreview.slides : []
      };
      
      if (!config.title) {
        showStatus('Please enter a presentation title', 'error');
        return;
      }
      
      // Show loading
      showStatus('Creating presentation with ' + config.template + ' template...', 'info');
      
      // Call server function
      google.script.run
        .withSuccessHandler(function(result) {
          console.log('Create presentation result:', result);
          if (result.success && result.url) {
            presentationUrl = result.url;
            showResult(result);
            showStatus('Presentation created successfully!', 'success');
            
            // Optionally apply template (for future enhancement)
            if (config.template && config.template !== 'simple') {
              google.script.run
                .withSuccessHandler(function(templateResult) {
                  console.log('Template applied:', templateResult);
                })
                .withFailureHandler(function(error) {
                  console.log('Template error:', error);
                })
                .applyCellM8Template({id: result.presentationId}, config.template);
            }
          } else {
            showStatus(result.error || 'Failed to create presentation', 'error');
            console.error('Creation failed:', result);
          }
        })
        .withFailureHandler(function(error) {
          showStatus('Error: ' + error.message, 'error');
          console.error('Creation error:', error);
        })
        .createCellM8Presentation(config);
    }
    
    // Show result
    function showResult(result) {
      const container = document.getElementById('resultContainer');
      const message = document.getElementById('resultMessage');
      const urlInput = document.getElementById('presentationUrl');
      
      message.textContent = result.slideCount + ' slides created';
      presentationUrl = result.url;
      
      // Display the URL in the input field
      if (urlInput && result.url) {
        urlInput.value = result.url;
      }
      
      container.style.display = 'block';
    }
    
    // Open presentation
    function openPresentation() {
      if (presentationUrl) {
        window.open(presentationUrl, '_blank');
      } else {
        showStatus('No presentation URL available', 'error');
      }
    }
    
    // Copy presentation link
    function copyPresentationLink() {
      const urlInput = document.getElementById('presentationUrl');
      if (urlInput && urlInput.value) {
        urlInput.select();
        document.execCommand('copy');
        showStatus('Link copied to clipboard!', 'success');
      } else {
        showStatus('No link to copy', 'error');
      }
    }
    
    // Test function - simple alert
    function testCellM8() {
      google.script.run
        .withSuccessHandler(function(result) {
          alert('Test successful: ' + JSON.stringify(result));
        })
        .withFailureHandler(function(error) {
          alert('Test failed: ' + error.message);
        })
        .testCellM8Function();
    }
  </script>
</body>
</html>