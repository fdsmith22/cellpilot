<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <?!= include('SharedStyles'); ?>
  <style>
    .status-message {
      padding: 12px;
      margin: 10px 0;
      border-radius: 6px;
      font-size: 13px;
    }
    
    .status-success {
      background: var(--success-50);
      border: 1px solid var(--success-200);
      color: var(--success-700);
    }
    
    .status-error {
      background: var(--error-50);
      border: 1px solid var(--error-200);
      color: var(--error-700);
    }
    
    .status-info {
      background: var(--info-50);
      border: 1px solid var(--info-200);
      color: var(--info-700);
    }
    
    .preview-container {
      background: var(--gray-50);
      border-radius: 8px;
      padding: 12px;
      margin: 12px 0;
    }
    
    .slide-preview {
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 4px;
      padding: 8px;
      margin: 8px 0;
    }
    
    .slide-preview h4 {
      margin: 0 0 4px 0;
      font-size: 12px;
      color: var(--gray-700);
    }
    
    .slide-preview p {
      margin: 0;
      font-size: 11px;
      color: var(--gray-600);
    }
  </style>
</head>
<body>
  <div class="nav-header">
    <button class="nav-back" onclick="backToMain()">←</button>
    <div class="nav-title">
      <h2>Cell<span style="color: var(--primary-600);">M8</span></h2>
      <p>Create presentations from your data</p>
    </div>
  </div>
  
  <div class="container">
    <!-- Status Message -->
    <div id="statusMessage" style="display: none;"></div>
    
    <!-- Basic Settings Card -->
    <div class="card">
      <div class="card-header">
        <h3>Presentation Settings</h3>
        <p>Configure your presentation</p>
      </div>
      <div class="card-body">
        <div class="form-group">
          <label class="form-label">Presentation Title</label>
          <input type="text" id="presentationTitle" class="form-control" 
                 placeholder="Enter presentation title" value="Data Presentation">
        </div>
        
        <div class="form-group">
          <label class="form-label">Subtitle (optional)</label>
          <input type="text" id="presentationSubtitle" class="form-control" 
                 placeholder="Enter subtitle">
        </div>
        
        <div class="form-group">
          <label class="form-label">Number of Slides</label>
          <select id="slideCount" class="form-control">
            <option value="3">3 slides</option>
            <option value="5" selected>5 slides</option>
            <option value="7">7 slides</option>
            <option value="10">10 slides</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">Template Style</label>
          <select id="templateStyle" class="form-control">
            <option value="simple" selected>Simple</option>
            <option value="professional">Professional</option>
            <option value="modern">Modern</option>
          </select>
        </div>
      </div>
    </div>
    
    <!-- Preview Section -->
    <div class="card">
      <div class="card-header">
        <h3>Preview</h3>
        <p>See what will be created</p>
      </div>
      <div class="card-body">
        <button class="btn btn-secondary btn-block" onclick="generatePreview()">
          Generate Preview
        </button>
        
        <div id="previewContainer" class="preview-container" style="display: none;">
          <div id="previewContent"></div>
        </div>
      </div>
    </div>
    
    <!-- Action Buttons -->
    <div class="card">
      <div class="card-body">
        <button class="btn btn-primary btn-block" onclick="createPresentation()">
          Create Presentation
        </button>
        
        <div id="resultContainer" style="display: none; margin-top: 12px;">
          <div class="status-success">
            <p style="margin: 0; font-weight: 600;">Presentation Created!</p>
            <p style="margin: 4px 0 8px 0; font-size: 12px;" id="resultMessage"></p>
            <button class="btn btn-sm btn-success" onclick="openPresentation()">
              Open in Google Slides
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // Global variables
    var currentPreview = null;
    var presentationUrl = null;
    
    // Navigation function
    function backToMain() {
      google.script.run.showCellPilotSidebar();
    }
    
    // Show status message
    function showStatus(message, type) {
      const statusDiv = document.getElementById('statusMessage');
      statusDiv.className = 'status-message status-' + type;
      statusDiv.textContent = message;
      statusDiv.style.display = 'block';
      
      // Auto-hide after 5 seconds
      setTimeout(function() {
        statusDiv.style.display = 'none';
      }, 5000);
    }
    
    // Generate preview
    function generatePreview() {
      const config = {
        title: document.getElementById('presentationTitle').value,
        subtitle: document.getElementById('presentationSubtitle').value,
        slideCount: parseInt(document.getElementById('slideCount').value),
        template: document.getElementById('templateStyle').value
      };
      
      if (!config.title) {
        showStatus('Please enter a presentation title', 'error');
        return;
      }
      
      // Show loading
      showStatus('Analyzing data and generating preview...', 'info');
      
      // First extract and analyze data
      google.script.run
        .withSuccessHandler(function(dataResult) {
          if (dataResult.success) {
            // Now analyze the data
            google.script.run
              .withSuccessHandler(function(analysisResult) {
                if (analysisResult.success) {
                  config.analysis = analysisResult.analysis;
                  config.data = dataResult;
                  
                  // Generate preview with analyzed data
                  google.script.run
                    .withSuccessHandler(function(result) {
                      if (result.success) {
                        currentPreview = result;
                        currentPreview.analysis = analysisResult.analysis;
                        displayPreview(result);
                        showStatus('Preview generated with data analysis', 'success');
                      } else {
                        showStatus(result.error || 'Failed to generate preview', 'error');
                      }
                    })
                    .withFailureHandler(function(error) {
                      showStatus('Error: ' + error.message, 'error');
                    })
                    .previewCellM8Presentation(config);
                } else {
                  showStatus('Failed to analyze data', 'error');
                }
              })
              .withFailureHandler(function(error) {
                showStatus('Error analyzing data: ' + error.message, 'error');
              })
              .analyzeCellM8Data(dataResult);
          } else {
            showStatus('No data found to preview', 'error');
          }
        })
        .withFailureHandler(function(error) {
          showStatus('Error extracting data: ' + error.message, 'error');
        })
        .extractCellM8Data();
    }
    
    // Display preview
    function displayPreview(preview) {
      const container = document.getElementById('previewContainer');
      const content = document.getElementById('previewContent');
      
      let html = '<h4 style="margin: 0 0 8px 0; font-size: 13px;">Preview (' + preview.slideCount + ' slides)</h4>';
      
      if (preview.dataInfo) {
        html += '<p style="font-size: 11px; color: var(--gray-600); margin-bottom: 8px;">';
        html += 'Data: ' + preview.dataInfo.rows + ' rows × ' + preview.dataInfo.columns + ' columns';
        
        if (preview.analysis && preview.analysis.completeness) {
          html += ' | Completeness: ' + preview.analysis.completeness + '%';
        }
        html += '</p>';
      }
      
      // Show analysis insights if available
      if (preview.analysis && preview.analysis.statistics) {
        html += '<div style="background: var(--info-50); padding: 8px; border-radius: 4px; margin-bottom: 8px;">';
        html += '<p style="font-size: 11px; margin: 0; font-weight: 600;">Data Analysis:</p>';
        html += '<ul style="margin: 4px 0 0 16px; padding: 0; font-size: 11px;">';
        
        const stats = Object.keys(preview.analysis.statistics).slice(0, 3);
        stats.forEach(function(key) {
          const stat = preview.analysis.statistics[key];
          if (stat && stat.average) {
            html += '<li>' + key + ': Avg ' + Math.round(stat.average) + '</li>';
          }
        });
        
        html += '</ul>';
        html += '</div>';
      }
      
      // Show slide previews
      if (preview.slides && preview.slides.length > 0) {
        preview.slides.forEach(function(slide, index) {
          html += '<div class="slide-preview">';
          html += '<h4>Slide ' + (index + 1) + ': ' + slide.title + '</h4>';
          
          if (slide.bullets && slide.bullets.length > 0) {
            html += '<ul style="margin: 4px 0 0 16px; padding: 0; font-size: 10px;">';
            slide.bullets.forEach(function(bullet) {
              html += '<li>' + bullet + '</li>';
            });
            html += '</ul>';
          } else {
            html += '<p>' + (slide.subtitle || slide.content || '') + '</p>';
          }
          
          html += '</div>';
        });
      }
      
      content.innerHTML = html;
      container.style.display = 'block';
    }
    
    // Create presentation
    function createPresentation() {
      const config = {
        title: document.getElementById('presentationTitle').value,
        subtitle: document.getElementById('presentationSubtitle').value,
        slideCount: parseInt(document.getElementById('slideCount').value),
        template: document.getElementById('templateStyle').value,
        content: currentPreview ? currentPreview.slides : []
      };
      
      if (!config.title) {
        showStatus('Please enter a presentation title', 'error');
        return;
      }
      
      // Show loading
      showStatus('Creating presentation with ' + config.template + ' template...', 'info');
      
      // Call server function
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success && result.presentationId) {
            presentationUrl = result.url;
            
            // Apply template
            google.script.run
              .withSuccessHandler(function(templateResult) {
                if (templateResult.success) {
                  showResult(result);
                  showStatus('Presentation created with ' + config.template + ' template!', 'success');
                } else {
                  showResult(result);
                  showStatus('Presentation created (template not applied)', 'success');
                }
              })
              .withFailureHandler(function(error) {
                showResult(result);
                showStatus('Presentation created (template error)', 'success');
              })
              .applyCellM8Template(result, config.template);
          } else {
            showStatus(result.error || 'Failed to create presentation', 'error');
          }
        })
        .withFailureHandler(function(error) {
          showStatus('Error: ' + error.message, 'error');
        })
        .createCellM8Presentation(config);
    }
    
    // Show result
    function showResult(result) {
      const container = document.getElementById('resultContainer');
      const message = document.getElementById('resultMessage');
      
      message.textContent = result.slideCount + ' slides created';
      presentationUrl = result.url;
      
      container.style.display = 'block';
    }
    
    // Open presentation
    function openPresentation() {
      if (presentationUrl) {
        window.open(presentationUrl, '_blank');
      } else {
        showStatus('No presentation URL available', 'error');
      }
    }
    
    // Test function - simple alert
    function testCellM8() {
      google.script.run
        .withSuccessHandler(function(result) {
          alert('Test successful: ' + JSON.stringify(result));
        })
        .withFailureHandler(function(error) {
          alert('Test failed: ' + error.message);
        })
        .testCellM8Function();
    }
  </script>
</body>
</html>