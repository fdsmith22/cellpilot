<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <?!= include('SharedStyles'); ?>
  <style>
    /* Step indicator styling */
    .step-indicator {
      display: flex;
      justify-content: space-between;
      margin: 20px 0 30px 0;
      position: relative;
    }
    
    /* Progress line behind steps */
    .step-indicator::before {
      content: '';
      position: absolute;
      top: 20px;
      left: 40px;
      right: 40px;
      height: 2px;
      background: var(--gray-200);
      z-index: 0;
    }
    
    .step {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
      position: relative;
      z-index: 2;
    }
    
    /* Individual step progress lines */
    .step::after {
      content: '';
      position: absolute;
      top: 20px;
      left: 50%;
      width: 100%;
      height: 2px;
      background: transparent;
      z-index: 1;
      transition: background 0.3s ease;
    }
    
    .step.completed::after {
      background: var(--primary-500);
    }
    
    .step:last-child::after {
      display: none;
    }
    
    .step-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: white;
      border: 3px solid var(--gray-300);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 14px;
      color: var(--gray-500);
      margin-bottom: 8px;
      position: relative;
      z-index: 3;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .step:not(.disabled) .step-circle:hover {
      border-color: var(--primary-400);
      transform: scale(1.1);
    }
    
    .step.disabled {
      pointer-events: none;
      opacity: 0.5;
    }
    
    .step.active .step-circle {
      border-color: var(--primary-500);
      color: var(--primary-600);
      background: var(--primary-50);
    }
    
    .step.completed .step-circle {
      background: var(--success-500);
      border-color: var(--success-500);
      color: white;
    }
    
    .step-label {
      font-size: 11px;
      color: var(--gray-600);
      text-align: center;
    }
    
    .step.active .step-label {
      color: var(--primary-600);
      font-weight: 600;
    }
    
    /* Pattern detection cards */
    .pattern-card {
      background: var(--gray-50);
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .pattern-card:hover {
      background: var(--primary-50);
      border-color: var(--primary-300);
    }
    
    .pattern-card.selected {
      background: var(--primary-100);
      border-color: var(--primary-500);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }
    
    .pattern-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .pattern-type {
      font-weight: 600;
      color: var(--gray-900);
      font-size: 13px;
    }
    
    .confidence-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 600;
    }
    
    .confidence-high {
      background: var(--success-100);
      color: var(--success-700);
    }
    
    .confidence-medium {
      background: var(--warning-100);
      color: var(--warning-700);
    }
    
    .confidence-low {
      background: var(--gray-100);
      color: var(--gray-700);
    }
    
    .pattern-preview {
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 11px;
      color: var(--gray-600);
      background: white;
      padding: 8px;
      border-radius: 4px;
      max-height: 60px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    
    .highlight-match {
      background: var(--warning-200);
      padding: 1px 3px;
      border-radius: 2px;
      font-weight: 600;
    }
    
    /* Column configuration */
    .column-config-grid {
      display: grid;
      gap: 12px;
      margin-top: 16px;
    }
    
    .delimiter-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 8px;
    }
    
    .delimiter-btn {
      padding: 6px 12px;
      border: 1px solid var(--gray-300);
      background: white;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .delimiter-btn:hover {
      border-color: var(--primary-400);
      background: var(--primary-50);
    }
    
    .delimiter-btn.active {
      background: var(--primary-500);
      color: white;
      border-color: var(--primary-500);
    }
    
    /* Preview table */
    .preview-container {
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      overflow: hidden;
      margin-top: 16px;
    }
    
    .preview-header {
      background: var(--gray-50);
      padding: 12px;
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .preview-stats {
      display: flex;
      gap: 16px;
      font-size: 12px;
      color: var(--gray-600);
    }
    
    .preview-stat {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .preview-stat-value {
      font-weight: 600;
      color: var(--gray-900);
    }
    
    .preview-table-wrapper {
      overflow-x: auto;
      overflow-y: auto;
      max-height: 400px;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      background: white;
      position: relative;
    }
    
    .preview-table {
      width: 100%;
      min-width: max-content;
      border-collapse: collapse;
      font-size: 12px;
    }
    
    .preview-table th {
      background: var(--gray-100);
      padding: 8px 12px;
      text-align: left;
      font-weight: 600;
      color: var(--gray-700);
      border-bottom: 2px solid var(--gray-200);
      border-right: 1px solid var(--gray-200);
      position: sticky;
      top: 0;
      z-index: 10;
      white-space: nowrap;
    }
    
    .preview-table th:last-child {
      border-right: none;
    }
    
    .preview-table td {
      padding: 8px 12px;
      border-bottom: 1px solid var(--gray-100);
      border-right: 1px solid var(--gray-100);
      color: var(--gray-900);
      white-space: nowrap;
    }
    
    .preview-table td:last-child {
      border-right: none;
    }
    
    .preview-table tr:hover {
      background: var(--gray-50);
    }
    
    .section-header-row {
      background: var(--primary-50) !important;
      font-weight: 600;
    }
    
    .section-header-row td {
      color: var(--primary-700);
      border-top: 2px solid var(--primary-200);
    }
    
    /* Header configuration */
    .header-config {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 8px;
      margin-top: 12px;
    }
    
    .header-input {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .header-input label {
      font-size: 10px;
      color: var(--gray-500);
      font-weight: 600;
    }
    
    .header-input input {
      padding: 6px 8px;
      border: 1px solid var(--gray-300);
      border-radius: 4px;
      font-size: 12px;
    }
    
    /* Processing animation */
    .processing-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .processing-card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      text-align: center;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }
    
    .processing-spinner {
      width: 48px;
      height: 48px;
      border: 3px solid var(--gray-200);
      border-top-color: var(--primary-500);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Enhanced form check styling */
    .form-check-enhanced {
      background: white;
      padding: 12px 14px;
      border-radius: 6px;
      border: 2px solid var(--gray-200);
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
    }
    
    .form-check-enhanced:hover {
      border-color: var(--primary-300);
      background: var(--primary-50);
    }
    
    .form-check-enhanced.selected {
      border-color: var(--primary-500);
      background: var(--primary-50);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }
    
    .form-check-enhanced input[type="radio"] {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }
    
    .form-check-enhanced label {
      cursor: pointer;
      display: block;
      padding-left: 24px;
      position: relative;
    }
    
    .form-check-enhanced label::before {
      content: '';
      position: absolute;
      left: 0;
      top: 2px;
      width: 16px;
      height: 16px;
      border: 2px solid var(--gray-400);
      border-radius: 50%;
      background: white;
      transition: all 0.2s ease;
    }
    
    .form-check-enhanced.selected label::before {
      border-color: var(--primary-500);
    }
    
    .form-check-enhanced.selected label::after {
      content: '';
      position: absolute;
      left: 5px;
      top: 7px;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--primary-500);
    }
    
    /* Step progress line improvement */
    .step-progress-line {
      position: absolute;
      top: 20px;
      left: 0;
      height: 2px;
      background: var(--primary-500);
      transition: width 0.3s ease;
      z-index: 1;
    }
  </style>
</head>
<body>
  <div class="nav-header">
    <button class="nav-back" onclick="backToMain()">←</button>
    <div class="nav-title">
      <h2>Advanced Data Restructuring</h2>
      <p>Transform complex unstructured data into clean tables</p>
    </div>
  </div>
  
  <div class="container">
    <!-- Notification Banner -->
    <div id="notificationBanner" style="display: none; margin-bottom: 16px;" role="alert" aria-live="polite"></div>
    
    <!-- Step Indicator -->
    <div class="step-indicator">
      <div class="step active" id="step1" onclick="navigateToStep(1)">
        <div class="step-circle">1</div>
        <div class="step-label">Analyze</div>
      </div>
      <div class="step disabled" id="step2" onclick="navigateToStep(2)">
        <div class="step-circle">2</div>
        <div class="step-label">Sections</div>
      </div>
      <div class="step disabled" id="step3" onclick="navigateToStep(3)">
        <div class="step-circle">3</div>
        <div class="step-label">Columns</div>
      </div>
      <div class="step disabled" id="step4" onclick="navigateToStep(4)">
        <div class="step-circle">4</div>
        <div class="step-label">Preview</div>
      </div>
    </div>
    
    <!-- Step 1: Analysis -->
    <div id="step1Content" class="step-content">
      <div class="card">
        <div class="card-header">
          <div class="card-title">Data Analysis</div>
          <div class="card-description">Select your data range and analyze its structure</div>
        </div>
        
        <!-- Initial selection prompt -->
        <div id="selectionPrompt" style="text-align: center; padding: 40px 20px;">
          <div style="margin-bottom: 20px;">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: var(--gray-400);">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="9" y1="9" x2="15" y2="9"></line>
              <line x1="9" y1="13" x2="15" y2="13"></line>
              <line x1="9" y1="17" x2="11" y2="17"></line>
            </svg>
          </div>
          <h3 style="color: var(--gray-700); margin-bottom: 8px;">Select Your Data</h3>
          <p style="color: var(--gray-600); margin-bottom: 24px; font-size: 14px;">
            Please select the range of cells containing the data you want to restructure
          </p>
          <button class="btn btn-primary" onclick="startAnalysis()">
            Analyze Selected Data
          </button>
        </div>
        
        <!-- Progress indicator (hidden initially) -->
        <div id="analysisProgressSection" style="display: none;">
          <div class="progress-container">
            <div class="progress">
              <div class="progress-bar" id="analysisProgress" style="width: 0%"></div>
            </div>
            <p class="progress-text" id="analysisStatus">Analyzing data structure...</p>
          </div>
        </div>
        
        <div id="analysisResults" style="display: none;">
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-value" id="totalLines">0</div>
              <div class="stat-label">Total Lines</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="detectedSections">0</div>
              <div class="stat-label">Detected Sections</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="dataTypes">0</div>
              <div class="stat-label">Data Types</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Step 2: Section Configuration -->
    <div id="step2Content" class="step-content" style="display: none;">
      <div class="card">
        <div class="card-header">
          <div class="card-title">Configure Section Separators</div>
          <div class="card-description">Define how to split your data into logical sections</div>
        </div>
        
        <!-- Detected Patterns -->
        <div id="detectedPatternsSection" style="margin-bottom: 20px;">
          <h4 class="section-title" style="margin-bottom: 12px; color: var(--gray-700); font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Detected Patterns</h4>
          <div id="patternsList"></div>
        </div>
        
        <!-- Data Structure Type -->
        <div class="form-group" style="background: var(--primary-50); padding: 16px; border-radius: 8px; margin-bottom: 20px; border: 2px solid var(--primary-200);">
          <label class="form-label" style="font-weight: 600; margin-bottom: 12px; display: block; color: var(--primary-700);">Data Structure Type</label>
          
          <div style="display: grid; gap: 12px;">
            <div class="form-check" style="background: white; padding: 12px; border-radius: 6px; border: 2px solid var(--gray-200); cursor: pointer; transition: all 0.2s;">
              <input type="radio" name="dataStructure" id="multiColumn" value="multi" checked style="margin-right: 8px;">
              <label for="multiColumn" style="cursor: pointer; font-weight: 500;">
                <span style="display: block;">Multi-column data</span>
                <span style="font-size: 11px; color: var(--gray-500); font-weight: 400;">Data is spread across multiple columns (standard mode)</span>
              </label>
            </div>
            
            <div class="form-check" style="background: white; padding: 12px; border-radius: 6px; border: 2px solid var(--gray-200); cursor: pointer; transition: all 0.2s;">
              <input type="radio" name="dataStructure" id="singleColumn" value="single" style="margin-right: 8px;">
              <label for="singleColumn" style="cursor: pointer; font-weight: 500;">
                <span style="display: flex; align-items: center; gap: 8px;">
                  Single-column data
                  <span style="background: var(--warning-500); color: white; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 600;">SPLIT MODE</span>
                </span>
                <span style="font-size: 11px; color: var(--gray-500); font-weight: 400;">All data is in one column and needs to be split into multiple columns</span>
              </label>
            </div>
          </div>
        </div>
        
        <!-- Single Column Split Options (hidden by default) -->
        <div id="singleColumnOptions" style="display: none; background: var(--warning-50); padding: 16px; border-radius: 8px; margin-bottom: 20px; border: 2px solid var(--warning-200);">
          <label class="form-label" style="font-weight: 600; margin-bottom: 12px; display: block; color: var(--warning-700);">Row Splitting Method</label>
          
          <div style="display: grid; gap: 12px;">
            <div class="form-check" style="background: white; padding: 12px; border-radius: 6px; border: 2px solid var(--gray-200); cursor: pointer; transition: all 0.2s;">
              <input type="radio" name="splitMethod" id="singleSpace" value="singleSpace" checked style="margin-right: 8px;">
              <label for="singleSpace" style="cursor: pointer; font-weight: 500;">
                <span style="display: block;">Single Space</span>
                <span style="font-size: 11px; color: var(--gray-500); font-weight: 400;">Split at every space character</span>
              </label>
            </div>
            
            <div class="form-check" style="background: white; padding: 12px; border-radius: 6px; border: 2px solid var(--gray-200); cursor: pointer; transition: all 0.2s;">
              <input type="radio" name="splitMethod" id="doubleSpace" value="doubleSpace" style="margin-right: 8px;">
              <label for="doubleSpace" style="cursor: pointer; font-weight: 500;">
                <span style="display: block;">Double Space</span>
                <span style="font-size: 11px; color: var(--gray-500); font-weight: 400;">Split at two or more consecutive spaces</span>
              </label>
            </div>
            
            <div class="form-check" style="background: white; padding: 12px; border-radius: 6px; border: 2px solid var(--gray-200); cursor: pointer; transition: all 0.2s;">
              <input type="radio" name="splitMethod" id="commaDelimited" value="comma" style="margin-right: 8px;">
              <label for="commaDelimited" style="cursor: pointer; font-weight: 500;">
                <span style="display: block;">Comma</span>
                <span style="font-size: 11px; color: var(--gray-500); font-weight: 400;">Split at comma characters</span>
              </label>
            </div>
            
            <div class="form-check" style="background: white; padding: 12px; border-radius: 6px; border: 2px solid var(--gray-200); cursor: pointer; transition: all 0.2s;">
              <input type="radio" name="splitMethod" id="tabDelimited" value="tab" style="margin-right: 8px;">
              <label for="tabDelimited" style="cursor: pointer; font-weight: 500;">
                <span style="display: block;">Tab</span>
                <span style="font-size: 11px; color: var(--gray-500); font-weight: 400;">Split at tab characters</span>
              </label>
            </div>
            
            <div class="form-check" style="background: white; padding: 12px; border-radius: 6px; border: 2px solid var(--gray-200); cursor: pointer; transition: all 0.2s;">
              <input type="radio" name="splitMethod" id="customDelimiter" value="custom" style="margin-right: 8px;">
              <label for="customDelimiter" style="cursor: pointer; font-weight: 500;">
                <span style="display: block;">Custom Delimiter</span>
                <span style="font-size: 11px; color: var(--gray-500); font-weight: 400;">Define your own delimiter</span>
              </label>
            </div>
          </div>
          
          <div id="customDelimiterInput" style="display: none; margin-top: 12px;">
            <input type="text" id="customDelimiterValue" class="form-input" placeholder="Enter custom delimiter (e.g., | or ::)">
          </div>
        </div>
        
        <!-- Manual Configuration -->
        <div class="form-group" style="background: var(--gray-50); padding: 16px; border-radius: 8px;">
          <label class="form-label" style="font-weight: 600; margin-bottom: 12px; display: block;">Section Separator Method</label>
          
          <div style="display: grid; gap: 12px;">
            <div class="form-check" style="background: white; padding: 12px; border-radius: 6px; border: 2px solid var(--gray-200); cursor: pointer; transition: all 0.2s;">
              <input type="radio" name="sectionMethod" id="noSections" value="none" checked style="margin-right: 8px;">
              <label for="noSections" style="cursor: pointer; font-weight: 500;">
                <span style="display: block;">No sections</span>
                <span style="font-size: 11px; color: var(--gray-500); font-weight: 400;">Treat entire selection as a single data block</span>
              </label>
            </div>
            
            <div class="form-check" style="background: white; padding: 12px; border-radius: 6px; border: 2px solid var(--gray-200); cursor: pointer; transition: all 0.2s;">
              <input type="radio" name="sectionMethod" id="keywordSection" value="keyword" style="margin-right: 8px;">
              <label for="keywordSection" style="cursor: pointer; font-weight: 500;">
                <span style="display: block;">Keyword separator</span>
                <span style="font-size: 11px; color: var(--gray-500); font-weight: 400;">Split when a specific word appears (e.g., "SECTION")</span>
              </label>
            </div>
            
            <div class="form-check" style="background: white; padding: 12px; border-radius: 6px; border: 2px solid var(--gray-200); cursor: pointer; transition: all 0.2s;">
              <input type="radio" name="sectionMethod" id="blankLineSection" value="blankline" style="margin-right: 8px;">
              <label for="blankLineSection" style="cursor: pointer; font-weight: 500;">
                <span style="display: block;">Blank line separator</span>
                <span style="font-size: 11px; color: var(--gray-500); font-weight: 400;">Use empty lines to identify section boundaries</span>
              </label>
            </div>
            
            <div class="form-check" style="background: white; padding: 12px; border-radius: 6px; border: 2px solid var(--gray-200); cursor: pointer; transition: all 0.2s;">
              <input type="radio" name="sectionMethod" id="patternSection" value="pattern" style="margin-right: 8px;">
              <label for="patternSection" style="cursor: pointer; font-weight: 500;">
                <span style="display: block;">Custom pattern</span>
                <span style="font-size: 11px; color: var(--gray-500); font-weight: 400;">Define your own regex pattern for section detection</span>
              </label>
            </div>
          </div>
        </div>
        
        <!-- Keyword Input -->
        <div id="keywordConfig" class="form-group" style="display: none;">
          <label class="form-label">Section Keyword</label>
          <input type="text" id="sectionKeyword" class="form-input" placeholder="Enter keyword (e.g., SECTION)">
          <div class="form-help">This keyword will mark the start of each new section</div>
        </div>
        
        <!-- Pattern Input -->
        <div id="patternConfig" class="form-group" style="display: none;">
          <label class="form-label">Section Pattern (Regex)</label>
          <input type="text" id="sectionPattern" class="form-input" placeholder="e.g., ^[A-Z\s]+$">
          <div class="form-help">Lines matching this pattern will start new sections</div>
        </div>
        
        <button class="btn btn-primary" onclick="processSections()">
          Analyze Sections
        </button>
      </div>
    </div>
    
    <!-- Step 3: Column Configuration -->
    <div id="step3Content" class="step-content" style="display: none;">
      <div class="card">
        <div class="card-header">
          <div class="card-title">Configure Column Splitting</div>
          <div class="card-description">Define how to split each row into columns</div>
        </div>
        
        <div class="form-group" style="background: var(--gray-50); padding: 16px; border-radius: 8px;">
          <label class="form-label" style="font-weight: 600; margin-bottom: 12px; display: block;">Column Splitting Method</label>
          
          <div style="display: grid; gap: 12px;">
            <div class="form-check" style="background: white; padding: 12px; border-radius: 6px; border: 2px solid var(--gray-200); cursor: pointer; transition: all 0.2s;">
              <input type="radio" name="columnMethod" id="smartSplit" value="smart" checked style="margin-right: 8px;">
              <label for="smartSplit" style="cursor: pointer; font-weight: 500;">
                <span style="display: flex; align-items: center; gap: 8px;">
                  Smart Detection
                  <span style="background: var(--primary-500); color: white; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 600;">RECOMMENDED</span>
                </span>
                <span style="font-size: 11px; color: var(--gray-500); font-weight: 400; display: block; margin-top: 4px;">Intelligently detects column boundaries based on patterns</span>
              </label>
            </div>
            
            <div class="form-check" style="background: white; padding: 12px; border-radius: 6px; border: 2px solid var(--gray-200); cursor: pointer; transition: all 0.2s;">
              <input type="radio" name="columnMethod" id="whitespaceSplit" value="whitespace" style="margin-right: 8px;">
              <label for="whitespaceSplit" style="cursor: pointer; font-weight: 500;">
                <span style="display: block;">Multiple Spaces/Tabs</span>
                <span style="font-size: 11px; color: var(--gray-500); font-weight: 400;">Split on consecutive whitespace characters</span>
              </label>
            </div>
            
            <div class="form-check" style="background: white; padding: 12px; border-radius: 6px; border: 2px solid var(--gray-200); cursor: pointer; transition: all 0.2s;">
              <input type="radio" name="columnMethod" id="delimiterSplit" value="delimiter" style="margin-right: 8px;">
              <label for="delimiterSplit" style="cursor: pointer; font-weight: 500;">
                <span style="display: block;">Specific Delimiter</span>
                <span style="font-size: 11px; color: var(--gray-500); font-weight: 400;">Choose a character to split columns (comma, pipe, etc.)</span>
              </label>
            </div>
            
            <div class="form-check" style="background: white; padding: 12px; border-radius: 6px; border: 2px solid var(--gray-200); cursor: pointer; transition: all 0.2s;">
              <input type="radio" name="columnMethod" id="fixedWidth" value="fixed" style="margin-right: 8px;">
              <label for="fixedWidth" style="cursor: pointer; font-weight: 500;">
                <span style="display: block;">Fixed Width Columns</span>
                <span style="font-size: 11px; color: var(--gray-500); font-weight: 400;">Define specific character positions for column boundaries</span>
              </label>
            </div>
          </div>
        </div>
        
        <!-- Delimiter Selection -->
        <div id="delimiterConfig" class="form-group" style="display: none;">
          <label class="form-label">Choose Delimiter</label>
          <div class="delimiter-buttons">
            <button class="delimiter-btn" data-delimiter=",">Comma (,)</button>
            <button class="delimiter-btn" data-delimiter="|">Pipe (|)</button>
            <button class="delimiter-btn" data-delimiter="\t">Tab</button>
            <button class="delimiter-btn" data-delimiter=";">Semicolon (;)</button>
            <button class="delimiter-btn" data-delimiter=":">Colon (:)</button>
            <button class="delimiter-btn" data-delimiter="custom">Custom...</button>
          </div>
          <input type="text" id="customDelimiter" class="form-input" 
                 placeholder="Enter custom delimiter" style="display: none; margin-top: 8px;">
        </div>
        
        <!-- Fixed Width Config -->
        <div id="fixedWidthConfig" class="form-group" style="display: none;">
          <label class="form-label">Column Positions (comma-separated)</label>
          <input type="text" id="columnPositions" class="form-input" 
                 placeholder="e.g., 10,25,40,60">
          <div class="form-help">Enter character positions where columns should split</div>
        </div>
        
        <!-- Advanced Options -->
        <div class="form-group" style="background: var(--gray-50); padding: 16px; border-radius: 8px; margin-top: 20px;">
          <label class="form-label" style="font-weight: 600; margin-bottom: 12px; display: block;">Advanced Options</label>
          
          <div style="display: grid; gap: 12px;">
            <label class="checkbox-card" style="background: white; padding: 12px; border-radius: 6px; border: 2px solid var(--gray-200); cursor: pointer; display: flex; align-items: center; transition: all 0.2s;">
              <input type="checkbox" id="trimWhitespace" checked style="margin-right: 12px; width: 18px; height: 18px; cursor: pointer;">
              <div>
                <span style="font-weight: 500; display: block;">Trim whitespace</span>
                <span style="font-size: 11px; color: var(--gray-500);">Remove extra spaces from beginning and end of values</span>
              </div>
            </label>
            
            <label class="checkbox-card" style="background: white; padding: 12px; border-radius: 6px; border: 2px solid var(--gray-200); cursor: pointer; display: flex; align-items: center; transition: all 0.2s;">
              <input type="checkbox" id="preserveEmpty" style="margin-right: 12px; width: 18px; height: 18px; cursor: pointer;">
              <div>
                <span style="font-weight: 500; display: block;">Preserve empty columns</span>
                <span style="font-size: 11px; color: var(--gray-500);">Keep columns even if they contain no data</span>
              </div>
            </label>
            
            <label class="checkbox-card" style="background: white; padding: 12px; border-radius: 6px; border: 2px solid var(--gray-200); cursor: pointer; display: flex; align-items: center; transition: all 0.2s;">
              <input type="checkbox" id="mergeConsecutive" style="margin-right: 12px; width: 18px; height: 18px; cursor: pointer;">
              <div>
                <span style="font-weight: 500; display: block;">Merge consecutive delimiters</span>
                <span style="font-size: 11px; color: var(--gray-500);">Treat multiple consecutive delimiters as one</span>
              </div>
            </label>
          </div>
        </div>
        
        <button class="btn btn-primary" onclick="processColumns()">
          Generate Preview
        </button>
      </div>
    </div>
    
    <!-- Step 4: Preview & Apply -->
    <div id="step4Content" class="step-content" style="display: none;">
      <div class="card">
        <div class="card-header">
          <div class="card-title">Preview & Apply</div>
          <div class="card-description">Review the restructured data before applying</div>
        </div>
        
        <div class="preview-container">
          <div class="preview-header">
            <div class="preview-title">Data Preview</div>
            <div class="preview-stats">
              <div class="preview-stat">
                <span>Sections:</span>
                <span class="preview-stat-value" id="previewSections">0</span>
              </div>
              <div class="preview-stat">
                <span>Rows:</span>
                <span class="preview-stat-value" id="previewRows">0</span>
              </div>
              <div class="preview-stat">
                <span>Columns:</span>
                <span class="preview-stat-value" id="previewColumns">0</span>
              </div>
            </div>
          </div>
          
          <div class="preview-table-wrapper">
            <table class="preview-table" id="previewTable">
              <thead id="previewTableHead"></thead>
              <tbody id="previewTableBody"></tbody>
            </table>
          </div>
        </div>
        
        <!-- Column Headers -->
        <div class="form-group">
          <label class="form-label">Column Headers (Optional)</label>
          <div class="header-config" id="headerConfig"></div>
          <div class="form-help">Leave empty to use default headers or auto-detected values</div>
        </div>
        
        <!-- Action Buttons -->
        <div class="btn-group">
          <button class="btn btn-secondary" onclick="goToStep(3)">
            ← Back to Column Config
          </button>
          <button class="btn btn-success" onclick="applyRestructuring()">
            Apply to Spreadsheet
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Processing Overlay -->
  <div class="processing-overlay" id="processingOverlay">
    <div class="processing-card">
      <div class="processing-spinner"></div>
      <div class="processing-text" id="processingText">Processing...</div>
    </div>
  </div>
  
  <script>
    // Global state
    let currentStep = 1;
    let analysisData = null;
    let sectionData = null;
    let columnData = null;
    let previewData = null;
    
    // Step navigation
    function navigateToStep(stepNumber) {
      // Check if step is accessible
      const stepElement = document.getElementById(`step${stepNumber}`);
      if (stepElement.classList.contains('disabled')) {
        return;
      }
      
      // Show the requested step
      showStep(stepNumber);
    }
    
    function showStep(stepNumber) {
      // Hide all steps
      document.querySelectorAll('.step-content').forEach(content => {
        content.style.display = 'none';
      });
      
      // Show selected step
      document.getElementById(`step${stepNumber}Content`).style.display = 'block';
      
      // Update step indicators
      document.querySelectorAll('.step').forEach((step, index) => {
        const stepNum = index + 1;
        step.classList.remove('active', 'completed');
        
        if (stepNum < stepNumber) {
          step.classList.add('completed');
          step.querySelector('.step-circle').textContent = '✓';
          step.classList.remove('disabled');
        } else if (stepNum === stepNumber) {
          step.classList.add('active');
          step.classList.remove('disabled');
          step.querySelector('.step-circle').textContent = stepNum;
        } else {
          // Future steps - check if they should be enabled
          if (canAccessStep(stepNum)) {
            step.classList.remove('disabled');
          } else {
            step.classList.add('disabled');
          }
          step.querySelector('.step-circle').textContent = stepNum;
        }
      });
      
      currentStep = stepNumber;
    }
    
    function canAccessStep(stepNumber) {
      switch(stepNumber) {
        case 1:
          return true; // Always can go to step 1
        case 2:
          return analysisData !== null;
        case 3:
          return sectionData !== null;
        case 4:
          return columnData !== null;
        default:
          return false;
      }
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      initializeEventListeners();
      
      // Set initial selected states for default radio buttons
      document.querySelector('#multiColumn').closest('.form-check').classList.add('selected');
      document.querySelector('#multiColumn').closest('.form-check').style.borderColor = 'var(--primary-500)';
      document.querySelector('#multiColumn').closest('.form-check').style.background = 'var(--primary-50)';
      
      document.querySelector('#noSections').closest('.form-check').classList.add('selected');
      document.querySelector('#noSections').closest('.form-check').style.borderColor = 'var(--primary-500)';
      document.querySelector('#noSections').closest('.form-check').style.background = 'var(--primary-50)';
      
      document.querySelector('#smartSplit').closest('.form-check').classList.add('selected');
      document.querySelector('#smartSplit').closest('.form-check').style.borderColor = 'var(--primary-500)';
      document.querySelector('#smartSplit').closest('.form-check').style.background = 'var(--primary-50)';
      
      // Don't auto-start analysis - wait for user to click button
      // startAnalysis();
    });
    
    function initializeEventListeners() {
      // Enhanced form check interactions
      document.querySelectorAll('.form-check').forEach(check => {
        if (check.querySelector('input[type="radio"]')) {
          check.addEventListener('click', function() {
            const radio = this.querySelector('input[type="radio"]');
            if (radio) {
              radio.checked = true;
              radio.dispatchEvent(new Event('change'));
              
              // Update visual selection
              document.querySelectorAll('.form-check').forEach(c => {
                if (c.querySelector('input[name="' + radio.name + '"]')) {
                  c.classList.remove('selected');
                  c.style.borderColor = '';
                  c.style.background = '';
                }
              });
              this.classList.add('selected');
              this.style.borderColor = 'var(--primary-500)';
              this.style.background = 'var(--primary-50)';
            }
          });
        }
      });
      
      // Data structure type radio buttons
      document.querySelectorAll('input[name="dataStructure"]').forEach(radio => {
        radio.addEventListener('change', function() {
          document.getElementById('singleColumnOptions').style.display = 
            this.value === 'single' ? 'block' : 'none';
        });
      });
      
      // Split method radio buttons
      document.querySelectorAll('input[name="splitMethod"]').forEach(radio => {
        radio.addEventListener('change', function() {
          document.getElementById('customDelimiterInput').style.display = 
            this.value === 'custom' ? 'block' : 'none';
        });
      });
      
      // Section method radio buttons
      document.querySelectorAll('input[name="sectionMethod"]').forEach(radio => {
        radio.addEventListener('change', function() {
          document.getElementById('keywordConfig').style.display = 
            this.value === 'keyword' ? 'block' : 'none';
          document.getElementById('patternConfig').style.display = 
            this.value === 'pattern' ? 'block' : 'none';
        });
      });
      
      // Column method radio buttons
      document.querySelectorAll('input[name="columnMethod"]').forEach(radio => {
        radio.addEventListener('change', function() {
          document.getElementById('delimiterConfig').style.display = 
            this.value === 'delimiter' ? 'block' : 'none';
          document.getElementById('fixedWidthConfig').style.display = 
            this.value === 'fixed' ? 'block' : 'none';
        });
      });
      
      // Delimiter buttons
      document.querySelectorAll('.delimiter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.delimiter-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          
          const customInput = document.getElementById('customDelimiter');
          if (this.dataset.delimiter === 'custom') {
            customInput.style.display = 'block';
            customInput.focus();
          } else {
            customInput.style.display = 'none';
          }
        });
      });
    }
    
    function startAnalysis() {
      // Hide selection prompt and show progress
      document.getElementById('selectionPrompt').style.display = 'none';
      document.getElementById('analysisProgressSection').style.display = 'block';
      
      updateProgress('analysisProgress', 20);
      document.getElementById('analysisStatus').textContent = 'Reading selected data...';
      
      google.script.run
        .withSuccessHandler(onAnalysisComplete)
        .withFailureHandler(onAnalysisError)
        .analyzeDataStructure();
    }
    
    function onAnalysisComplete(result) {
      hideProcessing();
      
      if (result.success) {
        analysisData = result;
        updateProgress('analysisProgress', 100);
        document.getElementById('analysisStatus').textContent = 'Analysis complete!';
        
        // Update stats
        document.getElementById('totalLines').textContent = result.totalLines || 0;
        document.getElementById('detectedSections').textContent = result.detectedSections || 0;
        document.getElementById('dataTypes').textContent = result.dataTypes || 0;
        document.getElementById('analysisResults').style.display = 'block';
        
        // Enable Step 2
        document.getElementById('step2').classList.remove('disabled');
        
        // Show detected patterns in next step
        if (result.patterns && result.patterns.length > 0) {
          displayDetectedPatterns(result.patterns);
        }
        
        // Auto-advance after delay
        setTimeout(() => goToStep(2), 1500);
        
      } else {
        showError(result.error || 'Analysis failed');
      }
    }
    
    function onAnalysisError(error) {
      hideProcessing();
      showError('Analysis error: ' + error.message);
    }
    
    function displayDetectedPatterns(patterns) {
      const container = document.getElementById('patternsList');
      container.innerHTML = '';
      
      patterns.forEach(pattern => {
        const card = document.createElement('div');
        card.className = 'pattern-card';
        card.onclick = () => selectPattern(pattern);
        
        const confidence = pattern.confidence > 0.7 ? 'high' : 
                          pattern.confidence > 0.4 ? 'medium' : 'low';
        
        card.innerHTML = `
          <div class="pattern-header">
            <span class="pattern-type">${pattern.type}</span>
            <span class="confidence-badge confidence-${confidence}">
              ${Math.round(pattern.confidence * 100)}% confidence
            </span>
          </div>
          <div class="pattern-preview">${escapeHtml(pattern.example)}</div>
        `;
        
        container.appendChild(card);
      });
    }
    
    function selectPattern(pattern) {
      // Auto-fill based on pattern
      if (pattern.type === 'KEYWORD_SECTION') {
        document.getElementById('keywordSection').checked = true;
        document.getElementById('sectionKeyword').value = pattern.keyword;
        document.getElementById('keywordConfig').style.display = 'block';
      }
      
      // Mark card as selected
      document.querySelectorAll('.pattern-card').forEach(card => {
        card.classList.remove('selected');
      });
      event.currentTarget.classList.add('selected');
    }
    
    function processSections() {
      const dataStructure = document.querySelector('input[name="dataStructure"]:checked').value;
      const method = document.querySelector('input[name="sectionMethod"]:checked').value;
      const config = { 
        method: method,
        dataStructure: dataStructure
      };
      
      // Handle single-column split mode
      if (dataStructure === 'single') {
        const splitMethod = document.querySelector('input[name="splitMethod"]:checked').value;
        config.splitMode = true;
        config.splitMethod = splitMethod;
        
        if (splitMethod === 'custom') {
          config.customDelimiter = document.getElementById('customDelimiterValue').value;
          if (!config.customDelimiter) {
            showError('Please enter a custom delimiter');
            return;
          }
        }
      }
      
      if (method === 'keyword') {
        config.keyword = document.getElementById('sectionKeyword').value;
        if (!config.keyword) {
          showError('Please enter a section keyword');
          return;
        }
      } else if (method === 'pattern') {
        config.pattern = document.getElementById('sectionPattern').value;
        if (!config.pattern) {
          showError('Please enter a section pattern');
          return;
        }
      }
      
      showProcessing('Processing sections...');
      
      google.script.run
        .withSuccessHandler(onSectionsProcessed)
        .withFailureHandler(onProcessError)
        .processSectionConfiguration(config);
    }
    
    function onSectionsProcessed(result) {
      hideProcessing();
      
      if (result.success) {
        sectionData = result;
        goToStep(3);
      } else {
        showError(result.error || 'Section processing failed');
      }
    }
    
    function processColumns() {
      const method = document.querySelector('input[name="columnMethod"]:checked').value;
      const config = { 
        method: method,
        trimWhitespace: document.getElementById('trimWhitespace').checked,
        preserveEmpty: document.getElementById('preserveEmpty').checked,
        mergeConsecutive: document.getElementById('mergeConsecutive').checked
      };
      
      if (method === 'delimiter') {
        const activeBtn = document.querySelector('.delimiter-btn.active');
        if (!activeBtn) {
          showError('Please select a delimiter');
          return;
        }
        
        if (activeBtn.dataset.delimiter === 'custom') {
          config.delimiter = document.getElementById('customDelimiter').value;
          if (!config.delimiter) {
            showError('Please enter a custom delimiter');
            return;
          }
        } else {
          config.delimiter = activeBtn.dataset.delimiter;
        }
      } else if (method === 'fixed') {
        config.positions = document.getElementById('columnPositions').value;
        if (!config.positions) {
          showError('Please enter column positions');
          return;
        }
      }
      
      showProcessing('Generating preview...');
      
      google.script.run
        .withSuccessHandler(onColumnsProcessed)
        .withFailureHandler(onProcessError)
        .processColumnConfiguration(config);
    }
    
    function onColumnsProcessed(result) {
      hideProcessing();
      
      if (result.success) {
        columnData = result;
        previewData = result.preview;
        displayPreview(result.preview);
        goToStep(4);
      } else {
        showError(result.error || 'Column processing failed');
      }
    }
    
    function displayPreview(data) {
      // Update stats
      document.getElementById('previewSections').textContent = data.sectionCount || 1;
      document.getElementById('previewRows').textContent = data.rows.length;
      document.getElementById('previewColumns').textContent = data.columnCount;
      
      // Build table
      const thead = document.getElementById('previewTableHead');
      const tbody = document.getElementById('previewTableBody');
      
      // Headers
      let headerHtml = '<tr>';
      for (let i = 0; i < data.columnCount; i++) {
        headerHtml += `<th>Column ${i + 1}</th>`;
      }
      headerHtml += '</tr>';
      thead.innerHTML = headerHtml;
      
      // Body - show first 20 rows
      let bodyHtml = '';
      const maxRows = Math.min(20, data.rows.length);
      
      for (let i = 0; i < maxRows; i++) {
        const row = data.rows[i];
        const isSection = row._isSection;
        
        bodyHtml += `<tr ${isSection ? 'class="section-header-row"' : ''}>`;
        for (let j = 0; j < data.columnCount; j++) {
          const value = row[j] || '';
          bodyHtml += `<td title="${escapeHtml(value)}">${escapeHtml(value)}</td>`;
        }
        bodyHtml += '</tr>';
      }
      
      if (data.rows.length > maxRows) {
        bodyHtml += `
          <tr>
            <td colspan="${data.columnCount}" style="text-align: center; font-style: italic;">
              ... and ${data.rows.length - maxRows} more rows
            </td>
          </tr>
        `;
      }
      
      tbody.innerHTML = bodyHtml;
      
      // Generate header inputs
      generateHeaderInputs(data.columnCount, data.suggestedHeaders);
    }
    
    function generateHeaderInputs(columnCount, suggested) {
      const container = document.getElementById('headerConfig');
      let html = '';
      
      for (let i = 0; i < columnCount; i++) {
        const suggestedValue = suggested && suggested[i] ? suggested[i] : '';
        html += `
          <div class="header-input">
            <label>Column ${i + 1}</label>
            <input type="text" class="header-field" placeholder="Header ${i + 1}" 
                   value="${suggestedValue}">
          </div>
        `;
      }
      
      container.innerHTML = html;
    }
    
    function applyRestructuring() {
      if (!confirm('This will replace your selected data with the restructured version. Continue?')) {
        return;
      }
      
      // Collect headers
      const headers = Array.from(document.querySelectorAll('.header-field'))
        .map(input => input.value.trim());
      
      const config = {
        headers: headers.filter(h => h.length > 0),
        includeHeaders: headers.some(h => h.length > 0)
      };
      
      showProcessing('Applying restructured data...');
      
      google.script.run
        .withSuccessHandler(onApplyComplete)
        .withFailureHandler(onProcessError)
        .applyRestructuredData(config);
    }
    
    function onApplyComplete(result) {
      hideProcessing();
      
      if (result.success) {
        showSuccess(`Successfully restructured ${result.rowsProcessed} rows into ${result.columnsCreated} columns`);
        setTimeout(() => backToMain(), 2000);
      } else {
        showError(result.error || 'Failed to apply restructuring');
      }
    }
    
    function onProcessError(error) {
      hideProcessing();
      showError('Processing error: ' + error.message);
    }
    
    // Navigation
    function goToStep(step) {
      // Enable the step and navigate using the unified function
      document.getElementById(`step${step}`).classList.remove('disabled');
      showStep(step);
      
      currentStep = step;
    }
    
    // Utilities
    function showProcessing(message) {
      document.getElementById('processingText').textContent = message;
      document.getElementById('processingOverlay').style.display = 'flex';
    }
    
    function hideProcessing() {
      document.getElementById('processingOverlay').style.display = 'none';
    }
    
    function updateProgress(elementId, percent) {
      document.getElementById(elementId).style.width = percent + '%';
    }
    
    function showError(message) {
      const banner = document.getElementById('notificationBanner');
      banner.className = 'alert alert-danger fade-in';
      banner.textContent = message;
      banner.style.display = 'block';
      
      // Auto-hide after 5 seconds
      setTimeout(() => {
        banner.style.display = 'none';
      }, 5000);
    }
    
    function showSuccess(message) {
      const banner = document.getElementById('notificationBanner');
      banner.className = 'alert alert-success fade-in';
      banner.textContent = message;
      banner.style.display = 'block';
      
      // Auto-hide after 3 seconds
      setTimeout(() => {
        banner.style.display = 'none';
      }, 3000);
    }
    
    function showInfo(message) {
      const banner = document.getElementById('notificationBanner');
      banner.className = 'alert alert-info fade-in';
      banner.textContent = message;
      banner.style.display = 'block';
      
      // Auto-hide after 3 seconds
      setTimeout(() => {
        banner.style.display = 'none';
      }, 3000);
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = String(text || '');
      return div.innerHTML;
    }
    
    function backToMain() {
      // Clear session data when leaving
      google.script.run.clearRestructuringSession();
      google.script.run.showCellPilotSidebar();
    }
  </script>
</body>
</html>