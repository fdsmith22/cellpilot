<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <?!= include('SharedStyles'); ?>
  <style>
    .pipeline-tabs {
      display: flex;
      background: var(--gray-100);
      border-radius: 8px;
      padding: 4px;
      margin-bottom: 16px;
    }
    
    .tab-button {
      flex: 1;
      padding: 8px 12px;
      border: none;
      background: transparent;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      color: var(--gray-600);
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .tab-button.active {
      background: white;
      color: var(--primary-600);
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .source-type-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-bottom: 16px;
    }
    
    .source-type-card {
      padding: 12px;
      background: white;
      border: 2px solid var(--gray-200);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
    }
    
    .source-type-card:hover {
      border-color: var(--primary-500);
      transform: translateY(-2px);
    }
    
    .source-type-card.selected {
      border-color: var(--primary-600);
      background: var(--primary-50);
    }
    
    .source-icon {
      font-size: 24px;
      margin-bottom: 8px;
      opacity: 0.7;
    }
    
    .source-name {
      font-size: 12px;
      font-weight: 600;
      color: var(--gray-700);
    }
    
    .source-desc {
      font-size: 10px;
      color: var(--gray-500);
      margin-top: 2px;
    }
    
    .import-form {
      display: none;
    }
    
    .import-form.active {
      display: block;
    }
    
    .advanced-options {
      margin-top: 12px;
      padding: 12px;
      background: var(--gray-50);
      border-radius: 6px;
    }
    
    .option-group {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    
    .option-label {
      font-size: 11px;
      color: var(--gray-700);
    }
    
    .history-item {
      padding: 10px;
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 6px;
      margin-bottom: 8px;
    }
    
    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }
    
    .history-type {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .history-type.import {
      background: var(--success-100);
      color: var(--success-700);
    }
    
    .history-type.export {
      background: var(--info-100);
      color: var(--info-700);
    }
    
    .history-time {
      font-size: 10px;
      color: var(--gray-500);
    }
    
    .history-details {
      font-size: 11px;
      color: var(--gray-600);
    }
    
    .schedule-badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 8px;
      background: var(--warning-100);
      border-radius: 4px;
      font-size: 10px;
      gap: 4px;
      color: var(--warning-700);
    }
    
    /* Action Buttons Group */
    .action-buttons {
      display: flex;
      gap: 8px;
      margin-top: 16px;
    }
    
    .btn-preview {
      flex: 1;
      padding: 10px;
      background: white;
      border: 2px solid var(--primary-500);
      color: var(--primary-600);
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .btn-preview:hover {
      background: var(--primary-50);
    }
    
    .btn-import, .btn-export {
      flex: 1;
      padding: 10px;
      background: var(--primary-500);
      border: 2px solid var(--primary-500);
      color: white;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .btn-import:hover, .btn-export:hover {
      background: var(--primary-600);
      border-color: var(--primary-600);
    }
    
    .btn-import:disabled, .btn-export:disabled {
      background: var(--gray-300);
      border-color: var(--gray-300);
      cursor: not-allowed;
    }
    
    /* Preview Modal */
    .preview-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .preview-modal.show {
      display: flex;
    }
    
    .preview-content {
      background: white;
      border-radius: 12px;
      padding: 20px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--gray-200);
    }
    
    .preview-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--gray-800);
    }
    
    .preview-close {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--gray-100);
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: var(--gray-600);
    }
    
    .preview-data {
      font-family: monospace;
      font-size: 11px;
      background: var(--gray-50);
      padding: 12px;
      border-radius: 6px;
      max-height: 300px;
      overflow: auto;
      white-space: pre-wrap;
      word-break: break-all;
    }
    
    .preview-stats {
      margin-top: 12px;
      padding: 12px;
      background: var(--info-50);
      border-radius: 6px;
    }
    
    .stat-row {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      font-size: 12px;
    }
    
    .stat-label {
      color: var(--gray-600);
    }
    
    .stat-value {
      font-weight: 600;
      color: var(--gray-800);
    }
  </style>
</head>
<body>
  <div class="nav-header">
    <button class="nav-back" onclick="backToMain()">‚Üê</button>
    <div class="nav-title">
      <h2>Data Pipeline Manager</h2>
      <p>Import & export data in multiple formats</p>
    </div>
  </div>
  
  <div class="container">
    <!-- Tab Navigation -->
    <div class="pipeline-tabs">
      <button class="tab-button active" onclick="switchTab('import')">Import</button>
      <button class="tab-button" onclick="switchTab('export')">Export</button>
      <button class="tab-button" onclick="switchTab('history')">History</button>
    </div>
    
    <!-- Import Tab -->
    <div id="import-tab" class="tab-content active">
      <div class="card">
        <div class="card-header">
          <div class="card-title">Select Data Source</div>
          <div class="card-description">Choose how you want to import data</div>
        </div>
        
        <div class="source-type-grid">
          <div class="source-type-card" onclick="selectSource('csv')">
            <div class="source-icon">üìÑ</div>
            <div class="source-name">CSV File</div>
            <div class="source-desc">Comma-separated</div>
          </div>
          
          <div class="source-type-card" onclick="selectSource('json')">
            <div class="source-icon">{ }</div>
            <div class="source-name">JSON</div>
            <div class="source-desc">Structured data</div>
          </div>
          
          <div class="source-type-card" onclick="selectSource('api')">
            <div class="source-icon">üîå</div>
            <div class="source-name">API</div>
            <div class="source-desc">REST endpoint</div>
          </div>
          
          <div class="source-type-card" onclick="selectSource('html')">
            <div class="source-icon">üåê</div>
            <div class="source-name">HTML Table</div>
            <div class="source-desc">Web scraping</div>
          </div>
        </div>
      </div>
      
      <!-- CSV Import Form -->
      <div id="csv-form" class="import-form card">
        <div class="card-header">
          <div class="card-title">CSV Import Settings</div>
        </div>
        
        <div class="form-group">
          <label>Paste CSV Data</label>
          <textarea id="csvData" class="form-control" rows="6" placeholder="Name,Age,City
John,30,New York
Jane,25,Los Angeles"></textarea>
        </div>
        
        <div class="advanced-options">
          <div class="option-group">
            <span class="option-label">Has Headers</span>
            <input type="checkbox" id="csvHeaders" checked>
          </div>
          <div class="option-group">
            <span class="option-label">Delimiter</span>
            <select id="csvDelimiter" style="width: 80px;">
              <option value=",">Comma (,)</option>
              <option value=";">Semicolon (;)</option>
              <option value="\t">Tab</option>
              <option value="|">Pipe (|)</option>
            </select>
          </div>
        </div>
        
        <div class="action-buttons">
          <button class="btn-preview" onclick="previewCSV()">
            Preview Data
          </button>
          <button class="btn-import" onclick="importCSV()">
            Import to Sheet
          </button>
        </div>
      </div>
      
      <!-- JSON Import Form -->
      <div id="json-form" class="import-form card">
        <div class="card-header">
          <div class="card-title">JSON Import Settings</div>
        </div>
        
        <div class="form-group">
          <label>JSON Data</label>
          <textarea id="jsonData" class="form-control" rows="6" placeholder='[
  {"name": "John", "age": 30},
  {"name": "Jane", "age": 25}
]'></textarea>
        </div>
        
        <div class="form-group">
          <label>Path to Array (optional)</label>
          <input type="text" id="jsonPath" class="form-control" placeholder="data.items">
          <small>Leave empty for root level array</small>
        </div>
        
        <div class="advanced-options">
          <div class="option-group">
            <span class="option-label">Flatten Nested Objects</span>
            <input type="checkbox" id="jsonFlatten" checked>
          </div>
        </div>
        
        <div class="action-buttons">
          <button class="btn-preview" onclick="previewJSON()">
            Preview Data
          </button>
          <button class="btn-import" onclick="importJSON()">
            Import to Sheet
          </button>
        </div>
      </div>
      
      <!-- API Import Form -->
      <div id="api-form" class="import-form card">
        <div class="card-header">
          <div class="card-title">API Import Settings</div>
        </div>
        
        <div class="form-group">
          <label>API Endpoint URL</label>
          <input type="text" id="apiUrl" class="form-control" placeholder="https://api.example.com/data">
        </div>
        
        <div class="form-group">
          <label>Method</label>
          <select id="apiMethod" class="form-control">
            <option value="GET">GET</option>
            <option value="POST">POST</option>
          </select>
        </div>
        
        <div class="form-group" id="apiBodyGroup" style="display: none;">
          <label>Request Body (JSON)</label>
          <textarea id="apiBody" class="form-control" rows="4" placeholder='{"key": "value"}'></textarea>
        </div>
        
        <div class="form-group">
          <label>Headers (optional)</label>
          <textarea id="apiHeaders" class="form-control" rows="3" placeholder="Authorization: Bearer YOUR_TOKEN
Content-Type: application/json"></textarea>
        </div>
        
        <div class="advanced-options">
          <div class="option-group">
            <span class="option-label">Data Path</span>
            <input type="text" id="apiPath" placeholder="data.results" style="width: 150px;">
          </div>
          <div class="option-group">
            <span class="option-label">Schedule Import</span>
            <select id="apiSchedule" style="width: 120px;">
              <option value="once">Once</option>
              <option value="hourly">Hourly</option>
              <option value="daily">Daily</option>
              <option value="weekly">Weekly</option>
            </select>
          </div>
        </div>
        
        <div class="action-buttons">
          <button class="btn-preview" onclick="previewAPI()">
            Test & Preview
          </button>
          <button class="btn-import" onclick="importAPI()">
            Import to Sheet
          </button>
        </div>
      </div>
      
      <!-- HTML Import Form -->
      <div id="html-form" class="import-form card">
        <div class="card-header">
          <div class="card-title">HTML Table Import</div>
        </div>
        
        <div class="form-group">
          <label>Web Page URL</label>
          <input type="text" id="htmlUrl" class="form-control" placeholder="https://example.com/data.html">
        </div>
        
        <div class="form-group">
          <label>Table Selector</label>
          <input type="text" id="htmlSelector" class="form-control" placeholder="table#data or .data-table">
          <small>CSS selector for the table element</small>
        </div>
        
        <div class="action-buttons">
          <button class="btn-preview" onclick="previewHTML()">
            Extract & Preview
          </button>
          <button class="btn-import" onclick="importHTML()">
            Import Table
          </button>
        </div>
      </div>
    </div>
    
    <!-- Export Tab -->
    <div id="export-tab" class="tab-content">
      <div class="card">
        <div class="card-header">
          <div class="card-title">Export Data</div>
          <div class="card-description">Export selected range in various formats</div>
        </div>
        
        <div class="form-group">
          <label>Export Format</label>
          <div class="source-type-grid">
            <div class="source-type-card" onclick="selectExportFormat('csv')">
              <div class="source-icon">üìÑ</div>
              <div class="source-name">CSV</div>
            </div>
            
            <div class="source-type-card" onclick="selectExportFormat('json')">
              <div class="source-icon">{ }</div>
              <div class="source-name">JSON</div>
            </div>
            
            <div class="source-type-card" onclick="selectExportFormat('xml')">
              <div class="source-icon">&lt;/&gt;</div>
              <div class="source-name">XML</div>
            </div>
            
            <div class="source-type-card" onclick="selectExportFormat('sql')">
              <div class="source-icon">üóÉÔ∏è</div>
              <div class="source-name">SQL</div>
            </div>
          </div>
        </div>
        
        <div id="exportOptions" class="advanced-options" style="display: none;">
          <div id="csvExportOptions" style="display: none;">
            <div class="option-group">
              <span class="option-label">Include Headers</span>
              <input type="checkbox" id="csvExportHeaders" checked>
            </div>
            <div class="option-group">
              <span class="option-label">Delimiter</span>
              <select id="csvExportDelimiter">
                <option value=",">Comma</option>
                <option value=";">Semicolon</option>
                <option value="\t">Tab</option>
              </select>
            </div>
          </div>
          
          <div id="jsonExportOptions" style="display: none;">
            <div class="option-group">
              <span class="option-label">Pretty Print</span>
              <input type="checkbox" id="jsonPretty" checked>
            </div>
            <div class="option-group">
              <span class="option-label">Include Types</span>
              <input type="checkbox" id="jsonTypes">
            </div>
          </div>
          
          <div id="sqlExportOptions" style="display: none;">
            <div class="option-group">
              <span class="option-label">Table Name</span>
              <input type="text" id="sqlTable" placeholder="my_table" style="width: 150px;">
            </div>
            <div class="option-group">
              <span class="option-label">Include CREATE</span>
              <input type="checkbox" id="sqlCreate" checked>
            </div>
          </div>
        </div>
        
        <div class="action-buttons">
          <button class="btn-preview" onclick="previewExport()" id="previewExportBtn" disabled>
            Preview Export
          </button>
          <button class="btn-export" onclick="exportData()" id="exportBtn" disabled>
            Download File
          </button>
        </div>
        
        <div id="exportResult" style="margin-top: 16px; display: none;">
          <div class="alert alert-success">
            <strong>Export Ready!</strong>
            <div style="margin-top: 8px;">
              <button class="btn btn-sm btn-primary" onclick="copyExport()">Copy to Clipboard</button>
              <button class="btn btn-sm btn-secondary" onclick="downloadExport()">Download File</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- History Tab -->
    <div id="history-tab" class="tab-content">
      <div class="card">
        <div class="card-header">
          <div class="card-title">Pipeline History</div>
          <div class="card-description">Recent import and export operations</div>
        </div>
        
        <div id="historyList">
          <!-- History items will be populated here -->
        </div>
        
        <button class="btn btn-secondary btn-block" onclick="clearHistory()" style="margin-top: 12px;">
          Clear History
        </button>
      </div>
    </div>
    
    <!-- Preview Modal -->
    <div class="preview-modal" id="dataPreviewModal">
      <div class="preview-content">
        <div class="preview-header">
          <div class="preview-title" id="previewTitle">Data Preview</div>
          <button class="preview-close" onclick="closePreview()">√ó</button>
        </div>
        
        <div class="preview-stats" id="previewStats">
          <!-- Stats will be shown here -->
        </div>
        
        <div class="preview-data" id="previewData">
          <!-- Preview data will be shown here -->
        </div>
        
        <div style="margin-top: 16px; display: flex; gap: 8px;">
          <button class="btn btn-secondary" onclick="closePreview()" style="flex: 1;">
            Back to Settings
          </button>
          <button class="btn btn-primary" onclick="confirmImport()" id="confirmImportBtn" style="flex: 1;">
            Confirm & Import
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    let selectedSource = null;
    let selectedExportFormat = null;
    let previewDataCache = null;
    let exportDataCache = null;
    
    // Initialize
    function initialize() {
      loadHistory();
      
      // Setup event listeners
      document.getElementById('apiMethod').addEventListener('change', function() {
        document.getElementById('apiBodyGroup').style.display = 
          this.value === 'POST' ? 'block' : 'none';
      });
    }
    
    // Navigation
    function backToMain() {
      google.script.run.showCellPilotSidebar();
    }
    
    // Tab switching
    function switchTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      
      // Update tab content
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(tabName + '-tab').classList.add('active');
      
      // Load data for the tab
      if (tabName === 'history') {
        loadHistory();
      }
    }
    
    // Select import source
    function selectSource(source) {
      selectedSource = source;
      
      // Update UI
      document.querySelectorAll('.source-type-card').forEach(card => {
        card.classList.remove('selected');
      });
      event.target.closest('.source-type-card').classList.add('selected');
      
      // Show corresponding form
      document.querySelectorAll('.import-form').forEach(form => {
        form.classList.remove('active');
      });
      document.getElementById(source + '-form').classList.add('active');
    }
    
    // Select export format
    function selectExportFormat(format) {
      selectedExportFormat = format;
      
      // Update UI
      document.querySelectorAll('#export-tab .source-type-card').forEach(card => {
        card.classList.remove('selected');
      });
      event.target.closest('.source-type-card').classList.add('selected');
      
      // Show format-specific options
      document.getElementById('exportOptions').style.display = 'block';
      document.querySelectorAll('[id$="ExportOptions"]').forEach(opt => {
        opt.style.display = 'none';
      });
      
      const formatOptions = document.getElementById(format + 'ExportOptions');
      if (formatOptions) {
        formatOptions.style.display = 'block';
      }
      
      // Enable export buttons
      document.getElementById('previewExportBtn').disabled = false;
      document.getElementById('exportBtn').disabled = false;
    }
    
    // Preview CSV
    function previewCSV() {
      const csvData = document.getElementById('csvData').value;
      if (!csvData) {
        showError('Please paste CSV data first');
        return;
      }
      
      const config = {
        type: 'csv',
        data: csvData,
        hasHeaders: document.getElementById('csvHeaders').checked,
        delimiter: document.getElementById('csvDelimiter').value
      };
      
      showPreview('CSV Import Preview', config);
    }
    
    // Preview JSON
    function previewJSON() {
      const jsonData = document.getElementById('jsonData').value;
      if (!jsonData) {
        showError('Please paste JSON data first');
        return;
      }
      
      try {
        JSON.parse(jsonData);
      } catch (e) {
        showError('Invalid JSON format: ' + e.message);
        return;
      }
      
      const config = {
        type: 'json',
        data: jsonData,
        path: document.getElementById('jsonPath').value,
        flatten: document.getElementById('jsonFlatten').checked
      };
      
      showPreview('JSON Import Preview', config);
    }
    
    // Preview API
    function previewAPI() {
      const url = document.getElementById('apiUrl').value;
      if (!url) {
        showError('Please enter API URL');
        return;
      }
      
      const config = {
        type: 'api',
        url: url,
        method: document.getElementById('apiMethod').value,
        body: document.getElementById('apiBody').value,
        headers: document.getElementById('apiHeaders').value,
        path: document.getElementById('apiPath').value
      };
      
      showPreview('API Test & Preview', config);
    }
    
    // Preview HTML
    function previewHTML() {
      const url = document.getElementById('htmlUrl').value;
      const selector = document.getElementById('htmlSelector').value;
      
      if (!url) {
        showError('Please enter webpage URL');
        return;
      }
      
      const config = {
        type: 'html',
        url: url,
        selector: selector || 'table'
      };
      
      showPreview('HTML Table Preview', config);
    }
    
    // Show preview modal
    function showPreview(title, config) {
      previewDataCache = config;
      document.getElementById('previewTitle').textContent = title;
      document.getElementById('dataPreviewModal').classList.add('show');
      
      // Show loading
      document.getElementById('previewData').innerHTML = '<div style="text-align: center;">Loading preview...</div>';
      document.getElementById('previewStats').innerHTML = '';
      
      // Get preview from server
      google.script.run
        .withSuccessHandler(displayPreview)
        .withFailureHandler(function(error) {
          document.getElementById('previewData').innerHTML = 
            '<div style="color: var(--error-500);">Preview failed: ' + error.message + '</div>';
        })
        .generateImportPreview(config);
    }
    
    // Display preview data
    function displayPreview(result) {
      if (!result.success) {
        document.getElementById('previewData').innerHTML = 
          '<div style="color: var(--error-500);">Error: ' + result.error + '</div>';
        return;
      }
      
      // Show stats
      let statsHtml = '';
      statsHtml += '<div class="stat-row"><span class="stat-label">Rows:</span><span class="stat-value">' + 
                   result.rowCount + '</span></div>';
      statsHtml += '<div class="stat-row"><span class="stat-label">Columns:</span><span class="stat-value">' + 
                   result.columnCount + '</span></div>';
      if (result.dataTypes) {
        statsHtml += '<div class="stat-row"><span class="stat-label">Types:</span><span class="stat-value">' + 
                     result.dataTypes.join(', ') + '</span></div>';
      }
      document.getElementById('previewStats').innerHTML = statsHtml;
      
      // Show data preview
      if (result.preview) {
        document.getElementById('previewData').textContent = result.preview;
      }
    }
    
    // Close preview
    function closePreview() {
      document.getElementById('dataPreviewModal').classList.remove('show');
    }
    
    // Confirm import after preview
    function confirmImport() {
      if (!previewDataCache) return;
      
      closePreview();
      
      // Call the appropriate import function
      switch(previewDataCache.type) {
        case 'csv': importCSV(); break;
        case 'json': importJSON(); break;
        case 'api': importAPI(); break;
        case 'html': importHTML(); break;
      }
    }
    
    // Import CSV
    function importCSV() {
      const csvData = document.getElementById('csvData').value;
      if (!csvData) {
        showError('Please paste CSV data');
        return;
      }
      
      if (!confirm('This will import the CSV data into your spreadsheet. Continue?')) {
        return;
      }
      
      showLoading('Importing CSV data...');
      
      const config = {
        type: 'csv',
        data: csvData,
        hasHeaders: document.getElementById('csvHeaders').checked,
        delimiter: document.getElementById('csvDelimiter').value
      };
      
      google.script.run
        .withSuccessHandler(handleImportSuccess)
        .withFailureHandler(handleImportError)
        .importPipelineData(config);
    }
    
    // Import JSON
    function importJSON() {
      const jsonData = document.getElementById('jsonData').value;
      if (!jsonData) {
        showError('Please paste JSON data');
        return;
      }
      
      if (!confirm('This will import the JSON data into your spreadsheet. Continue?')) {
        return;
      }
      
      showLoading('Importing JSON data...');
      
      const config = {
        type: 'json',
        data: jsonData,
        path: document.getElementById('jsonPath').value,
        flatten: document.getElementById('jsonFlatten').checked
      };
      
      google.script.run
        .withSuccessHandler(handleImportSuccess)
        .withFailureHandler(handleImportError)
        .importPipelineData(config);
    }
    
    // Import API
    function importAPI() {
      const url = document.getElementById('apiUrl').value;
      if (!url) {
        showError('Please enter API URL');
        return;
      }
      
      if (!confirm('This will fetch and import data from the API. Continue?')) {
        return;
      }
      
      showLoading('Fetching API data...');
      
      const config = {
        type: 'api',
        url: url,
        method: document.getElementById('apiMethod').value,
        body: document.getElementById('apiBody').value,
        headers: document.getElementById('apiHeaders').value,
        path: document.getElementById('apiPath').value,
        schedule: document.getElementById('apiSchedule').value
      };
      
      google.script.run
        .withSuccessHandler(handleImportSuccess)
        .withFailureHandler(handleImportError)
        .importPipelineData(config);
    }
    
    // Import HTML
    function importHTML() {
      const url = document.getElementById('htmlUrl').value;
      if (!url) {
        showError('Please enter webpage URL');
        return;
      }
      
      if (!confirm('This will extract and import the HTML table. Continue?')) {
        return;
      }
      
      showLoading('Extracting HTML table...');
      
      const config = {
        type: 'html',
        url: url,
        selector: document.getElementById('htmlSelector').value || 'table'
      };
      
      google.script.run
        .withSuccessHandler(handleImportSuccess)
        .withFailureHandler(handleImportError)
        .importPipelineData(config);
    }
    
    // Preview Export
    function previewExport() {
      if (!selectedExportFormat) {
        showError('Please select an export format');
        return;
      }
      
      showLoading('Generating export preview...');
      
      const config = getExportConfig();
      
      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result.success) {
            exportDataCache = result.data;
            showExportPreview(result);
          } else {
            showError('Export preview failed: ' + result.error);
          }
        })
        .withFailureHandler(handleExportError)
        .generateExportPreview(config);
    }
    
    // Show export preview
    function showExportPreview(result) {
      document.getElementById('previewTitle').textContent = 'Export Preview';
      document.getElementById('dataPreviewModal').classList.add('show');
      
      // Update button for export
      document.getElementById('confirmImportBtn').textContent = 'Download Export';
      document.getElementById('confirmImportBtn').onclick = function() {
        closePreview();
        downloadExport();
      };
      
      // Show preview
      document.getElementById('previewData').textContent = result.preview;
      
      // Show stats
      let statsHtml = '<div class="stat-row"><span class="stat-label">Format:</span>' +
                     '<span class="stat-value">' + selectedExportFormat.toUpperCase() + '</span></div>';
      statsHtml += '<div class="stat-row"><span class="stat-label">Size:</span>' +
                  '<span class="stat-value">' + formatBytes(result.size) + '</span></div>';
      document.getElementById('previewStats').innerHTML = statsHtml;
    }
    
    // Export data
    function exportData() {
      if (!selectedExportFormat) {
        showError('Please select an export format');
        return;
      }
      
      showLoading('Exporting data...');
      
      const config = getExportConfig();
      
      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result.success) {
            exportDataCache = result.data;
            document.getElementById('exportResult').style.display = 'block';
            addToHistory('export', selectedExportFormat);
          } else {
            showError('Export failed: ' + result.error);
          }
        })
        .withFailureHandler(handleExportError)
        .exportPipelineData(config);
    }
    
    // Get export configuration
    function getExportConfig() {
      const config = {
        format: selectedExportFormat
      };
      
      if (selectedExportFormat === 'csv') {
        config.includeHeaders = document.getElementById('csvExportHeaders').checked;
        config.delimiter = document.getElementById('csvExportDelimiter').value;
      } else if (selectedExportFormat === 'json') {
        config.prettyPrint = document.getElementById('jsonPretty').checked;
        config.includeTypes = document.getElementById('jsonTypes').checked;
      } else if (selectedExportFormat === 'sql') {
        config.tableName = document.getElementById('sqlTable').value || 'data';
        config.includeCreate = document.getElementById('sqlCreate').checked;
      }
      
      return config;
    }
    
    // Copy export to clipboard
    function copyExport() {
      if (!exportDataCache) return;
      
      navigator.clipboard.writeText(exportDataCache).then(function() {
        showSuccess('Copied to clipboard!');
      });
    }
    
    // Download export
    function downloadExport() {
      if (!exportDataCache) return;
      
      const blob = new Blob([exportDataCache], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'export.' + (selectedExportFormat || 'txt');
      a.click();
      URL.revokeObjectURL(url);
      
      showSuccess('Download started!');
    }
    
    // Handle import success
    function handleImportSuccess(result) {
      hideLoading();
      if (result.success) {
        showSuccess('Data imported successfully! ' + result.rowCount + ' rows added.');
        addToHistory('import', selectedSource);
        
        // Clear form
        if (selectedSource === 'csv') {
          document.getElementById('csvData').value = '';
        } else if (selectedSource === 'json') {
          document.getElementById('jsonData').value = '';
        }
      } else {
        showError('Import failed: ' + result.error);
      }
    }
    
    // Handle import error
    function handleImportError(error) {
      hideLoading();
      showError('Import error: ' + error.message);
    }
    
    // Handle export error
    function handleExportError(error) {
      hideLoading();
      showError('Export error: ' + error.message);
    }
    
    // Load history
    function loadHistory() {
      google.script.run
        .withSuccessHandler(displayHistory)
        .withFailureHandler(function(error) {
          console.error('Failed to load history:', error);
        })
        .getPipelineHistory();
    }
    
    // Display history
    function displayHistory(history) {
      if (!history || history.length === 0) {
        document.getElementById('historyList').innerHTML = 
          '<div style="text-align: center; padding: 20px; color: var(--gray-500);">No pipeline history</div>';
        return;
      }
      
      const html = history.map(item => {
        return `
          <div class="history-item">
            <div class="history-header">
              <span class="history-type ${item.type}">${item.type}</span>
              <span class="history-time">${formatTime(item.timestamp)}</span>
            </div>
            <div class="history-details">
              ${item.details}
            </div>
          </div>
        `;
      }).join('');
      
      document.getElementById('historyList').innerHTML = html;
    }
    
    // Add to history
    function addToHistory(type, source) {
      const item = {
        type: type,
        source: source,
        timestamp: new Date().toISOString(),
        details: type === 'import' ? 
          `Imported from ${source.toUpperCase()}` : 
          `Exported as ${source.toUpperCase()}`
      };
      
      google.script.run.addToPipelineHistory(item);
      
      // Refresh history if visible
      if (document.getElementById('history-tab').classList.contains('active')) {
        loadHistory();
      }
    }
    
    // Clear history
    function clearHistory() {
      if (!confirm('Clear all pipeline history?')) return;
      
      google.script.run
        .withSuccessHandler(function() {
          showSuccess('History cleared');
          loadHistory();
        })
        .clearPipelineHistory();
    }
    
    // Utility functions
    function showLoading(message) {
      // Show loading overlay
    }
    
    function hideLoading() {
      // Hide loading overlay
    }
    
    function showSuccess(message) {
      showNotification(message, 'success');
    }
    
    function showError(message) {
      showNotification(message, 'error');
    }
    
    function showNotification(message, type) {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 6px;
        z-index: 2000;
        animation: slideIn 0.3s ease;
      `;
      
      if (type === 'success') {
        notification.style.background = 'var(--success-500)';
        notification.style.color = 'white';
      } else {
        notification.style.background = 'var(--error-500)';
        notification.style.color = 'white';
      }
      
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => notification.remove(), 3000);
    }
    
    function formatTime(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const diff = now - date;
      
      if (diff < 60000) return 'Just now';
      if (diff < 3600000) return Math.floor(diff / 60000) + ' min ago';
      if (diff < 86400000) return Math.floor(diff / 3600000) + ' hrs ago';
      return date.toLocaleDateString();
    }
    
    function formatBytes(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / 1048576).toFixed(1) + ' MB';
    }
    
    // Initialize on load
    document.addEventListener('DOMContentLoaded', initialize);
  </script>
</body>
</html>