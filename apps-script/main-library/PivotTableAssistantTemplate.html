<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <?!= include('SharedStyles'); ?>
  <style>
    /* Main Layout */
    .pivot-container {
      padding: 0;
    }
    
    /* Step Indicator */
    .step-indicator {
      display: flex;
      justify-content: space-between;
      margin: 16px;
      position: relative;
    }
    
    .step-indicator::before {
      content: '';
      position: absolute;
      top: 20px;
      left: 10%;
      right: 10%;
      height: 2px;
      background: var(--gray-200);
      z-index: 0;
    }
    
    .step {
      flex: 1;
      text-align: center;
      position: relative;
      z-index: 1;
    }
    
    .step-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: white;
      border: 2px solid var(--gray-300);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 8px;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .step.active .step-circle {
      background: var(--primary-500);
      border-color: var(--primary-500);
      color: white;
      transform: scale(1.1);
    }
    
    .step.completed .step-circle {
      background: var(--success-500);
      border-color: var(--success-500);
      color: white;
    }
    
    .step-label {
      font-size: 11px;
      color: var(--gray-600);
      font-weight: 500;
    }
    
    .step.active .step-label {
      color: var(--primary-600);
      font-weight: 600;
    }
    
    /* Analysis Card */
    .analysis-card {
      background: linear-gradient(135deg, var(--primary-50), var(--primary-100));
      border: 1px solid var(--primary-200);
      border-radius: 12px;
      padding: 16px;
      margin: 16px;
    }
    
    .data-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-top: 12px;
    }
    
    .stat-item {
      background: white;
      padding: 12px;
      border-radius: 8px;
      text-align: center;
    }
    
    .stat-value {
      font-size: 20px;
      font-weight: 700;
      color: var(--primary-600);
    }
    
    .stat-label {
      font-size: 10px;
      color: var(--gray-600);
      text-transform: uppercase;
      margin-top: 4px;
    }
    
    /* Column Pills */
    .columns-preview {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 12px;
      max-height: 100px;
      overflow-y: auto;
    }
    
    .column-pill {
      display: inline-flex;
      align-items: center;
      padding: 6px 10px;
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 16px;
      font-size: 11px;
      gap: 6px;
    }
    
    .column-type-icon {
      width: 16px;
      height: 16px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 700;
    }
    
    .type-number { background: var(--primary-100); color: var(--primary-700); }
    .type-text { background: var(--gray-100); color: var(--gray-700); }
    .type-date { background: var(--warning-100); color: var(--warning-700); }
    .type-currency { background: var(--success-100); color: var(--success-700); }
    
    /* Suggestion Cards */
    .suggestions-grid {
      display: grid;
      gap: 12px;
      margin: 16px;
    }
    
    .suggestion-card {
      background: white;
      border: 2px solid var(--gray-200);
      border-radius: 12px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }
    
    .suggestion-card:hover {
      border-color: var(--primary-300);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    
    .suggestion-card.selected {
      border-color: var(--primary-500);
      background: var(--primary-50);
    }
    
    .suggestion-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 8px;
    }
    
    .suggestion-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--gray-800);
    }
    
    .confidence-badge {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
    }
    
    .confidence-high {
      background: var(--success-100);
      color: var(--success-700);
    }
    
    .confidence-medium {
      background: var(--warning-100);
      color: var(--warning-700);
    }
    
    .confidence-low {
      background: var(--gray-100);
      color: var(--gray-600);
    }
    
    .suggestion-description {
      font-size: 12px;
      color: var(--gray-600);
      margin-bottom: 12px;
    }
    
    .suggestion-preview {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .field-tag {
      display: inline-flex;
      align-items: center;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      gap: 4px;
    }
    
    .field-tag.row {
      background: var(--info-100);
      color: var(--info-700);
    }
    
    .field-tag.column {
      background: var(--warning-100);
      color: var(--warning-700);
    }
    
    .field-tag.value {
      background: var(--success-100);
      color: var(--success-700);
    }
    
    /* Action Buttons */
    .action-buttons {
      display: flex;
      gap: 8px;
      margin: 16px;
      padding: 16px;
      background: var(--gray-50);
      border-radius: 12px;
      border: 1px dashed var(--gray-300);
    }
    
    .btn-preview {
      flex: 1;
      padding: 12px;
      background: white;
      border: 2px solid var(--primary-500);
      color: var(--primary-600);
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .btn-preview:hover {
      background: var(--primary-50);
      transform: translateY(-1px);
    }
    
    .btn-apply {
      flex: 1;
      padding: 12px;
      background: var(--primary-500);
      border: 2px solid var(--primary-500);
      color: white;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .btn-apply:hover {
      background: var(--primary-600);
      border-color: var(--primary-600);
      transform: translateY(-1px);
    }
    
    .btn-apply:disabled {
      background: var(--gray-300);
      border-color: var(--gray-300);
      cursor: not-allowed;
      transform: none;
    }
    
    /* Preview Modal */
    .preview-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .preview-modal.show {
      display: flex;
    }
    
    .preview-content {
      background: white;
      border-radius: 12px;
      padding: 24px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .preview-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--gray-800);
    }
    
    .close-preview {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--gray-100);
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .preview-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      margin-top: 16px;
    }
    
    .preview-table th {
      background: var(--gray-100);
      padding: 8px;
      text-align: left;
      font-weight: 600;
      border: 1px solid var(--gray-200);
    }
    
    .preview-table td {
      padding: 8px;
      border: 1px solid var(--gray-200);
    }
    
    /* Manual Builder */
    .builder-section {
      margin: 16px;
      padding: 16px;
      background: var(--gray-50);
      border-radius: 12px;
    }
    
    .builder-field {
      margin-bottom: 16px;
    }
    
    .builder-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--gray-700);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .field-selector {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 12px;
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      min-height: 50px;
    }
    
    .field-chip {
      display: inline-flex;
      align-items: center;
      padding: 6px 10px;
      background: var(--primary-100);
      border: 1px solid var(--primary-300);
      border-radius: 16px;
      font-size: 11px;
      gap: 6px;
      cursor: pointer;
    }
    
    .field-chip.selected {
      background: var(--primary-500);
      color: white;
      border-color: var(--primary-600);
    }
    
    .field-remove {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: rgba(255,255,255,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    
    /* Info Tooltip */
    .info-tooltip {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--info-100);
      color: var(--info-600);
      font-size: 10px;
      font-weight: 700;
      cursor: help;
    }
    
    /* Loading State */
    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 12px;
    }
    
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--gray-200);
      border-top-color: var(--primary-500);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 32px;
      color: var(--gray-600);
    }
    
    .empty-icon {
      width: 48px;
      height: 48px;
      margin: 0 auto 16px;
      opacity: 0.3;
    }
  </style>
</head>
<body>
  <div class="nav-header">
    <button class="nav-back" onclick="backToMain()">‚Üê</button>
    <div class="nav-title">
      <h2>Pivot Table Assistant</h2>
      <p>Smart pivot table creation with AI guidance</p>
    </div>
  </div>
  
  <div class="pivot-container">
    <!-- Step Indicator -->
    <div class="step-indicator">
      <div class="step active" id="step1">
        <div class="step-circle">1</div>
        <div class="step-label">Analyze</div>
      </div>
      <div class="step" id="step2">
        <div class="step-circle">2</div>
        <div class="step-label">Configure</div>
      </div>
      <div class="step" id="step3">
        <div class="step-circle">3</div>
        <div class="step-label">Preview</div>
      </div>
      <div class="step" id="step4">
        <div class="step-circle">4</div>
        <div class="step-label">Apply</div>
      </div>
    </div>
    
    <!-- Step 1: Analysis -->
    <div id="analysisStep" class="step-content">
      <div class="card" style="margin: 16px;">
        <div class="card-header">
          <div class="card-title">Data Analysis</div>
          <div class="card-description">Let me understand your data structure</div>
        </div>
        
        <button class="btn btn-primary btn-block" onclick="startAnalysis()">
          <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path d="M11 6.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm-3 0a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm-5 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm3 0a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1z"/>
            <path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5zM1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4H1z"/>
          </svg>
          Analyze Current Selection
        </button>
        
        <div id="analysisResult" style="display: none; margin-top: 16px;">
          <div class="analysis-card">
            <h4 style="margin: 0 0 12px 0; color: var(--primary-700);">Data Overview</h4>
            <div class="data-stats">
              <div class="stat-item">
                <div class="stat-value" id="rowCount">-</div>
                <div class="stat-label">Rows</div>
              </div>
              <div class="stat-item">
                <div class="stat-value" id="colCount">-</div>
                <div class="stat-label">Columns</div>
              </div>
              <div class="stat-item">
                <div class="stat-value" id="dataType">-</div>
                <div class="stat-label">Type</div>
              </div>
            </div>
            
            <div style="margin-top: 16px;">
              <div style="font-size: 11px; font-weight: 600; color: var(--primary-700); margin-bottom: 8px;">
                DETECTED COLUMNS
              </div>
              <div class="columns-preview" id="columnsPreview"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Step 2: Configuration -->
    <div id="configStep" class="step-content" style="display: none;">
      <!-- AI Suggestions -->
      <div class="card" style="margin: 16px;">
        <div class="card-header">
          <div class="card-title">AI Suggestions</div>
          <div class="card-description">Smart pivot configurations based on your data</div>
        </div>
        
        <div class="suggestions-grid" id="suggestionsGrid">
          <!-- Suggestions will be populated here -->
        </div>
      </div>
      
      <!-- Manual Builder -->
      <div class="card" style="margin: 16px;">
        <div class="card-header">
          <div class="card-title">Custom Configuration</div>
          <div class="card-description">Build your own pivot table layout</div>
        </div>
        
        <div class="builder-section">
          <div class="builder-field">
            <div class="builder-label">
              Row Fields
              <span class="info-tooltip" title="Fields to group data by rows">?</span>
            </div>
            <div class="field-selector" id="rowFieldSelector">
              <!-- Available fields will be shown here -->
            </div>
          </div>
          
          <div class="builder-field">
            <div class="builder-label">
              Column Fields
              <span class="info-tooltip" title="Fields to create columns">?</span>
            </div>
            <div class="field-selector" id="columnFieldSelector">
              <!-- Available fields will be shown here -->
            </div>
          </div>
          
          <div class="builder-field">
            <div class="builder-label">
              Value Fields
              <span class="info-tooltip" title="Numeric fields to aggregate">?</span>
            </div>
            <div class="field-selector" id="valueFieldSelector">
              <!-- Available fields will be shown here -->
            </div>
          </div>
          
          <div class="form-group">
            <label style="font-size: 12px; font-weight: 600; color: var(--gray-700);">
              Aggregation Function
            </label>
            <select id="aggregateFunction" class="form-control">
              <option value="SUM">Sum</option>
              <option value="AVERAGE">Average</option>
              <option value="COUNT">Count</option>
              <option value="MAX">Maximum</option>
              <option value="MIN">Minimum</option>
            </select>
          </div>
        </div>
      </div>
      
      <!-- Action Buttons -->
      <div class="action-buttons">
        <button class="btn-preview" onclick="previewPivot()">
          <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path d="M10.5 8a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0z"/>
            <path d="M0 8s3-5.5 8-5.5S16 8 16 8s-3 5.5-8 5.5S0 8 0 8zm8 3.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z"/>
          </svg>
          Preview Result
        </button>
        <button class="btn-apply" onclick="applyPivot()" id="applyBtn">
          <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path d="M12.736 3.97a.733.733 0 0 1 1.047 0c.286.289.29.756.01 1.05L7.88 12.01a.733.733 0 0 1-1.065.02L3.217 8.384a.757.757 0 0 1 0-1.06.733.733 0 0 1 1.047 0l3.052 3.093 5.4-6.425a.247.247 0 0 1 .02-.022Z"/>
          </svg>
          Create Pivot Table
        </button>
      </div>
    </div>
    
    <!-- Preview Modal -->
    <div class="preview-modal" id="previewModal">
      <div class="preview-content">
        <div class="preview-header">
          <div class="preview-title">Pivot Table Preview</div>
          <button class="close-preview" onclick="closePreview()">√ó</button>
        </div>
        
        <div id="previewBody">
          <!-- Preview content will be inserted here -->
        </div>
        
        <div style="margin-top: 16px; display: flex; gap: 8px;">
          <button class="btn btn-secondary" onclick="closePreview()" style="flex: 1;">
            Back to Configuration
          </button>
          <button class="btn btn-primary" onclick="applyFromPreview()" style="flex: 1;">
            Apply This Configuration
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    let currentAnalysis = null;
    let selectedConfig = null;
    let currentStep = 1;
    let availableFields = [];
    
    // Initialize
    function initialize() {
      // Check for existing selection
      google.script.run
        .withSuccessHandler(function(context) {
          if (context && context.hasSelection) {
            // Auto-start analysis if data is selected
            startAnalysis();
          }
        })
        .getCurrentUserContext();
    }
    
    // Navigation
    function backToMain() {
      google.script.run.showCellPilotSidebar();
    }
    
    // Step Management
    function updateStep(stepNum) {
      currentStep = stepNum;
      
      // Update step indicators
      for (let i = 1; i <= 4; i++) {
        const step = document.getElementById('step' + i);
        step.classList.remove('active', 'completed');
        if (i < stepNum) {
          step.classList.add('completed');
        } else if (i === stepNum) {
          step.classList.add('active');
        }
      }
      
      // Show/hide step content
      document.getElementById('analysisStep').style.display = stepNum === 1 ? 'block' : 'none';
      document.getElementById('configStep').style.display = stepNum === 2 ? 'block' : 'none';
    }
    
    // Start Analysis
    function startAnalysis() {
      const btn = event.target.closest('button');
      btn.innerHTML = '<span class="loading-spinner" style="width: 16px; height: 16px; display: inline-block;"></span> Analyzing...';
      btn.disabled = true;
      
      google.script.run
        .withSuccessHandler(handleAnalysisResult)
        .withFailureHandler(function(error) {
          showError('Analysis failed: ' + error.message);
          btn.innerHTML = 'Analyze Current Selection';
          btn.disabled = false;
        })
        .analyzePivotData();
    }
    
    // Handle Analysis Result
    function handleAnalysisResult(result) {
      if (!result.success) {
        showError(result.error);
        return;
      }
      
      currentAnalysis = result.analysis;
      
      // Update analysis display
      document.getElementById('rowCount').textContent = currentAnalysis.rowCount.toLocaleString();
      document.getElementById('colCount').textContent = currentAnalysis.columnCount;
      document.getElementById('dataType').textContent = detectDataType(currentAnalysis);
      
      // Show columns
      const columnsHtml = currentAnalysis.columnAnalysis.map(col => {
        const typeIcon = getTypeIcon(col.dataType);
        return `
          <div class="column-pill">
            <span class="column-type-icon type-${col.dataType}">${typeIcon}</span>
            <span>${col.name}</span>
          </div>
        `;
      }).join('');
      document.getElementById('columnsPreview').innerHTML = columnsHtml;
      
      // Show result
      document.getElementById('analysisResult').style.display = 'block';
      
      // Store available fields
      availableFields = currentAnalysis.columnAnalysis;
      
      // Move to configuration step
      setTimeout(() => {
        updateStep(2);
        displaySuggestions();
        setupManualBuilder();
      }, 1500);
    }
    
    // Display AI Suggestions
    function displaySuggestions() {
      if (!currentAnalysis || !currentAnalysis.suggestions) return;
      
      const html = currentAnalysis.suggestions.map((suggestion, index) => {
        const confidence = Math.round(suggestion.confidence * 100);
        const confidenceClass = confidence >= 85 ? 'confidence-high' : 
                               confidence >= 70 ? 'confidence-medium' : 'confidence-low';
        
        return `
          <div class="suggestion-card" onclick="selectSuggestion(${index})">
            <div class="suggestion-header">
              <div class="suggestion-title">${suggestion.name}</div>
              <div class="confidence-badge ${confidenceClass}">
                <svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                  <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
                </svg>
                ${confidence}%
              </div>
            </div>
            <div class="suggestion-description">${suggestion.description}</div>
            <div class="suggestion-preview">
              ${suggestion.configuration.rows.map(r => 
                `<span class="field-tag row">‚Üì ${r}</span>`
              ).join('')}
              ${suggestion.configuration.columns.map(c => 
                `<span class="field-tag column">‚Üí ${c}</span>`
              ).join('')}
              ${suggestion.configuration.values.map(v => 
                `<span class="field-tag value">Œ£ ${v.field}</span>`
              ).join('')}
            </div>
          </div>
        `;
      }).join('');
      
      document.getElementById('suggestionsGrid').innerHTML = html || 
        '<div class="empty-state">No AI suggestions available</div>';
    }
    
    // Select Suggestion
    function selectSuggestion(index) {
      selectedConfig = currentAnalysis.suggestions[index];
      
      // Update UI
      document.querySelectorAll('.suggestion-card').forEach((card, i) => {
        if (i === index) {
          card.classList.add('selected');
        } else {
          card.classList.remove('selected');
        }
      });
      
      // Update manual builder to reflect selection
      updateManualBuilder(selectedConfig.configuration);
      
      // Enable apply button
      document.getElementById('applyBtn').disabled = false;
    }
    
    // Setup Manual Builder
    function setupManualBuilder() {
      if (!availableFields) return;
      
      // Populate field selectors
      const rowFields = availableFields.filter(f => f.suitability.rowField > 0.5);
      const colFields = availableFields.filter(f => f.suitability.columnField > 0.5);
      const valFields = availableFields.filter(f => f.suitability.valueField > 0.5);
      
      document.getElementById('rowFieldSelector').innerHTML = 
        rowFields.map(f => 
          `<div class="field-chip" onclick="toggleField('row', '${f.name}')">${f.name}</div>`
        ).join('');
      
      document.getElementById('columnFieldSelector').innerHTML = 
        colFields.map(f => 
          `<div class="field-chip" onclick="toggleField('column', '${f.name}')">${f.name}</div>`
        ).join('');
      
      document.getElementById('valueFieldSelector').innerHTML = 
        valFields.map(f => 
          `<div class="field-chip" onclick="toggleField('value', '${f.name}')">${f.name}</div>`
        ).join('');
    }
    
    // Toggle Field Selection
    function toggleField(type, fieldName) {
      const chip = event.target;
      chip.classList.toggle('selected');
      
      // Update selected configuration
      updateManualConfig();
    }
    
    // Update Manual Configuration
    function updateManualConfig() {
      const rows = Array.from(document.querySelectorAll('#rowFieldSelector .field-chip.selected'))
        .map(el => el.textContent);
      const columns = Array.from(document.querySelectorAll('#columnFieldSelector .field-chip.selected'))
        .map(el => el.textContent);
      const values = Array.from(document.querySelectorAll('#valueFieldSelector .field-chip.selected'))
        .map(el => el.textContent);
      const func = document.getElementById('aggregateFunction').value;
      
      selectedConfig = {
        name: 'Custom Configuration',
        configuration: {
          rows: rows,
          columns: columns,
          values: values.map(v => ({ field: v, summarizeFunction: func }))
        }
      };
      
      // Enable apply button if configuration is valid
      document.getElementById('applyBtn').disabled = 
        rows.length === 0 && columns.length === 0;
    }
    
    // Update Manual Builder from Config
    function updateManualBuilder(config) {
      // Clear existing selections
      document.querySelectorAll('.field-chip').forEach(chip => {
        chip.classList.remove('selected');
      });
      
      // Select fields based on config
      config.rows.forEach(field => {
        const chip = Array.from(document.querySelectorAll('#rowFieldSelector .field-chip'))
          .find(el => el.textContent === field);
        if (chip) chip.classList.add('selected');
      });
      
      config.columns.forEach(field => {
        const chip = Array.from(document.querySelectorAll('#columnFieldSelector .field-chip'))
          .find(el => el.textContent === field);
        if (chip) chip.classList.add('selected');
      });
      
      config.values.forEach(value => {
        const chip = Array.from(document.querySelectorAll('#valueFieldSelector .field-chip'))
          .find(el => el.textContent === value.field);
        if (chip) chip.classList.add('selected');
      });
    }
    
    // Preview Pivot
    function previewPivot() {
      if (!selectedConfig) {
        updateManualConfig();
      }
      
      if (!selectedConfig || (selectedConfig.configuration.rows.length === 0 && 
          selectedConfig.configuration.columns.length === 0)) {
        showError('Please select at least one row or column field');
        return;
      }
      
      // Show loading in modal
      document.getElementById('previewBody').innerHTML = 
        '<div style="text-align: center; padding: 40px;"><div class="loading-spinner"></div></div>';
      document.getElementById('previewModal').classList.add('show');
      
      // Generate preview
      google.script.run
        .withSuccessHandler(showPreviewResult)
        .withFailureHandler(function(error) {
          showError('Preview failed: ' + error.message);
          closePreview();
        })
        .generatePivotPreview(selectedConfig);
    }
    
    // Show Preview Result
    function showPreviewResult(result) {
      if (!result.success) {
        showError('Preview generation failed');
        closePreview();
        return;
      }
      
      let html = '<div style="padding: 12px; background: var(--gray-50); border-radius: 8px; margin-bottom: 16px;">';
      html += '<h4 style="margin: 0 0 8px 0; font-size: 14px;">Configuration</h4>';
      html += '<div style="display: flex; flex-wrap: wrap; gap: 6px;">';
      
      selectedConfig.configuration.rows.forEach(r => {
        html += `<span class="field-tag row">Row: ${r}</span>`;
      });
      selectedConfig.configuration.columns.forEach(c => {
        html += `<span class="field-tag column">Col: ${c}</span>`;
      });
      selectedConfig.configuration.values.forEach(v => {
        html += `<span class="field-tag value">Val: ${v.field}</span>`;
      });
      
      html += '</div></div>';
      
      // Show sample data
      html += '<h4 style="margin: 16px 0 8px 0; font-size: 14px;">Sample Output (First 10 rows)</h4>';
      html += '<table class="preview-table">';
      
      // Headers
      html += '<tr>';
      result.preview.headers.forEach(h => {
        html += `<th>${h}</th>`;
      });
      html += '</tr>';
      
      // Data rows
      result.preview.rows.forEach(row => {
        html += '<tr>';
        row.forEach(cell => {
          html += `<td>${cell}</td>`;
        });
        html += '</tr>';
      });
      
      html += '</table>';
      
      document.getElementById('previewBody').innerHTML = html;
    }
    
    // Close Preview
    function closePreview() {
      document.getElementById('previewModal').classList.remove('show');
    }
    
    // Apply Pivot
    function applyPivot() {
      if (!selectedConfig) {
        updateManualConfig();
      }
      
      if (!selectedConfig) {
        showError('Please select or configure a pivot table');
        return;
      }
      
      // Confirm action
      if (!confirm('This will create a new pivot table in your spreadsheet. Continue?')) {
        return;
      }
      
      const btn = document.getElementById('applyBtn');
      btn.innerHTML = '<span class="loading-spinner" style="width: 16px; height: 16px; display: inline-block;"></span> Creating...';
      btn.disabled = true;
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showSuccess('Pivot table created successfully!');
            updateStep(4);
            
            // Track for ML
            google.script.run.trackUserAction('createPivot', {
              type: selectedConfig.name,
              fields: selectedConfig.configuration
            });
            
            setTimeout(() => backToMain(), 2000);
          } else {
            showError('Failed to create pivot table: ' + result.error);
          }
          btn.innerHTML = 'Create Pivot Table';
          btn.disabled = false;
        })
        .withFailureHandler(function(error) {
          showError('Error: ' + error.message);
          btn.innerHTML = 'Create Pivot Table';
          btn.disabled = false;
        })
        .createPivotFromSuggestion(selectedConfig);
    }
    
    // Apply from Preview
    function applyFromPreview() {
      closePreview();
      applyPivot();
    }
    
    // Helper Functions
    function detectDataType(analysis) {
      const types = [];
      if (analysis.patterns.numerical) types.push('Numeric');
      if (analysis.patterns.temporal) types.push('Time');
      if (analysis.patterns.categorical) types.push('Category');
      return types.length > 0 ? types[0] : 'Mixed';
    }
    
    function getTypeIcon(type) {
      const icons = {
        'number': '#',
        'text': 'T',
        'date': 'üìÖ',
        'currency': '$',
        'boolean': '‚úì',
        'category': '‚óâ'
      };
      return icons[type] || '?';
    }
    
    function showSuccess(message) {
      showNotification(message, 'success');
    }
    
    function showError(message) {
      showNotification(message, 'error');
    }
    
    function showNotification(message, type) {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 8px;
        z-index: 2000;
        animation: slideIn 0.3s ease;
      `;
      
      if (type === 'success') {
        notification.style.background = 'var(--success-500)';
        notification.style.color = 'white';
      } else {
        notification.style.background = 'var(--error-500)';
        notification.style.color = 'white';
      }
      
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => notification.remove(), 3000);
    }
    
    // Initialize on load
    document.addEventListener('DOMContentLoaded', initialize);
  </script>
</body>
</html>