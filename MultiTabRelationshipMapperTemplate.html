<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <?!= include('SharedStyles'); ?>
  <style>
    /* Multi-Tab Relationship Mapper Styles */
    .relationship-canvas {
      width: 100%;
      height: 400px;
      border: 2px solid var(--gray-300);
      border-radius: 12px;
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.02), rgba(99, 102, 241, 0.05));
      position: relative;
      overflow: hidden;
      margin: 16px 0;
    }
    
    .sheet-node {
      position: absolute;
      background: white;
      border: 2px solid var(--primary-300);
      border-radius: 8px;
      padding: 12px;
      min-width: 120px;
      cursor: move;
      transition: all var(--transition-fast);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .sheet-node:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
      border-color: var(--primary-500);
    }
    
    .sheet-node.selected {
      border-color: var(--success-500);
      background: var(--success-50);
    }
    
    .sheet-node-title {
      font-weight: 600;
      font-size: 12px;
      color: var(--gray-800);
      margin-bottom: 4px;
    }
    
    .sheet-node-info {
      font-size: 10px;
      color: var(--gray-600);
    }
    
    .relationship-line {
      position: absolute;
      height: 2px;
      background: var(--primary-400);
      transform-origin: left center;
      pointer-events: none;
      z-index: 1;
    }
    
    .relationship-line.strong {
      background: var(--success-500);
      height: 3px;
    }
    
    .relationship-line.weak {
      background: var(--warning-400);
      height: 1px;
      opacity: 0.7;
    }
    
    .relationship-arrow {
      position: absolute;
      right: 0;
      top: -3px;
      width: 0;
      height: 0;
      border-left: 6px solid var(--primary-400);
      border-top: 3px solid transparent;
      border-bottom: 3px solid transparent;
    }
    
    .analysis-panel {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 16px;
    }
    
    .analysis-card {
      background: var(--gray-50);
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      padding: 12px;
    }
    
    .analysis-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--gray-700);
      margin-bottom: 8px;
    }
    
    .relationship-list {
      max-height: 200px;
      overflow-y: auto;
    }
    
    .relationship-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 0;
      border-bottom: 1px solid var(--gray-200);
      font-size: 11px;
    }
    
    .relationship-item:last-child {
      border-bottom: none;
    }
    
    .relationship-strength {
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
    }
    
    .strength-strong {
      background: var(--success-100);
      color: var(--success-700);
    }
    
    .strength-medium {
      background: var(--warning-100);
      color: var(--warning-700);
    }
    
    .strength-weak {
      background: var(--gray-100);
      color: var(--gray-700);
    }
    
    .controls-panel {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    
    .control-btn {
      padding: 6px 12px;
      background: white;
      border: 1px solid var(--gray-300);
      border-radius: 6px;
      font-size: 11px;
      cursor: pointer;
      transition: all var(--transition-fast);
    }
    
    .control-btn:hover {
      background: var(--primary-50);
      border-color: var(--primary-300);
    }
    
    .control-btn.active {
      background: var(--primary-500);
      color: white;
      border-color: var(--primary-500);
    }
    
    .legend {
      display: flex;
      gap: 16px;
      align-items: center;
      padding: 8px 12px;
      background: var(--gray-50);
      border-radius: 6px;
      font-size: 11px;
      margin-top: 8px;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .legend-line {
      width: 20px;
      height: 2px;
    }
    
    .legend-line.strong { background: var(--success-500); height: 3px; }
    .legend-line.medium { background: var(--primary-400); height: 2px; }
    .legend-line.weak { background: var(--warning-400); height: 1px; }
    
    .minimap {
      position: absolute;
      bottom: 12px;
      right: 12px;
      width: 120px;
      height: 80px;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid var(--gray-300);
      border-radius: 4px;
      backdrop-filter: blur(4px);
    }
    
    .zoom-controls {
      position: absolute;
      top: 12px;
      right: 12px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .zoom-btn {
      width: 32px;
      height: 32px;
      background: white;
      border: 1px solid var(--gray-300);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
    }
    
    .zoom-btn:hover {
      background: var(--gray-50);
    }
    
    .sheet-details-panel {
      position: absolute;
      top: 50px;
      left: 12px;
      width: 200px;
      background: white;
      border: 1px solid var(--gray-300);
      border-radius: 8px;
      padding: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      display: none;
      z-index: 10;
    }
    
    .export-options {
      margin-top: 16px;
      padding: 12px;
      background: var(--gray-50);
      border-radius: 8px;
    }
    
    .export-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--gray-700);
      margin-bottom: 8px;
    }
  </style>
</head>
<body>
  <div class="nav-header">
    <button class="nav-back" onclick="backToMain()">‚Üê</button>
    <div class="nav-title">
      <h2>Multi-Tab Relationship Mapper</h2>
      <p>Visualize and analyze relationships between your sheets</p>
    </div>
  </div>
  
  <div class="container">
    <div id="statusMessage" style="display: none;"></div>
    
    <!-- Controls Panel -->
    <div class="controls-panel">
      <button class="control-btn active" onclick="analyzeAllRelationships()" id="analyzeBtn">Analyze Relationships</button>
      <button class="control-btn" onclick="autoLayout()">Auto Layout</button>
      <button class="control-btn" onclick="resetView()">Reset View</button>
      <button class="control-btn" onclick="toggleLabels()">Toggle Labels</button>
      <button class="control-btn" onclick="exportDiagram()">Export</button>
    </div>
    
    <!-- Analysis Panel -->
    <div class="analysis-panel" id="analysisPanel" style="display: none;">
      <div class="analysis-card">
        <div class="analysis-title">Discovered Relationships</div>
        <div class="relationship-list" id="relationshipsList">
          <div style="color: var(--gray-500); text-align: center; padding: 20px;">
            Click "Analyze Relationships" to discover connections
          </div>
        </div>
      </div>
      
      <div class="analysis-card">
        <div class="analysis-title">Sheet Statistics</div>
        <div id="sheetStats">
          <div style="color: var(--gray-500); text-align: center; padding: 20px;">
            Statistics will appear here
          </div>
        </div>
      </div>
    </div>
    
    <!-- Relationship Canvas -->
    <div class="card">
      <div class="card-title">Relationship Map</div>
      <div class="card-description">Interactive visualization of sheet connections</div>
      
      <div class="relationship-canvas" id="relationshipCanvas">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--gray-500); text-align: center;">
          <div style="font-size: 48px; margin-bottom: 16px;">üîó</div>
          <div style="font-size: 14px; margin-bottom: 8px;">Multi-Tab Relationship Mapper</div>
          <div style="font-size: 12px;">Click "Analyze Relationships" to begin</div>
        </div>
        
        <!-- Zoom Controls -->
        <div class="zoom-controls">
          <div class="zoom-btn" onclick="zoomIn()">+</div>
          <div class="zoom-btn" onclick="zoomOut()">‚àí</div>
        </div>
        
        <!-- Minimap -->
        <div class="minimap" id="minimap" style="display: none;"></div>
        
        <!-- Sheet Details Panel -->
        <div class="sheet-details-panel" id="sheetDetailsPanel">
          <div id="sheetDetailsContent"></div>
        </div>
      </div>
      
      <!-- Legend -->
      <div class="legend">
        <div class="legend-item">
          <div class="legend-line strong"></div>
          <span>Strong (5+ refs)</span>
        </div>
        <div class="legend-item">
          <div class="legend-line medium"></div>
          <span>Medium (2-4 refs)</span>
        </div>
        <div class="legend-item">
          <div class="legend-line weak"></div>
          <span>Weak (1 ref)</span>
        </div>
      </div>
    </div>
    
    <!-- Export Options -->
    <div class="export-options" id="exportOptions" style="display: none;">
      <div class="export-title">Export Options</div>
      <div class="btn-group">
        <button class="btn btn-secondary btn-sm" onclick="exportAsImage()">Export as Image</button>
        <button class="btn btn-secondary btn-sm" onclick="exportAsJSON()">Export Data</button>
        <button class="btn btn-secondary btn-sm" onclick="generateReport()">Generate Report</button>
      </div>
    </div>
  </div>
  
  <script>
    let relationshipData = null;
    let sheetNodes = [];
    let currentZoom = 1;
    let canvasOffset = { x: 0, y: 0 };
    let isDragging = false;
    let selectedNode = null;
    let showLabels = true;
    
    function backToMain() {
      google.script.run.showCellPilotSidebar();
    }
    
    function analyzeAllRelationships() {
      const btn = document.getElementById('analyzeBtn');
      btn.textContent = 'Analyzing...';
      btn.disabled = true;
      
      showStatus('Analyzing relationships between sheets...', 'info');
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            relationshipData = result.data;
            displayRelationships(result.data);
            createVisualization(result.data);
            showStatus('Analysis complete! Found ' + result.data.relationships.length + ' relationships.', 'success');
          } else {
            showStatus('Analysis failed: ' + result.error, 'error');
          }
          
          btn.textContent = 'Analyze Relationships';
          btn.disabled = false;
        })
        .withFailureHandler(function(error) {
          showStatus('Error: ' + error, 'error');
          btn.textContent = 'Analyze Relationships';
          btn.disabled = false;
        })
        .analyzeMultiTabRelationships();
    }
    
    function displayRelationships(data) {
      document.getElementById('analysisPanel').style.display = 'grid';
      
      // Display relationships list
      const relationshipsList = document.getElementById('relationshipsList');
      let relationshipsHtml = '';
      
      if (data.relationships.length === 0) {
        relationshipsHtml = '<div style="color: var(--gray-500); text-align: center; padding: 20px;">No relationships found</div>';
      } else {
        data.relationships.forEach(function(rel) {
          const strengthClass = getStrengthClass(rel.strength);
          relationshipsHtml += `
            <div class="relationship-item">
              <div>
                <div style="font-weight: 600;">${rel.fromSheet} ‚Üí ${rel.toSheet}</div>
                <div style="color: var(--gray-500);">${rel.references.length} reference(s)</div>
              </div>
              <span class="relationship-strength ${strengthClass}">${rel.strength}</span>
            </div>
          `;
        });
      }
      
      relationshipsList.innerHTML = relationshipsHtml;
      
      // Display sheet statistics
      const sheetStats = document.getElementById('sheetStats');
      let statsHtml = '';
      
      data.sheets.forEach(function(sheet) {
        statsHtml += `
          <div class="relationship-item">
            <div>
              <div style="font-weight: 600;">${sheet.name}</div>
              <div style="color: var(--gray-500);">${sheet.rowCount} rows, ${sheet.columnCount} cols</div>
            </div>
            <div style="font-size: 10px; color: var(--gray-600);">
              ${sheet.incomingRefs} in / ${sheet.outgoingRefs} out
            </div>
          </div>
        `;
      });
      
      sheetStats.innerHTML = statsHtml;
    }
    
    function createVisualization(data) {
      const canvas = document.getElementById('relationshipCanvas');
      
      // Clear existing visualization
      canvas.innerHTML = `
        <div class="zoom-controls">
          <div class="zoom-btn" onclick="zoomIn()">+</div>
          <div class="zoom-btn" onclick="zoomOut()">‚àí</div>
        </div>
        <div class="minimap" id="minimap" style="display: none;"></div>
        <div class="sheet-details-panel" id="sheetDetailsPanel">
          <div id="sheetDetailsContent"></div>
        </div>
      `;
      
      sheetNodes = [];
      
      // Create sheet nodes
      data.sheets.forEach(function(sheet, index) {
        const node = createSheetNode(sheet, index);
        canvas.appendChild(node);
        sheetNodes.push({
          element: node,
          sheet: sheet,
          x: 100 + (index % 3) * 150,
          y: 100 + Math.floor(index / 3) * 120
        });
      });
      
      // Position nodes
      autoLayout();
      
      // Draw relationship lines
      setTimeout(() => drawRelationshipLines(data.relationships), 100);
    }
    
    function createSheetNode(sheet, index) {
      const node = document.createElement('div');
      node.className = 'sheet-node';
      node.setAttribute('data-sheet', sheet.name);
      
      const connectionsColor = sheet.outgoingRefs > 5 ? 'var(--success-300)' : 
                              sheet.outgoingRefs > 2 ? 'var(--warning-300)' : 'var(--gray-300)';
      
      node.style.borderColor = connectionsColor;
      
      node.innerHTML = `
        <div class="sheet-node-title">${sheet.name}</div>
        <div class="sheet-node-info">
          ${sheet.rowCount} rows √ó ${sheet.columnCount} cols<br>
          ${sheet.incomingRefs} in ‚Ä¢ ${sheet.outgoingRefs} out
        </div>
      `;
      
      // Add click handler
      node.onclick = function(e) {
        e.stopPropagation();
        selectNode(node, sheet);
      };
      
      // Make draggable
      makeDraggable(node);
      
      return node;
    }
    
    function makeDraggable(element) {
      let isDragging = false;
      let startX, startY, startLeft, startTop;
      
      element.onmousedown = function(e) {
        e.preventDefault();
        isDragging = true;
        startX = e.clientX;
        startY = e.clientY;
        startLeft = parseInt(element.style.left) || 0;
        startTop = parseInt(element.style.top) || 0;
        
        document.onmousemove = function(e) {
          if (isDragging) {
            const newLeft = startLeft + (e.clientX - startX);
            const newTop = startTop + (e.clientY - startY);
            
            element.style.left = newLeft + 'px';
            element.style.top = newTop + 'px';
            
            // Update node position in data
            const nodeData = sheetNodes.find(n => n.element === element);
            if (nodeData) {
              nodeData.x = newLeft;
              nodeData.y = newTop;
            }
            
            // Redraw relationship lines
            if (relationshipData) {
              drawRelationshipLines(relationshipData.relationships);
            }
          }
        };
        
        document.onmouseup = function() {
          isDragging = false;
          document.onmousemove = null;
          document.onmouseup = null;
        };
      };
    }
    
    function selectNode(nodeElement, sheet) {
      // Clear previous selection
      document.querySelectorAll('.sheet-node').forEach(n => n.classList.remove('selected'));
      
      // Select current node
      nodeElement.classList.add('selected');
      selectedNode = { element: nodeElement, sheet: sheet };
      
      // Show sheet details
      showSheetDetails(sheet);
    }
    
    function showSheetDetails(sheet) {
      const panel = document.getElementById('sheetDetailsPanel');
      const content = document.getElementById('sheetDetailsContent');
      
      content.innerHTML = `
        <div style="font-weight: 600; margin-bottom: 8px;">${sheet.name}</div>
        <div style="font-size: 11px; color: var(--gray-600); line-height: 1.4;">
          <div>Dimensions: ${sheet.rowCount} √ó ${sheet.columnCount}</div>
          <div>Incoming: ${sheet.incomingRefs} references</div>
          <div>Outgoing: ${sheet.outgoingRefs} references</div>
          <div>Last Modified: ${sheet.lastModified || 'Unknown'}</div>
        </div>
        <div style="margin-top: 8px;">
          <button class="btn btn-sm btn-primary" onclick="navigateToSheet('${sheet.name}')">Go to Sheet</button>
        </div>
      `;
      
      panel.style.display = 'block';
    }
    
    function drawRelationshipLines(relationships) {
      // Remove existing lines
      document.querySelectorAll('.relationship-line').forEach(line => line.remove());
      
      const canvas = document.getElementById('relationshipCanvas');
      
      relationships.forEach(function(rel) {
        const fromNode = sheetNodes.find(n => n.sheet.name === rel.fromSheet);
        const toNode = sheetNodes.find(n => n.sheet.name === rel.toSheet);
        
        if (fromNode && toNode) {
          const line = createRelationshipLine(fromNode, toNode, rel);
          canvas.appendChild(line);
        }
      });
    }
    
    function createRelationshipLine(fromNode, toNode, relationship) {
      const line = document.createElement('div');
      line.className = 'relationship-line';
      
      // Calculate line position and angle
      const fromRect = fromNode.element.getBoundingClientRect();
      const toRect = toNode.element.getBoundingClientRect();
      const canvasRect = document.getElementById('relationshipCanvas').getBoundingClientRect();
      
      const fromX = fromNode.x + 60; // Center of node
      const fromY = fromNode.y + 25;
      const toX = toNode.x + 60;
      const toY = toNode.y + 25;
      
      const length = Math.sqrt(Math.pow(toX - fromX, 2) + Math.pow(toY - fromY, 2));
      const angle = Math.atan2(toY - fromY, toX - fromX) * (180 / Math.PI);
      
      line.style.left = fromX + 'px';
      line.style.top = fromY + 'px';
      line.style.width = length + 'px';
      line.style.transform = `rotate(${angle}deg)`;
      
      // Style based on relationship strength
      if (relationship.strength === 'strong') {
        line.classList.add('strong');
      } else if (relationship.strength === 'weak') {
        line.classList.add('weak');
      }
      
      // Add arrow
      const arrow = document.createElement('div');
      arrow.className = 'relationship-arrow';
      line.appendChild(arrow);
      
      return line;
    }
    
    function autoLayout() {
      if (!relationshipData || sheetNodes.length === 0) return;
      
      // Simple circular layout
      const centerX = 200;
      const centerY = 200;
      const radius = 150;
      
      sheetNodes.forEach(function(nodeData, index) {
        const angle = (index / sheetNodes.length) * 2 * Math.PI;
        nodeData.x = centerX + radius * Math.cos(angle);
        nodeData.y = centerY + radius * Math.sin(angle);
        
        nodeData.element.style.left = nodeData.x + 'px';
        nodeData.element.style.top = nodeData.y + 'px';
      });
      
      // Redraw lines
      if (relationshipData) {
        setTimeout(() => drawRelationshipLines(relationshipData.relationships), 100);
      }
    }
    
    function resetView() {
      currentZoom = 1;
      canvasOffset = { x: 0, y: 0 };
      const canvas = document.getElementById('relationshipCanvas');
      canvas.style.transform = 'scale(1) translate(0, 0)';
      
      // Hide details panel
      document.getElementById('sheetDetailsPanel').style.display = 'none';
      selectedNode = null;
      document.querySelectorAll('.sheet-node').forEach(n => n.classList.remove('selected'));
    }
    
    function toggleLabels() {
      showLabels = !showLabels;
      const labels = document.querySelectorAll('.sheet-node-info');
      labels.forEach(label => {
        label.style.display = showLabels ? 'block' : 'none';
      });
    }
    
    function zoomIn() {
      currentZoom = Math.min(currentZoom * 1.2, 3);
      applyZoom();
    }
    
    function zoomOut() {
      currentZoom = Math.max(currentZoom * 0.8, 0.3);
      applyZoom();
    }
    
    function applyZoom() {
      const canvas = document.getElementById('relationshipCanvas');
      canvas.style.transform = `scale(${currentZoom}) translate(${canvasOffset.x}px, ${canvasOffset.y}px)`;
    }
    
    function exportDiagram() {
      const options = document.getElementById('exportOptions');
      options.style.display = options.style.display === 'none' ? 'block' : 'none';
    }
    
    function exportAsImage() {
      showStatus('Exporting diagram as image...', 'info');
      // Implementation for image export would go here
      setTimeout(() => {
        showStatus('Export functionality coming soon!', 'info');
      }, 1000);
    }
    
    function exportAsJSON() {
      if (!relationshipData) {
        showStatus('No data to export', 'error');
        return;
      }
      
      const dataStr = JSON.stringify(relationshipData, null, 2);
      const dataBlob = new Blob([dataStr], {type: 'application/json'});
      
      const link = document.createElement('a');
      link.href = URL.createObjectURL(dataBlob);
      link.download = 'sheet-relationships.json';
      link.click();
      
      showStatus('Relationship data exported!', 'success');
    }
    
    function generateReport() {
      if (!relationshipData) {
        showStatus('No data to generate report', 'error');
        return;
      }
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showStatus('Report generated: ' + result.sheetName, 'success');
          } else {
            showStatus('Failed to generate report: ' + result.error, 'error');
          }
        })
        .withFailureHandler(function(error) {
          showStatus('Error generating report: ' + error, 'error');
        })
        .generateRelationshipReport(relationshipData);
    }
    
    function navigateToSheet(sheetName) {
      google.script.run
        .withSuccessHandler(function(success) {
          if (success) {
            showStatus('Navigated to ' + sheetName, 'success');
          } else {
            showStatus('Failed to navigate to sheet', 'error');
          }
        })
        .navigateToSheet(sheetName);
    }
    
    function getStrengthClass(strength) {
      switch (strength) {
        case 'strong': return 'strength-strong';
        case 'medium': return 'strength-medium';
        default: return 'strength-weak';
      }
    }
    
    function showStatus(message, type) {
      const statusDiv = document.getElementById('statusMessage');
      statusDiv.className = 'alert alert-' + type;
      statusDiv.textContent = message;
      statusDiv.style.display = 'block';
      
      if (type === 'success') {
        setTimeout(function() {
          statusDiv.style.display = 'none';
        }, 3000);
      }
    }
  </script>
</body>
</html>