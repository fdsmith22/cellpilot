<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <?!= include('SharedStyles'); ?>
  <style>
    /* Smart Formula Debugger Styles */
    .debugger-panel {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.02), rgba(239, 68, 68, 0.05));
      border: 2px solid var(--error-200);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }
    
    .debugger-panel.success {
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.02), rgba(34, 197, 94, 0.05));
      border-color: var(--success-200);
    }
    
    .debugger-panel.warning {
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.02), rgba(245, 158, 11, 0.05));
      border-color: var(--warning-200);
    }
    
    .error-item {
      background: white;
      border: 1px solid var(--error-200);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      transition: all var(--transition-fast);
    }
    
    .error-item:hover {
      transform: translateX(2px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .error-item.warning {
      border-color: var(--warning-200);
      background: var(--warning-50);
    }
    
    .error-item.info {
      border-color: var(--primary-200);
      background: var(--primary-50);
    }
    
    .error-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    
    .error-type {
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 600;
      font-size: 12px;
    }
    
    .error-icon {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
    }
    
    .error-icon.error {
      background: var(--error-100);
      color: var(--error-600);
    }
    
    .error-icon.warning {
      background: var(--warning-100);
      color: var(--warning-600);
    }
    
    .error-icon.info {
      background: var(--primary-100);
      color: var(--primary-600);
    }
    
    .error-location {
      font-size: 11px;
      color: var(--gray-500);
    }
    
    .error-message {
      font-size: 12px;
      color: var(--gray-700);
      margin-bottom: 8px;
      line-height: 1.4;
    }
    
    .formula-display {
      background: var(--gray-50);
      border: 1px solid var(--gray-200);
      border-radius: 6px;
      padding: 8px;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 11px;
      margin-bottom: 8px;
      position: relative;
      overflow-x: auto;
    }
    
    .formula-display.highlighted {
      background: linear-gradient(90deg, 
        var(--gray-50) 0%, 
        var(--error-50) 20%, 
        var(--error-50) 80%, 
        var(--gray-50) 100%);
    }
    
    .error-highlight {
      background: var(--error-100);
      color: var(--error-700);
      padding: 2px 4px;
      border-radius: 2px;
      font-weight: 600;
    }
    
    .fix-suggestions {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid var(--gray-200);
    }
    
    .fix-title {
      font-size: 11px;
      font-weight: 600;
      color: var(--gray-600);
      margin-bottom: 6px;
    }
    
    .fix-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px;
      background: var(--success-50);
      border: 1px solid var(--success-200);
      border-radius: 4px;
      margin-bottom: 4px;
      cursor: pointer;
      transition: all var(--transition-fast);
    }
    
    .fix-option:hover {
      background: var(--success-100);
      border-color: var(--success-300);
    }
    
    .fix-icon {
      color: var(--success-600);
    }
    
    .fix-description {
      flex: 1;
      font-size: 11px;
      color: var(--gray-700);
    }
    
    .fix-formula {
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 10px;
      color: var(--success-700);
      background: var(--success-100);
      padding: 2px 4px;
      border-radius: 2px;
    }
    
    .debug-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-bottom: 16px;
    }
    
    .stat-card {
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      padding: 12px;
      text-align: center;
    }
    
    .stat-value {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    
    .stat-value.error { color: var(--error-600); }
    .stat-value.warning { color: var(--warning-600); }
    .stat-value.success { color: var(--success-600); }
    
    .stat-label {
      font-size: 10px;
      color: var(--gray-500);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .debug-controls {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    
    .control-button {
      padding: 8px 12px;
      background: white;
      border: 1px solid var(--gray-300);
      border-radius: 6px;
      font-size: 11px;
      cursor: pointer;
      transition: all var(--transition-fast);
    }
    
    .control-button:hover {
      background: var(--primary-50);
      border-color: var(--primary-300);
    }
    
    .control-button.active {
      background: var(--primary-500);
      color: white;
      border-color: var(--primary-500);
    }
    
    .trace-panel {
      background: var(--gray-50);
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      padding: 12px;
      margin-top: 12px;
    }
    
    .trace-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--gray-700);
      margin-bottom: 8px;
    }
    
    .trace-step {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px;
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 4px;
      margin-bottom: 4px;
      font-size: 11px;
    }
    
    .trace-number {
      width: 24px;
      height: 24px;
      background: var(--primary-100);
      color: var(--primary-700);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 10px;
    }
    
    .trace-description {
      flex: 1;
      color: var(--gray-700);
    }
    
    .trace-value {
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 10px;
      background: var(--gray-100);
      padding: 2px 6px;
      border-radius: 2px;
      color: var(--gray-700);
    }
    
    .dependency-tree {
      margin-top: 12px;
    }
    
    .tree-node {
      margin-left: 16px;
      padding-left: 12px;
      border-left: 1px solid var(--gray-300);
      position: relative;
    }
    
    .tree-node::before {
      content: '';
      position: absolute;
      left: -1px;
      top: 12px;
      width: 12px;
      height: 1px;
      background: var(--gray-300);
    }
    
    .tree-item {
      padding: 4px 8px;
      margin-bottom: 4px;
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 4px;
      font-size: 11px;
      display: inline-block;
    }
    
    .performance-meter {
      height: 20px;
      background: var(--gray-100);
      border-radius: 10px;
      overflow: hidden;
      margin-top: 8px;
    }
    
    .performance-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--success-400), var(--warning-400), var(--error-400));
      transition: width 0.5s ease;
    }
    
    .debug-filter {
      display: flex;
      gap: 4px;
      margin-bottom: 12px;
    }
    
    .filter-chip {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 10px;
      cursor: pointer;
      background: var(--gray-100);
      color: var(--gray-600);
      border: 1px solid var(--gray-200);
      transition: all var(--transition-fast);
    }
    
    .filter-chip.active {
      background: var(--primary-100);
      color: var(--primary-700);
      border-color: var(--primary-300);
    }
    
    .filter-chip:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>
<body>
  <div class="nav-header">
    <button class="nav-back" onclick="backToMain()">‚Üê</button>
    <div class="nav-title">
      <h2>Smart Formula Debugger</h2>
      <p>Identify and fix formula errors instantly</p>
    </div>
  </div>
  
  <div class="container">
    <div id="statusMessage" style="display: none;"></div>
    
    <!-- Debug Controls -->
    <div class="debug-controls">
      <button class="control-button active" onclick="debugActiveCell()" id="debugCellBtn">Debug Active Cell</button>
      <button class="control-button" onclick="debugSelection()">Debug Selection</button>
      <button class="control-button" onclick="debugAllFormulas()">Debug All Formulas</button>
      <button class="control-button" onclick="showDependencies()">Show Dependencies</button>
      <button class="control-button" onclick="performanceAnalysis()">Performance Analysis</button>
    </div>
    
    <!-- Debug Statistics -->
    <div class="debug-stats">
      <div class="stat-card">
        <div class="stat-value error" id="errorCount">0</div>
        <div class="stat-label">Errors</div>
      </div>
      <div class="stat-card">
        <div class="stat-value warning" id="warningCount">0</div>
        <div class="stat-label">Warnings</div>
      </div>
      <div class="stat-card">
        <div class="stat-value success" id="validCount">0</div>
        <div class="stat-label">Valid</div>
      </div>
    </div>
    
    <!-- Filter Options -->
    <div class="debug-filter">
      <div class="filter-chip active" onclick="filterResults('all')">All Issues</div>
      <div class="filter-chip" onclick="filterResults('errors')">Errors Only</div>
      <div class="filter-chip" onclick="filterResults('warnings')">Warnings Only</div>
      <div class="filter-chip" onclick="filterResults('performance')">Performance</div>
      <div class="filter-chip" onclick="filterResults('circular')">Circular Refs</div>
    </div>
    
    <!-- Main Debug Panel -->
    <div class="card">
      <div class="card-title">Debug Results</div>
      <div class="card-description">Click on any issue to see detailed analysis and fixes</div>
      
      <div id="debugResults">
        <div class="debugger-panel">
          <div style="text-align: center; padding: 40px; color: var(--gray-500);">
            <div style="font-size: 48px; margin-bottom: 16px;">üîç</div>
            <div style="font-size: 14px; margin-bottom: 8px;">Ready to Debug</div>
            <div style="font-size: 12px;">Select a cell with a formula and click "Debug Active Cell" to begin</div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Trace Panel -->
    <div id="tracePanel" class="trace-panel" style="display: none;">
      <div class="trace-title">Formula Execution Trace</div>
      <div id="traceContent"></div>
    </div>
    
    <!-- Dependency Tree -->
    <div id="dependencyPanel" class="card" style="display: none; margin-top: 16px;">
      <div class="card-title">Dependency Tree</div>
      <div class="card-description">Cells and ranges that this formula depends on</div>
      <div class="dependency-tree" id="dependencyTree"></div>
    </div>
    
    <!-- Performance Analysis -->
    <div id="performancePanel" class="card" style="display: none; margin-top: 16px;">
      <div class="card-title">Performance Analysis</div>
      <div class="card-description">Optimization suggestions for formula efficiency</div>
      <div id="performanceContent"></div>
    </div>
  </div>
  
  <script>
    let currentDebugData = null;
    let currentFilter = 'all';
    
    function backToMain() {
      google.script.run.showCellPilotSidebar();
    }
    
    function debugActiveCell() {
      const btn = document.getElementById('debugCellBtn');
      btn.textContent = 'Debugging...';
      btn.disabled = true;
      
      showStatus('Analyzing active cell formula...', 'info');
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            currentDebugData = result.data;
            displayDebugResults(result.data);
            updateStatistics(result.data);
            showStatus('Debug analysis complete', 'success');
          } else {
            showStatus(result.error || 'No formula found in active cell', 'warning');
            displayNoFormula();
          }
          btn.textContent = 'Debug Active Cell';
          btn.disabled = false;
        })
        .withFailureHandler(function(error) {
          showStatus('Debug error: ' + error, 'error');
          btn.textContent = 'Debug Active Cell';
          btn.disabled = false;
        })
        .debugActiveFormula();
    }
    
    function debugSelection() {
      showStatus('Analyzing formulas in selection...', 'info');
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            currentDebugData = result.data;
            displayDebugResults(result.data);
            updateStatistics(result.data);
            showStatus('Found ' + result.data.totalFormulas + ' formulas in selection', 'success');
          } else {
            showStatus(result.error || 'No formulas found in selection', 'warning');
          }
        })
        .withFailureHandler(function(error) {
          showStatus('Debug error: ' + error, 'error');
        })
        .debugSelectionFormulas();
    }
    
    function debugAllFormulas() {
      showStatus('Analyzing all formulas in sheet...', 'info');
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            currentDebugData = result.data;
            displayDebugResults(result.data);
            updateStatistics(result.data);
            showStatus('Analyzed ' + result.data.totalFormulas + ' formulas', 'success');
          } else {
            showStatus(result.error || 'No formulas found', 'warning');
          }
        })
        .withFailureHandler(function(error) {
          showStatus('Debug error: ' + error, 'error');
        })
        .debugAllSheetFormulas();
    }
    
    function displayDebugResults(data) {
      const resultsDiv = document.getElementById('debugResults');
      
      if (!data || !data.issues || data.issues.length === 0) {
        resultsDiv.innerHTML = `
          <div class="debugger-panel success">
            <div style="text-align: center; padding: 20px;">
              <div style="font-size: 32px; margin-bottom: 8px;">‚úÖ</div>
              <div style="font-size: 14px; color: var(--success-700); font-weight: 600;">All Formulas Valid!</div>
              <div style="font-size: 12px; color: var(--gray-600); margin-top: 4px;">No errors or warnings detected</div>
            </div>
          </div>
        `;
        return;
      }
      
      let html = '';
      
      // Filter issues based on current filter
      const filteredIssues = filterIssues(data.issues, currentFilter);
      
      filteredIssues.forEach(function(issue, index) {
        const typeClass = getTypeClass(issue.severity);
        const iconSymbol = getIconSymbol(issue.severity);
        
        html += `
          <div class="error-item ${typeClass}">
            <div class="error-header">
              <div class="error-type">
                <div class="error-icon ${typeClass}">${iconSymbol}</div>
                <span>${issue.type}</span>
              </div>
              <div class="error-location">${issue.cell}</div>
            </div>
            <div class="error-message">${issue.message}</div>
            <div class="formula-display">${highlightError(issue.formula, issue.errorPosition)}</div>
        `;
        
        // Add suggested fixes if available
        if (issue.suggestions && issue.suggestions.length > 0) {
          html += '<div class="fix-suggestions"><div class="fix-title">Suggested Fixes:</div>';
          
          issue.suggestions.forEach(function(fix) {
            html += `
              <div class="fix-option" onclick="applyFix('${issue.cell}', '${escapeFormula(fix.formula)}')">
                <div class="fix-icon">‚úì</div>
                <div class="fix-description">${fix.description}</div>
                <div class="fix-formula">${fix.formula}</div>
              </div>
            `;
          });
          
          html += '</div>';
        }
        
        html += '</div>';
      });
      
      resultsDiv.innerHTML = html;
    }
    
    function filterIssues(issues, filter) {
      if (filter === 'all') return issues;
      if (filter === 'errors') return issues.filter(i => i.severity === 'error');
      if (filter === 'warnings') return issues.filter(i => i.severity === 'warning');
      if (filter === 'performance') return issues.filter(i => i.type === 'Performance');
      if (filter === 'circular') return issues.filter(i => i.type === 'Circular Reference');
      return issues;
    }
    
    function filterResults(filter) {
      currentFilter = filter;
      
      // Update filter chip states
      document.querySelectorAll('.filter-chip').forEach(chip => {
        chip.classList.remove('active');
      });
      event.target.classList.add('active');
      
      // Re-display results with filter
      if (currentDebugData) {
        displayDebugResults(currentDebugData);
      }
    }
    
    function updateStatistics(data) {
      document.getElementById('errorCount').textContent = data.errorCount || 0;
      document.getElementById('warningCount').textContent = data.warningCount || 0;
      document.getElementById('validCount').textContent = data.validCount || 0;
    }
    
    function highlightError(formula, position) {
      if (!position || position.start === undefined) {
        return escapeHtml(formula);
      }
      
      const before = formula.substring(0, position.start);
      const error = formula.substring(position.start, position.end || position.start + 1);
      const after = formula.substring(position.end || position.start + 1);
      
      return escapeHtml(before) + 
             '<span class="error-highlight">' + escapeHtml(error) + '</span>' + 
             escapeHtml(after);
    }
    
    function applyFix(cell, formula) {
      showStatus('Applying fix to ' + cell + '...', 'info');
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showStatus('Fix applied successfully!', 'success');
            // Re-run debug on the cell
            setTimeout(debugActiveCell, 1000);
          } else {
            showStatus('Failed to apply fix: ' + result.error, 'error');
          }
        })
        .withFailureHandler(function(error) {
          showStatus('Error applying fix: ' + error, 'error');
        })
        .applyFormulFix(cell, formula);
    }
    
    function showDependencies() {
      const panel = document.getElementById('dependencyPanel');
      
      if (panel.style.display === 'none') {
        loadDependencies();
        panel.style.display = 'block';
      } else {
        panel.style.display = 'none';
      }
    }
    
    function loadDependencies() {
      showStatus('Analyzing dependencies...', 'info');
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            displayDependencyTree(result.dependencies);
            showStatus('Dependency analysis complete', 'success');
          } else {
            showStatus('No dependencies found', 'warning');
          }
        })
        .withFailureHandler(function(error) {
          showStatus('Dependency analysis error: ' + error, 'error');
        })
        .analyzeDependencies();
    }
    
    function displayDependencyTree(dependencies) {
      const treeDiv = document.getElementById('dependencyTree');
      
      if (!dependencies || dependencies.length === 0) {
        treeDiv.innerHTML = '<div style="color: var(--gray-500);">No dependencies found</div>';
        return;
      }
      
      let html = '';
      dependencies.forEach(function(dep) {
        html += buildTreeNode(dep, 0);
      });
      
      treeDiv.innerHTML = html;
    }
    
    function buildTreeNode(node, level) {
      let html = '<div class="tree-node" style="margin-left: ' + (level * 16) + 'px;">';
      html += '<div class="tree-item">' + node.cell + ' ‚Üí ' + node.reference + '</div>';
      
      if (node.children && node.children.length > 0) {
        node.children.forEach(function(child) {
          html += buildTreeNode(child, level + 1);
        });
      }
      
      html += '</div>';
      return html;
    }
    
    function performanceAnalysis() {
      const panel = document.getElementById('performancePanel');
      panel.style.display = 'block';
      
      showStatus('Analyzing formula performance...', 'info');
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            displayPerformanceAnalysis(result.analysis);
            showStatus('Performance analysis complete', 'success');
          } else {
            showStatus('Performance analysis failed: ' + result.error, 'error');
          }
        })
        .withFailureHandler(function(error) {
          showStatus('Error: ' + error, 'error');
        })
        .analyzeFormulaPerformance();
    }
    
    function displayPerformanceAnalysis(analysis) {
      const contentDiv = document.getElementById('performanceContent');
      
      let html = '<div class="performance-meter">';
      html += '<div class="performance-fill" style="width: ' + (100 - analysis.score) + '%;"></div>';
      html += '</div>';
      html += '<div style="font-size: 11px; color: var(--gray-600); margin-top: 4px;">Performance Score: ' + analysis.score + '/100</div>';
      
      if (analysis.suggestions && analysis.suggestions.length > 0) {
        html += '<div style="margin-top: 16px;">';
        html += '<div class="fix-title">Optimization Suggestions:</div>';
        
        analysis.suggestions.forEach(function(suggestion) {
          html += `
            <div class="fix-option">
              <div class="fix-icon">‚ö°</div>
              <div class="fix-description">${suggestion.description}</div>
              <div style="font-size: 10px; color: var(--success-600);">+${suggestion.improvement}% faster</div>
            </div>
          `;
        });
        
        html += '</div>';
      }
      
      contentDiv.innerHTML = html;
    }
    
    function displayNoFormula() {
      const resultsDiv = document.getElementById('debugResults');
      resultsDiv.innerHTML = `
        <div class="debugger-panel warning">
          <div style="text-align: center; padding: 20px;">
            <div style="font-size: 32px; margin-bottom: 8px;">üìù</div>
            <div style="font-size: 14px; color: var(--warning-700); font-weight: 600;">No Formula Found</div>
            <div style="font-size: 12px; color: var(--gray-600); margin-top: 4px;">Select a cell containing a formula and try again</div>
          </div>
        </div>
      `;
    }
    
    function getTypeClass(severity) {
      switch(severity) {
        case 'error': return 'error';
        case 'warning': return 'warning';
        default: return 'info';
      }
    }
    
    function getIconSymbol(severity) {
      switch(severity) {
        case 'error': return '!';
        case 'warning': return '‚ö†';
        default: return 'i';
      }
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function escapeFormula(formula) {
      return formula.replace(/'/g, "\\'").replace(/"/g, '\\"');
    }
    
    function showStatus(message, type) {
      const statusDiv = document.getElementById('statusMessage');
      statusDiv.className = 'alert alert-' + type;
      statusDiv.textContent = message;
      statusDiv.style.display = 'block';
      
      if (type === 'success') {
        setTimeout(function() {
          statusDiv.style.display = 'none';
        }, 3000);
      }
    }
  </script>
</body>
</html>