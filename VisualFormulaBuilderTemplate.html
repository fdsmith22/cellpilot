<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <?!= include('SharedStyles'); ?>
  <style>
    /* Visual Formula Builder Styles */
    .formula-canvas {
      min-height: 200px;
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.02), rgba(99, 102, 241, 0.05));
      border: 2px dashed var(--primary-300);
      border-radius: 12px;
      padding: 20px;
      margin: 16px 0;
      position: relative;
      transition: all var(--transition-fast);
    }
    
    .formula-canvas.drag-over {
      border-color: var(--primary-500);
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(99, 102, 241, 0.1));
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }
    
    .formula-canvas-empty {
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--gray-500);
      font-size: 13px;
      text-align: center;
      min-height: 180px;
    }
    
    /* Draggable Components */
    .component-palette {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-bottom: 16px;
    }
    
    .component-section {
      margin-bottom: 20px;
    }
    
    .component-section-title {
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--gray-600);
      margin-bottom: 8px;
      padding-bottom: 4px;
      border-bottom: 1px solid var(--gray-200);
    }
    
    .draggable-component {
      background: white;
      border: 1.5px solid var(--gray-200);
      border-radius: 8px;
      padding: 10px;
      cursor: move;
      transition: all var(--transition-fast);
      font-size: 12px;
      text-align: center;
      position: relative;
      user-select: none;
    }
    
    .draggable-component:hover {
      border-color: var(--primary-400);
      background: var(--gray-50);
      transform: translateY(-2px);
      box-shadow: var(--elevation-2);
    }
    
    .draggable-component.dragging {
      opacity: 0.5;
      transform: scale(0.95);
    }
    
    .component-icon {
      width: 24px;
      height: 24px;
      margin: 0 auto 4px;
      background: var(--primary-100);
      color: var(--primary-600);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 700;
    }
    
    .component-label {
      font-size: 11px;
      color: var(--gray-700);
      font-weight: 500;
    }
    
    /* Formula Elements */
    .formula-element {
      display: inline-flex;
      align-items: center;
      background: white;
      border: 1.5px solid var(--primary-400);
      border-radius: 8px;
      padding: 6px 10px;
      margin: 4px;
      position: relative;
      animation: slideIn 0.3s ease;
      box-shadow: var(--elevation-1);
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .formula-element.function {
      background: linear-gradient(135deg, var(--primary-50), var(--primary-100));
      border-color: var(--primary-500);
    }
    
    .formula-element.range {
      background: linear-gradient(135deg, var(--success-50), var(--success-100));
      border-color: var(--success-500);
    }
    
    .formula-element.operator {
      background: linear-gradient(135deg, var(--warning-50), var(--warning-100));
      border-color: var(--warning-500);
      padding: 4px 8px;
    }
    
    .formula-element.value {
      background: linear-gradient(135deg, var(--gray-50), var(--gray-100));
      border-color: var(--gray-400);
    }
    
    .element-type {
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--gray-600);
      margin-right: 6px;
      font-weight: 700;
    }
    
    .element-content {
      font-size: 12px;
      font-weight: 600;
      color: var(--gray-800);
    }
    
    .element-remove {
      width: 16px;
      height: 16px;
      margin-left: 6px;
      background: var(--danger-500);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 10px;
      transition: all var(--transition-fast);
    }
    
    .element-remove:hover {
      background: var(--danger-600);
      transform: scale(1.1);
    }
    
    /* Formula Preview */
    .formula-preview {
      background: var(--gray-900);
      color: var(--success-500);
      padding: 12px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      margin: 12px 0;
      word-break: break-all;
      min-height: 40px;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .formula-preview.error {
      color: var(--danger-400);
    }
    
    .formula-preview.empty {
      color: var(--gray-500);
      font-style: italic;
    }
    
    /* Connection Lines */
    .connection-line {
      position: absolute;
      height: 2px;
      background: var(--primary-400);
      transform-origin: left center;
      pointer-events: none;
      z-index: 0;
    }
    
    /* Parameter Input */
    .parameter-input {
      display: inline-block;
      min-width: 80px;
      padding: 4px 8px;
      border: 1px solid var(--gray-300);
      border-radius: 4px;
      font-size: 11px;
      margin: 0 4px;
      background: white;
    }
    
    .parameter-input:focus {
      outline: none;
      border-color: var(--primary-500);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }
    
    /* Cross-Sheet Reference Styles */
    .sheet-data-preview {
      background: var(--gray-50);
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      padding: 12px;
      margin-top: 12px;
    }
    
    .preview-header {
      font-size: 12px;
      font-weight: 600;
      color: var(--gray-700);
      margin-bottom: 8px;
    }
    
    .preview-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
      background: white;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 8px;
    }
    
    .preview-table th,
    .preview-table td {
      padding: 4px 8px;
      border: 1px solid var(--gray-200);
      text-align: left;
    }
    
    .preview-table th {
      background: var(--gray-100);
      font-weight: 600;
      color: var(--gray-700);
    }
    
    .cross-sheet-reference {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.15));
      border: 1px solid var(--success-300);
      color: var(--success-700);
      font-weight: 600;
    }
    
    .cross-sheet-reference .component-icon {
      background: var(--success-500);
      color: white;
    }
    
    /* Active Cross-Sheet Mode */
    .cross-sheet-mode .quick-action-btn#crossSheetBtn {
      background: var(--success-500);
      color: white;
    }
    
    /* Smart Suggestions Styles */
    .suggestions-list {
      max-height: 300px;
      overflow-y: auto;
    }
    
    .suggestion-item {
      display: flex;
      align-items: center;
      padding: 12px;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      margin-bottom: 8px;
      background: white;
      cursor: pointer;
      transition: all var(--transition-fast);
    }
    
    .suggestion-item:hover {
      background: var(--primary-50);
      border-color: var(--primary-300);
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .suggestion-item.high-confidence {
      border-color: var(--success-300);
      background: var(--success-50);
    }
    
    .suggestion-item.medium-confidence {
      border-color: var(--warning-300);
      background: var(--warning-50);
    }
    
    .suggestion-content {
      flex: 1;
    }
    
    .suggestion-formula {
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 12px;
      font-weight: 600;
      color: var(--primary-600);
      margin-bottom: 4px;
    }
    
    .suggestion-description {
      font-size: 11px;
      color: var(--gray-600);
      margin-bottom: 4px;
    }
    
    .suggestion-meta {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    .suggestion-category {
      background: var(--gray-100);
      color: var(--gray-700);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
    }
    
    .confidence-badge {
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
    }
    
    .confidence-high {
      background: var(--success-100);
      color: var(--success-700);
    }
    
    .confidence-medium {
      background: var(--warning-100);
      color: var(--warning-700);
    }
    
    .confidence-low {
      background: var(--gray-100);
      color: var(--gray-700);
    }
    
    .data-analysis-section {
      background: var(--gray-50);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 16px;
    }
    
    .analysis-header {
      font-size: 12px;
      font-weight: 600;
      color: var(--gray-700);
      margin-bottom: 8px;
    }
    
    .analysis-item {
      font-size: 11px;
      color: var(--gray-600);
      margin-bottom: 4px;
    }
    
    .suggestion-loading {
      text-align: center;
      padding: 20px;
      color: var(--gray-500);
      font-size: 13px;
    }

    /* Collapsible Sections */
    .collapsible-section {
      margin-bottom: 12px;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      overflow: hidden;
    }
    
    .collapsible-header {
      background: var(--gray-50);
      padding: 10px 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: all var(--transition-fast);
      font-size: 12px;
      font-weight: 600;
      color: var(--gray-700);
    }
    
    .collapsible-header:hover {
      background: var(--gray-100);
    }
    
    .collapsible-header.active {
      background: linear-gradient(135deg, var(--primary-50), var(--primary-100));
      color: var(--primary-700);
    }
    
    .collapsible-arrow {
      transition: transform var(--transition-fast);
      font-size: 10px;
    }
    
    .collapsible-header.active .collapsible-arrow {
      transform: rotate(180deg);
    }
    
    .collapsible-content {
      padding: 12px;
      display: none;
      background: white;
    }
    
    .collapsible-content.active {
      display: block;
    }
    
    /* Help Tips */
    .help-tip {
      display: inline-block;
      width: 14px;
      height: 14px;
      background: var(--primary-500);
      color: white;
      border-radius: 50%;
      text-align: center;
      font-size: 10px;
      line-height: 14px;
      cursor: help;
      margin-left: 4px;
    }
    
    .tooltip {
      position: absolute;
      background: var(--gray-900);
      color: white;
      padding: 6px 8px;
      border-radius: 4px;
      font-size: 11px;
      white-space: nowrap;
      z-index: 1000;
      pointer-events: none;
      opacity: 0;
      transition: opacity var(--transition-fast);
    }
    
    .tooltip.show {
      opacity: 1;
    }
    
    /* Quick Actions Bar */
    .quick-actions {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      padding: 8px;
      background: var(--gray-50);
      border-radius: 8px;
      flex-wrap: wrap;
    }
    
    .quick-action-btn {
      padding: 6px 10px;
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 6px;
      font-size: 11px;
      cursor: pointer;
      transition: all var(--transition-fast);
      white-space: nowrap;
    }
    
    .quick-action-btn:hover {
      border-color: var(--primary-400);
      background: var(--primary-50);
    }
  </style>
</head>
<body>
  <div class="nav-header">
    <button class="nav-back" onclick="google.script.run.showCellPilotSidebar()" style="padding: 8px 12px; background: var(--gray-100); border: 1px solid var(--gray-300); border-radius: 6px; cursor: pointer; font-size: 12px; color: var(--gray-700); display: flex; align-items: center; gap: 6px; margin-bottom: 12px;">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="15 18 9 12 15 6"></polyline>
      </svg>
      Back to CellPilot
    </button>
    <div>
    <button class="nav-back" onclick="backToMain()">←</button>
    <div class="nav-title">
      <h2>Visual Formula Builder</h2>
      <p>Drag and drop to create complex formulas</p>
    </div>
  </div>
  
  <div class="container">
    <div id="statusMessage" style="display: none;"></div>
    
    <!-- Quick Actions -->
    <div class="quick-actions">
      <button class="quick-action-btn" onclick="clearCanvas()">Clear All</button>
      <button class="quick-action-btn" onclick="showSmartSuggestions()">Smart Suggestions</button>
      <button class="quick-action-btn" onclick="validateFormula()">Validate</button>
      <button class="quick-action-btn" onclick="optimizeFormula()">Optimize</button>
      <button class="quick-action-btn" onclick="toggleCrossSheetMode()" id="crossSheetBtn">Cross-Sheet Mode</button>
    </div>
    
    <!-- Smart Suggestions Panel -->
    <div id="smartSuggestionsPanel" class="card" style="display: none; margin-bottom: 16px;">
      <div class="card-title">Smart Formula Suggestions</div>
      <div class="card-description">AI-powered suggestions based on your data patterns</div>
      
      <div id="dataAnalysis" class="data-analysis-section" style="display: none;">
        <div class="analysis-header">Data Analysis</div>
        <div id="analysisContent"></div>
      </div>
      
      <div id="suggestionsList" class="suggestions-list">
        <div class="suggestion-loading">Analyzing your data...</div>
      </div>
      
      <div class="btn-group" style="margin-top: 12px;">
        <button class="btn btn-secondary btn-sm" onclick="closeSuggestions()">Close</button>
        <button class="btn btn-primary btn-sm" onclick="refreshSuggestions()">Refresh Suggestions</button>
      </div>
    </div>
    
    <!-- Cross-Sheet Reference Panel -->
    <div id="crossSheetPanel" class="card" style="display: none; margin-bottom: 16px;">
      <div class="card-title">Cross-Sheet References</div>
      <div class="card-description">Reference data from other sheets in your formulas</div>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
        <div>
          <label class="form-label">Source Sheet</label>
          <select id="sourceSheetSelect" class="form-input" onchange="loadSheetRanges()">
            <option value="">Loading sheets...</option>
          </select>
        </div>
        <div>
          <label class="form-label">Data Range</label>
          <select id="rangeSelect" class="form-input" onchange="previewSheetData()">
            <option value="">Select range...</option>
          </select>
        </div>
      </div>
      
      <div style="margin-bottom: 12px;">
        <label class="form-label">Custom Range</label>
        <input type="text" id="customRange" class="form-input" placeholder="e.g., A1:C10" onchange="previewSheetData()">
      </div>
      
      <div id="sheetDataPreview" class="sheet-data-preview" style="display: none;">
        <div class="preview-header">Data Preview</div>
        <div id="previewContent"></div>
        <button class="btn-sm btn-primary" onclick="addSheetReference()">Add Reference</button>
      </div>
    </div>
    
    <!-- Formula Canvas -->
    <div class="card">
      <div class="card-title">Formula Canvas</div>
      <div class="card-description">Drag components here to build your formula</div>
      
      <div id="formulaCanvas" class="formula-canvas" 
           ondrop="handleDrop(event)" 
           ondragover="handleDragOver(event)"
           ondragleave="handleDragLeave(event)">
        <div class="formula-canvas-empty" id="canvasEmpty">
          <div>
            <div style="font-size: 14px; margin-bottom: 8px; width: 32px; height: 32px; background: var(--primary-100); border-radius: 6px; display: flex; align-items: center; justify-content: center; margin: 0 auto 8px; font-weight: 700; color: var(--primary-700);">VF</div>
            Drag components here to start building
          </div>
        </div>
      </div>
      
      <div class="formula-preview" id="formulaPreview">
        <span class="empty">Formula will appear here...</span>
      </div>
      
      <div class="btn-group">
        <button class="btn btn-secondary" onclick="testFormula()">Test Formula</button>
        <button class="btn btn-primary" onclick="insertFormula()">Insert to Cell</button>
      </div>
    </div>
    
    <!-- Component Palette -->
    <div class="collapsible-section">
      <div class="collapsible-header active" onclick="toggleSection(this)">
        Functions
        <span class="collapsible-arrow">▼</span>
      </div>
      <div class="collapsible-content active">
        <div class="component-section">
          <div class="component-section-title">Math Functions</div>
          <div class="component-palette">
            <div class="draggable-component" draggable="true" 
                 data-type="function" data-value="SUM" 
                 ondragstart="handleDragStart(event)">
              <div class="component-icon">Σ</div>
              <div class="component-label">SUM</div>
            </div>
            <div class="draggable-component" draggable="true" 
                 data-type="function" data-value="AVERAGE" 
                 ondragstart="handleDragStart(event)">
              <div class="component-icon">μ</div>
              <div class="component-label">AVERAGE</div>
            </div>
            <div class="draggable-component" draggable="true" 
                 data-type="function" data-value="COUNT" 
                 ondragstart="handleDragStart(event)">
              <div class="component-icon">#</div>
              <div class="component-label">COUNT</div>
            </div>
            <div class="draggable-component" draggable="true" 
                 data-type="function" data-value="MAX" 
                 ondragstart="handleDragStart(event)">
              <div class="component-icon">↑</div>
              <div class="component-label">MAX</div>
            </div>
            <div class="draggable-component" draggable="true" 
                 data-type="function" data-value="MIN" 
                 ondragstart="handleDragStart(event)">
              <div class="component-icon">↓</div>
              <div class="component-label">MIN</div>
            </div>
            <div class="draggable-component" draggable="true" 
                 data-type="function" data-value="ROUND" 
                 ondragstart="handleDragStart(event)">
              <div class="component-icon">⟲</div>
              <div class="component-label">ROUND</div>
            </div>
          </div>
        </div>
        
        <div class="component-section">
          <div class="component-section-title">Logical Functions</div>
          <div class="component-palette">
            <div class="draggable-component" draggable="true" 
                 data-type="function" data-value="IF" 
                 ondragstart="handleDragStart(event)">
              <div class="component-icon">?</div>
              <div class="component-label">IF</div>
            </div>
            <div class="draggable-component" draggable="true" 
                 data-type="function" data-value="AND" 
                 ondragstart="handleDragStart(event)">
              <div class="component-icon">&</div>
              <div class="component-label">AND</div>
            </div>
            <div class="draggable-component" draggable="true" 
                 data-type="function" data-value="OR" 
                 ondragstart="handleDragStart(event)">
              <div class="component-icon">|</div>
              <div class="component-label">OR</div>
            </div>
            <div class="draggable-component" draggable="true" 
                 data-type="function" data-value="NOT" 
                 ondragstart="handleDragStart(event)">
              <div class="component-icon">!</div>
              <div class="component-label">NOT</div>
            </div>
          </div>
        </div>
        
        <div class="component-section">
          <div class="component-section-title">Lookup Functions</div>
          <div class="component-palette">
            <div class="draggable-component" draggable="true" 
                 data-type="function" data-value="VLOOKUP" 
                 ondragstart="handleDragStart(event)">
              <div class="component-icon" style="background: var(--gray-100); color: var(--gray-700); font-weight: 700; font-size: 12px;">LU</div>
              <div class="component-label">VLOOKUP</div>
            </div>
            <div class="draggable-component" draggable="true" 
                 data-type="function" data-value="INDEX" 
                 ondragstart="handleDragStart(event)">
              <div class="component-icon">📍</div>
              <div class="component-label">INDEX</div>
            </div>
            <div class="draggable-component" draggable="true" 
                 data-type="function" data-value="MATCH" 
                 ondragstart="handleDragStart(event)">
              <div class="component-icon">🎯</div>
              <div class="component-label">MATCH</div>
            </div>
            <div class="draggable-component" draggable="true" 
                 data-type="function" data-value="FILTER" 
                 ondragstart="handleDragStart(event)">
              <div class="component-icon">⧩</div>
              <div class="component-label">FILTER</div>
            </div>
          </div>
        </div>
        
        <div class="component-section">
          <div class="component-section-title">Conditional Functions</div>
          <div class="component-palette">
            <div class="draggable-component" draggable="true" 
                 data-type="function" data-value="SUMIF" 
                 ondragstart="handleDragStart(event)">
              <div class="component-icon">Σ?</div>
              <div class="component-label">SUMIF</div>
            </div>
            <div class="draggable-component" draggable="true" 
                 data-type="function" data-value="COUNTIF" 
                 ondragstart="handleDragStart(event)">
              <div class="component-icon">#?</div>
              <div class="component-label">COUNTIF</div>
            </div>
            <div class="draggable-component" draggable="true" 
                 data-type="function" data-value="AVERAGEIF" 
                 ondragstart="handleDragStart(event)">
              <div class="component-icon">μ?</div>
              <div class="component-label">AVERAGEIF</div>
            </div>
            <div class="draggable-component" draggable="true" 
                 data-type="function" data-value="IFS" 
                 ondragstart="handleDragStart(event)">
              <div class="component-icon">??</div>
              <div class="component-label">IFS</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Operators -->
    <div class="collapsible-section">
      <div class="collapsible-header" onclick="toggleSection(this)">
        Operators & Values
        <span class="collapsible-arrow">▼</span>
      </div>
      <div class="collapsible-content">
        <div class="component-section">
          <div class="component-section-title">Operators</div>
          <div class="component-palette">
            <div class="draggable-component" draggable="true" 
                 data-type="operator" data-value="+" 
                 ondragstart="handleDragStart(event)">
              <div class="component-icon">+</div>
              <div class="component-label">Add</div>
            </div>
            <div class="draggable-component" draggable="true" 
                 data-type="operator" data-value="-" 
                 ondragstart="handleDragStart(event)">
              <div class="component-icon">-</div>
              <div class="component-label">Subtract</div>
            </div>
            <div class="draggable-component" draggable="true" 
                 data-type="operator" data-value="*" 
                 ondragstart="handleDragStart(event)">
              <div class="component-icon">×</div>
              <div class="component-label">Multiply</div>
            </div>
            <div class="draggable-component" draggable="true" 
                 data-type="operator" data-value="/" 
                 ondragstart="handleDragStart(event)">
              <div class="component-icon">÷</div>
              <div class="component-label">Divide</div>
            </div>
            <div class="draggable-component" draggable="true" 
                 data-type="operator" data-value="=" 
                 ondragstart="handleDragStart(event)">
              <div class="component-icon">=</div>
              <div class="component-label">Equals</div>
            </div>
            <div class="draggable-component" draggable="true" 
                 data-type="operator" data-value=">" 
                 ondragstart="handleDragStart(event)">
              <div class="component-icon">></div>
              <div class="component-label">Greater</div>
            </div>
          </div>
        </div>
        
        <div class="component-section">
          <div class="component-section-title">Range Selectors</div>
          <div class="component-palette">
            <div class="draggable-component" draggable="true" 
                 data-type="range" data-value="A:A" 
                 ondragstart="handleDragStart(event)">
              <div class="component-icon">↕</div>
              <div class="component-label">Column</div>
            </div>
            <div class="draggable-component" draggable="true" 
                 data-type="range" data-value="1:1" 
                 ondragstart="handleDragStart(event)">
              <div class="component-icon">↔</div>
              <div class="component-label">Row</div>
            </div>
            <div class="draggable-component" draggable="true" 
                 data-type="range" data-value="A1:B10" 
                 ondragstart="handleDragStart(event)">
              <div class="component-icon">▦</div>
              <div class="component-label">Range</div>
            </div>
            <div class="draggable-component" draggable="true" 
                 data-type="range" data-value="Sheet!" 
                 ondragstart="handleDragStart(event)">
              <div class="component-icon">📄</div>
              <div class="component-label">Sheet Ref</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    let formulaElements = [];
    let draggedElement = null;
    
    function backToMain() {
      google.script.run.showCellPilotSidebar();
    }
    
    function handleDragStart(e) {
      draggedElement = {
        type: e.target.dataset.type,
        value: e.target.dataset.value
      };
      e.target.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'copy';
    }
    
    function handleDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'copy';
      document.getElementById('formulaCanvas').classList.add('drag-over');
    }
    
    function handleDragLeave(e) {
      if (e.target === document.getElementById('formulaCanvas')) {
        document.getElementById('formulaCanvas').classList.remove('drag-over');
      }
    }
    
    function handleDrop(e) {
      e.preventDefault();
      document.getElementById('formulaCanvas').classList.remove('drag-over');
      
      if (draggedElement) {
        addFormulaElement(draggedElement);
        updateFormulaDisplay();
      }
      
      // Reset dragging state
      document.querySelectorAll('.dragging').forEach(el => {
        el.classList.remove('dragging');
      });
      draggedElement = null;
    }
    
    function addFormulaElement(element) {
      formulaElements.push(element);
      
      // Hide empty state
      document.getElementById('canvasEmpty').style.display = 'none';
      
      // Create visual element
      const elementDiv = document.createElement('div');
      elementDiv.className = `formula-element ${element.type}`;
      elementDiv.innerHTML = `
        <span class="element-type">${element.type}</span>
        <span class="element-content">${getElementDisplay(element)}</span>
        <span class="element-remove" onclick="removeElement(${formulaElements.length - 1})">×</span>
      `;
      
      document.getElementById('formulaCanvas').appendChild(elementDiv);
    }
    
    function getElementDisplay(element) {
      if (element.type === 'function') {
        return `${element.value}(${getParameterInputs(element.value)})`;
      } else if (element.type === 'range') {
        return `<input class="parameter-input" type="text" value="${element.value}" onchange="updateParameter(this)">`;
      } else {
        return element.value;
      }
    }
    
    function getParameterInputs(func) {
      const paramCounts = {
        'SUM': 1,
        'AVERAGE': 1,
        'COUNT': 1,
        'MAX': 1,
        'MIN': 1,
        'IF': 3,
        'VLOOKUP': 4,
        'SUMIF': 3,
        'COUNTIF': 2,
        'ROUND': 2
      };
      
      const count = paramCounts[func] || 1;
      let inputs = [];
      for (let i = 0; i < count; i++) {
        inputs.push(`<input class="parameter-input" type="text" placeholder="param${i+1}" onchange="updateParameter(this)">`);
      }
      return inputs.join(', ');
    }
    
    function removeElement(index) {
      formulaElements.splice(index, 1);
      rebuildCanvas();
      updateFormulaDisplay();
    }
    
    function rebuildCanvas() {
      const canvas = document.getElementById('formulaCanvas');
      canvas.innerHTML = '';
      
      if (formulaElements.length === 0) {
        canvas.innerHTML = `
          <div class="formula-canvas-empty" id="canvasEmpty">
            <div>
              <div style="font-size: 14px; margin-bottom: 8px; width: 32px; height: 32px; background: var(--primary-100); border-radius: 6px; display: flex; align-items: center; justify-content: center; margin: 0 auto 8px; font-weight: 700; color: var(--primary-700);">VF</div>
              Drag components here to start building
            </div>
          </div>
        `;
      } else {
        formulaElements.forEach((element, index) => {
          const elementDiv = document.createElement('div');
          elementDiv.className = `formula-element ${element.type}`;
          elementDiv.innerHTML = `
            <span class="element-type">${element.type}</span>
            <span class="element-content">${getElementDisplay(element)}</span>
            <span class="element-remove" onclick="removeElement(${index})">×</span>
          `;
          canvas.appendChild(elementDiv);
        });
      }
    }
    
    function updateFormulaDisplay() {
      const preview = document.getElementById('formulaPreview');
      
      if (formulaElements.length === 0) {
        preview.innerHTML = '<span class="empty">Formula will appear here...</span>';
        return;
      }
      
      // Build formula string
      let formula = '=';
      formulaElements.forEach((element, index) => {
        if (element.type === 'function') {
          formula += element.value + '(';
          // Get actual parameter values from inputs
          const inputs = document.querySelectorAll('.formula-element')[index]?.querySelectorAll('.parameter-input');
          if (inputs) {
            const params = Array.from(inputs).map(input => input.value || 'range').join(', ');
            formula += params;
          }
          formula += ')';
        } else if (element.type === 'operator') {
          formula += ' ' + element.value + ' ';
        } else if (element.type === 'range') {
          const input = document.querySelectorAll('.formula-element')[index]?.querySelector('.parameter-input');
          formula += input?.value || element.value;
        } else {
          formula += element.value;
        }
      });
      
      preview.textContent = formula;
      preview.classList.remove('empty', 'error');
    }
    
    function updateParameter(input) {
      updateFormulaDisplay();
    }
    
    function clearCanvas() {
      formulaElements = [];
      rebuildCanvas();
      updateFormulaDisplay();
    }
    
    function toggleSection(header) {
      header.classList.toggle('active');
      header.nextElementSibling.classList.toggle('active');
    }
    
    function suggestFormula() {
      google.script.run
        .withSuccessHandler(function(suggestion) {
          if (suggestion) {
            showStatus('Suggested formula: ' + suggestion, 'info');
          }
        })
        .withFailureHandler(function(error) {
          showStatus('Failed to get suggestion: ' + error, 'error');
        })
        .suggestFormulaBasedOnData();
    }
    
    function validateFormula() {
      const formula = document.getElementById('formulaPreview').textContent;
      if (!formula || formula === 'Formula will appear here...') {
        showStatus('No formula to validate', 'warning');
        return;
      }
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.valid) {
            showStatus('Formula is valid!', 'success');
          } else {
            showStatus('Formula has issues: ' + result.issues.join(', '), 'error');
          }
        })
        .withFailureHandler(function(error) {
          showStatus('Validation failed: ' + error, 'error');
        })
        .validateVisualFormula(formula);
    }
    
    function optimizeFormula() {
      const formula = document.getElementById('formulaPreview').textContent;
      if (!formula || formula === 'Formula will appear here...') {
        showStatus('No formula to optimize', 'warning');
        return;
      }
      
      google.script.run
        .withSuccessHandler(function(optimized) {
          if (optimized) {
            document.getElementById('formulaPreview').textContent = optimized;
            showStatus('Formula optimized!', 'success');
          }
        })
        .withFailureHandler(function(error) {
          showStatus('Optimization failed: ' + error, 'error');
        })
        .optimizeVisualFormula(formula);
    }
    
    function testFormula() {
      const formula = document.getElementById('formulaPreview').textContent;
      if (!formula || formula === 'Formula will appear here...') {
        showStatus('No formula to test', 'warning');
        return;
      }
      
      google.script.run
        .withSuccessHandler(function(result) {
          showStatus('Test result: ' + result, 'info');
        })
        .withFailureHandler(function(error) {
          showStatus('Test failed: ' + error, 'error');
        })
        .testVisualFormula(formula);
    }
    
    function insertFormula() {
      const formula = document.getElementById('formulaPreview').textContent;
      if (!formula || formula === 'Formula will appear here...') {
        showStatus('No formula to insert', 'warning');
        return;
      }
      
      google.script.run
        .withSuccessHandler(function(result) {
          showStatus('Formula inserted into cell ' + result.cell, 'success');
          setTimeout(function() {
            backToMain();
          }, 2000);
        })
        .withFailureHandler(function(error) {
          showStatus('Insert failed: ' + error, 'error');
        })
        .insertVisualFormula(formula);
    }
    
    function showStatus(message, type) {
      const statusDiv = document.getElementById('statusMessage');
      statusDiv.className = 'alert alert-' + type;
      statusDiv.textContent = message;
      statusDiv.style.display = 'block';
      
      if (type === 'success') {
        setTimeout(function() {
          statusDiv.style.display = 'none';
        }, 3000);
      }
    }
    
    // Cross-Sheet Functionality
    let crossSheetMode = false;
    let availableSheets = [];
    
    function toggleCrossSheetMode() {
      crossSheetMode = !crossSheetMode;
      const panel = document.getElementById('crossSheetPanel');
      const btn = document.getElementById('crossSheetBtn');
      const container = document.querySelector('.container');
      
      if (crossSheetMode) {
        panel.style.display = 'block';
        btn.textContent = 'Exit Cross-Sheet';
        container.classList.add('cross-sheet-mode');
        loadAvailableSheets();
      } else {
        panel.style.display = 'none';
        btn.textContent = 'Cross-Sheet Mode';
        container.classList.remove('cross-sheet-mode');
      }
    }
    
    function loadAvailableSheets() {
      showStatus('Loading sheets...', 'info');
      
      google.script.run
        .withSuccessHandler(function(sheets) {
          availableSheets = sheets;
          const select = document.getElementById('sourceSheetSelect');
          select.innerHTML = '<option value="">Select a sheet...</option>';
          
          sheets.forEach(function(sheet) {
            const option = document.createElement('option');
            option.value = sheet.name;
            option.textContent = sheet.name + ' (' + sheet.rowCount + ' rows)';
            select.appendChild(option);
          });
          
          showStatus('Sheets loaded', 'success');
        })
        .withFailureHandler(function(error) {
          showStatus('Failed to load sheets: ' + error, 'error');
        })
        .getCrossSheetInfo();
    }
    
    function loadSheetRanges() {
      const sheetName = document.getElementById('sourceSheetSelect').value;
      const rangeSelect = document.getElementById('rangeSelect');
      
      if (!sheetName) {
        rangeSelect.innerHTML = '<option value="">Select range...</option>';
        return;
      }
      
      const sheet = availableSheets.find(s => s.name === sheetName);
      if (!sheet) return;
      
      rangeSelect.innerHTML = '<option value="">Select range...</option>';
      
      // Add common range options
      const ranges = [
        { label: 'All Data', value: sheet.dataRange },
        { label: 'Headers Only', value: 'A1:' + sheet.lastColumn + '1' },
        { label: 'First Column', value: 'A:A' },
        { label: 'First 10 Rows', value: 'A1:' + sheet.lastColumn + '10' }
      ];
      
      ranges.forEach(function(range) {
        const option = document.createElement('option');
        option.value = range.value;
        option.textContent = range.label + ' (' + range.value + ')';
        rangeSelect.appendChild(option);
      });
    }
    
    function previewSheetData() {
      const sheetName = document.getElementById('sourceSheetSelect').value;
      const range = document.getElementById('rangeSelect').value || 
                   document.getElementById('customRange').value;
      
      if (!sheetName || !range) {
        document.getElementById('sheetDataPreview').style.display = 'none';
        return;
      }
      
      showStatus('Loading preview...', 'info');
      
      google.script.run
        .withSuccessHandler(function(data) {
          if (data.success) {
            displayPreviewData(data.preview, sheetName, range);
            showStatus('Preview loaded', 'success');
          } else {
            showStatus('Preview failed: ' + data.error, 'error');
          }
        })
        .withFailureHandler(function(error) {
          showStatus('Preview error: ' + error, 'error');
        })
        .previewSheetRange(sheetName, range);
    }
    
    function displayPreviewData(previewData, sheetName, range) {
      const previewDiv = document.getElementById('sheetDataPreview');
      const contentDiv = document.getElementById('previewContent');
      
      if (!previewData || previewData.length === 0) {
        contentDiv.innerHTML = '<p style="color: var(--gray-500); font-size: 12px;">No data found in range</p>';
        previewDiv.style.display = 'block';
        return;
      }
      
      let tableHtml = '<table class="preview-table">';
      
      previewData.slice(0, 6).forEach(function(row, rowIndex) {
        tableHtml += '<tr>';
        row.slice(0, 4).forEach(function(cell, colIndex) {
          const tag = rowIndex === 0 ? 'th' : 'td';
          const value = cell === null || cell === undefined ? '' : String(cell);
          const truncated = value.length > 20 ? value.substring(0, 17) + '...' : value;
          tableHtml += '<' + tag + '>' + truncated + '</' + tag + '>';
        });
        if (row.length > 4) {
          tableHtml += '<td>...</td>';
        }
        tableHtml += '</tr>';
      });
      
      if (previewData.length > 6) {
        tableHtml += '<tr><td colspan="5" style="text-align: center; color: var(--gray-500);">... and ' + (previewData.length - 6) + ' more rows</td></tr>';
      }
      
      tableHtml += '</table>';
      
      contentDiv.innerHTML = tableHtml + 
        '<p style="font-size: 11px; color: var(--gray-600); margin-top: 8px;">' +
        'Reference: ' + sheetName + '!' + range + '</p>';
      
      previewDiv.style.display = 'block';
    }
    
    function addSheetReference() {
      const sheetName = document.getElementById('sourceSheetSelect').value;
      const range = document.getElementById('rangeSelect').value || 
                   document.getElementById('customRange').value;
      
      if (!sheetName || !range) {
        showStatus('Please select a sheet and range', 'error');
        return;
      }
      
      const reference = sheetName + '!' + range;
      
      // Create a draggable component for the sheet reference
      const component = document.createElement('div');
      component.className = 'draggable-component cross-sheet-reference';
      component.draggable = true;
      component.setAttribute('data-type', 'sheet-reference');
      component.setAttribute('data-value', reference);
      component.setAttribute('ondragstart', 'handleDragStart(event)');
      
      component.innerHTML = 
        '<div class="component-icon" style="background: var(--primary-100); color: var(--primary-700); font-weight: 700; font-size: 12px;">MA</div>' +
        '<div class="component-label">' + reference + '</div>';
      
      // Add to canvas or palette
      const canvas = document.getElementById('formulaCanvas');
      const isEmpty = canvas.querySelector('.formula-canvas-empty');
      
      if (isEmpty) {
        canvas.removeChild(isEmpty);
      }
      
      canvas.appendChild(component);
      updateFormulaDisplay();
      
      showStatus('Sheet reference added to canvas', 'success');
    }
    
    // Smart Suggestions Functionality
    function showSmartSuggestions() {
      const panel = document.getElementById('smartSuggestionsPanel');
      panel.style.display = 'block';
      loadSmartSuggestions();
    }
    
    function closeSuggestions() {
      const panel = document.getElementById('smartSuggestionsPanel');
      panel.style.display = 'none';
    }
    
    function refreshSuggestions() {
      loadSmartSuggestions();
    }
    
    function loadSmartSuggestions() {
      const suggestionsDiv = document.getElementById('suggestionsList');
      const analysisDiv = document.getElementById('dataAnalysis');
      
      suggestionsDiv.innerHTML = '<div class="suggestion-loading">Analyzing your data...</div>';
      analysisDiv.style.display = 'none';
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            displaySmartSuggestions(result.suggestions, result.analysis, result.context);
          } else {
            suggestionsDiv.innerHTML = 
              '<div class="suggestion-loading" style="color: var(--gray-600);">' + 
              (result.message || result.error || 'No suggestions available') + 
              '</div>';
          }
        })
        .withFailureHandler(function(error) {
          suggestionsDiv.innerHTML = 
            '<div class="suggestion-loading" style="color: var(--error-600);">Error loading suggestions: ' + error + '</div>';
        })
        .getSmartFormulaSuggestions();
    }
    
    function displaySmartSuggestions(suggestions, analysis, context) {
      const suggestionsDiv = document.getElementById('suggestionsList');
      const analysisDiv = document.getElementById('dataAnalysis');
      const analysisContent = document.getElementById('analysisContent');
      
      // Show data analysis
      if (analysis && context) {
        let analysisHtml = '';
        
        analysisHtml += '<div class="analysis-item"><strong>Selection:</strong> ' + context.range + ' (' + context.rowCount + '×' + context.columnCount + ')</div>';
        
        if (context.hasHeaders) {
          analysisHtml += '<div class="analysis-item"><strong>Headers:</strong> ' + context.headers.join(', ') + '</div>';
        }
        
        if (analysis.hasNumbers) {
          analysisHtml += '<div class="analysis-item"><strong>Contains:</strong> Numeric data</div>';
        }
        
        if (analysis.hasCurrency) {
          analysisHtml += '<div class="analysis-item"><strong>Contains:</strong> Currency values</div>';
        }
        
        if (analysis.hasDates) {
          analysisHtml += '<div class="analysis-item"><strong>Contains:</strong> Date values</div>';
        }
        
        if (analysis.patterns && analysis.patterns.length > 0) {
          analysisHtml += '<div class="analysis-item"><strong>Patterns:</strong> ' + analysis.patterns.join(', ').replace(/_/g, ' ') + '</div>';
        }
        
        analysisContent.innerHTML = analysisHtml;
        analysisDiv.style.display = 'block';
      }
      
      // Show suggestions
      if (!suggestions || suggestions.length === 0) {
        suggestionsDiv.innerHTML = '<div class="suggestion-loading">No suggestions available for the selected data.</div>';
        return;
      }
      
      let suggestionsHtml = '';
      
      suggestions.forEach(function(suggestion, index) {
        const confidenceClass = getConfidenceClass(suggestion.confidence);
        const itemClass = getItemConfidenceClass(suggestion.confidence);
        
        suggestionsHtml += `
          <div class="suggestion-item ${itemClass}" onclick="applySuggestion('${suggestion.formula}')">
            <div class="suggestion-content">
              <div class="suggestion-formula">${suggestion.formula}</div>
              <div class="suggestion-description">${suggestion.description}</div>
              <div class="suggestion-meta">
                <span class="suggestion-category">${suggestion.category}</span>
                <span class="confidence-badge ${confidenceClass}">${Math.round(suggestion.confidence * 100)}% match</span>
              </div>
            </div>
          </div>
        `;
      });
      
      suggestionsDiv.innerHTML = suggestionsHtml;
    }
    
    function getConfidenceClass(confidence) {
      if (confidence >= 0.8) return 'confidence-high';
      if (confidence >= 0.6) return 'confidence-medium';
      return 'confidence-low';
    }
    
    function getItemConfidenceClass(confidence) {
      if (confidence >= 0.8) return 'high-confidence';
      if (confidence >= 0.6) return 'medium-confidence';
      return '';
    }
    
    function applySuggestion(formula) {
      // Add the formula to the canvas
      const canvas = document.getElementById('formulaCanvas');
      const isEmpty = canvas.querySelector('.formula-canvas-empty');
      
      if (isEmpty) {
        canvas.removeChild(isEmpty);
      }
      
      // Create a formula component
      const component = document.createElement('div');
      component.className = 'draggable-component';
      component.setAttribute('data-type', 'formula');
      component.setAttribute('data-value', formula);
      
      component.innerHTML = 
        '<div class="component-icon" style="background: var(--warning-100); color: var(--warning-700); font-weight: 700; font-size: 12px;">TX</div>' +
        '<div class="component-label">Smart: ' + formula + '</div>';
      
      canvas.appendChild(component);
      updateFormulaDisplay();
      
      // Close suggestions panel
      closeSuggestions();
      
      showStatus('Smart suggestion applied to canvas', 'success');
    }
  </script>
</body>
</html>