<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <?!= include('SharedStyles'); ?>
  <style>
    /* Industry template grid - 3x2 layout */
    .industry-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
      margin-bottom: 20px;
      padding: 6px;
      background: var(--gray-50);
      border-radius: 10px;
    }
    
    .industry-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 8px 4px;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      background: white;
      color: var(--gray-600);
      font-size: 10px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      min-height: 50px;
      text-align: center;
    }
    
    .industry-btn:hover {
      border-color: var(--primary-300);
      background: var(--gray-50);
      transform: translateY(-1px);
    }
    
    .industry-btn.active {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(99, 102, 241, 0.05));
      border-color: var(--primary-500);
      color: var(--primary-700);
    }
    
    .industry-icon {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 9px;
      font-weight: 700;
      margin-bottom: 2px;
      background: var(--gray-100);
      color: var(--gray-600);
    }
    
    .industry-btn.active .industry-icon {
      background: var(--primary-500);
      color: white;
    }
    
    .industry-label {
      font-size: 9px;
      line-height: 1.2;
    }
    
    /* Ensure feature cards don't cause horizontal scroll */
    .feature-card {
      max-width: 100%;
      word-wrap: break-word;
      cursor: pointer;
      transition: all 0.2s ease;
      padding: 16px;
      border: 2px solid var(--gray-200);
      border-radius: 12px;
      background: white;
      margin-bottom: 12px;
    }
    
    .feature-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
      border-color: var(--primary-300);
    }
    
    .feature-title {
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 6px;
      color: var(--gray-900);
    }
    
    .feature-description {
      font-size: 12px;
      color: var(--gray-600);
      margin-bottom: 8px;
      line-height: 1.4;
    }
    
    .feature-benefits {
      font-size: 11px;
      color: var(--primary-600);
      font-weight: 600;
      margin-bottom: 12px;
    }
    
    .template-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }
    
    .btn-preview {
      flex: 1;
      padding: 8px 12px;
      background: var(--gray-100);
      color: var(--gray-700);
      border: 1px solid var(--gray-300);
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .btn-preview:hover {
      background: var(--gray-200);
      border-color: var(--gray-400);
    }
    
    .btn-apply {
      flex: 2;
      padding: 8px 12px;
      background: var(--primary-600);
      color: white;
      border: 1px solid var(--primary-600);
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .btn-apply:hover {
      background: var(--primary-700);
      border-color: var(--primary-700);
    }
    
    .feature-grid {
      display: block;
    }
    
    .template-item {
      max-width: 100%;
      overflow: hidden;
    }
  </style>
</head>
<body>
  <div class="nav-header">
    <button class="nav-back" onclick="backToMain()">←</button>
    <div class="nav-title">
      <h2>Industry Templates</h2>
      <p>Pre-built solutions saving 15-25 hours weekly</p>
    </div>
  </div>
  
  <div class="container">
    <div id="statusMessage" style="display: none;"></div>
    
    <!-- Industry Categories Grid -->
    <div class="industry-grid">
      <button class="industry-btn active" onclick="switchCategory('real-estate')">
        <div class="industry-icon">RE</div>
        <div class="industry-label">Real Estate</div>
      </button>
      <button class="industry-btn" onclick="switchCategory('construction')">
        <div class="industry-icon">CO</div>
        <div class="industry-label">Construction</div>
      </button>
      <button class="industry-btn" onclick="switchCategory('healthcare')">
        <div class="industry-icon">HC</div>
        <div class="industry-label">Healthcare</div>
      </button>
      <button class="industry-btn" onclick="switchCategory('marketing')">
        <div class="industry-icon">MK</div>
        <div class="industry-label">Marketing</div>
      </button>
      <button class="industry-btn" onclick="switchCategory('ecommerce')">
        <div class="industry-icon">EC</div>
        <div class="industry-label">E-Commerce</div>
      </button>
      <button class="industry-btn" onclick="switchCategory('consulting')">
        <div class="industry-icon">CS</div>
        <div class="industry-label">Consulting</div>
      </button>
    </div>
    
    <!-- Real Estate Templates -->
    <div id="real-estate" class="category-content">
      <div class="feature-grid">
        <div class="feature-card">
          <div class="feature-title">Commission Tracker & Client Pipeline</div>
          <div class="feature-description">Complete real estate business management with commission tracking, client pipeline management, and performance analytics. Includes automated commission splits, closing timeline tracking, and lead conversion analysis.</div>
          <div class="feature-benefits">✓ Saves 8+ hours weekly ✓ Track 25% more deals ✓ Automate commission calculations</div>
          <div class="template-actions">
            <button class="btn-preview" onclick="previewTemplate('commission-tracker')">Preview</button>
            <button class="btn-apply" onclick="applyTemplate('commission-tracker')">Apply Template</button>
          </div>
        </div>
        
        <div class="feature-card">
          <div class="feature-title">Property Management Suite</div>
          <div class="feature-description">End-to-end property management system with rent collection tracking, maintenance scheduling, tenant management, and financial reporting. Perfect for landlords and property management companies.</div>
          <div class="feature-benefits">✓ Saves 12+ hours weekly ✓ Zero missed rent payments ✓ Automated maintenance alerts</div>
          <div class="template-actions">
            <button class="btn-preview" onclick="previewTemplate('property-manager')">Preview</button>
            <button class="btn-apply" onclick="applyTemplate('property-manager')">Apply Template</button>
          </div>
        </div>
        
        <div class="feature-card">
          <div class="feature-title">Investment Analysis Dashboard</div>
          <div class="feature-description">Professional investment property analysis with cash flow projections, cap rate calculations, ROI analysis, and comparative market analysis tools. Make data-driven investment decisions.</div>
          <div class="feature-benefits">✓ 7%+ better returns ✓ Risk analysis tools ✓ Market comparison features</div>
          <div class="template-actions">
            <button class="btn-preview" onclick="previewTemplate('investment-analyzer')">Preview</button>
            <button class="btn-apply" onclick="applyTemplate('investment-analyzer')">Apply Template</button>
          </div>
        </div>
        
        <div class="feature-card">
          <div class="feature-title">Lead Management & CRM</div>
          <div class="feature-description">Comprehensive lead tracking system with follow-up scheduling, lead scoring, conversion tracking, and automated nurture campaigns. Turn more leads into closed deals.</div>
          <div class="feature-benefits">✓ 25% more conversions ✓ Automated follow-ups ✓ Lead scoring system</div>
          <div class="template-actions">
            <button class="btn-preview" onclick="previewTemplate('lead-pipeline')">Preview</button>
            <button class="btn-apply" onclick="applyTemplate('lead-pipeline')">Apply Template</button>
          </div>
        </div>
      </div>
      
      <div class="card mt-3">
        <div class="card-title">What's Included</div>
        <ul style="margin-top: 12px; color: var(--gray-700);">
          <li>Automated commission calculations with split tracking</li>
          <li>MLS data integration formulas</li>
          <li>Client follow-up scheduling</li>
          <li>Property cash flow analysis</li>
          <li>Tax deduction tracking</li>
        </ul>
      </div>
    </div>
    
    <!-- Construction Templates -->
    <div id="construction" class="category-content" style="display: none;">
      <div class="feature-grid">
        <div class="feature-card">
          <div class="feature-title">Master Construction Estimator</div>
          <div class="feature-description">Professional construction project estimating system with material waste tracking, labor productivity analysis, subcontractor management, and comprehensive project dashboard with real-time alerts.</div>
          <div class="feature-benefits">✓ Save 20+ hours per project ✓ 15-20% waste reduction ✓ Real-time budget alerts</div>
          <div class="template-actions">
            <button class="btn-preview" onclick="previewTemplate('cost-estimator')">Preview</button>
            <button class="btn-apply" onclick="applyTemplate('cost-estimator')">Apply Template</button>
          </div>
        </div>
        
        <div class="feature-card">
          <div class="feature-title">Material & Inventory Manager</div>
          <div class="feature-description">Advanced material tracking system with supplier management, purchase order automation, delivery scheduling, and comprehensive waste analysis. Includes automated reorder points.</div>
          <div class="feature-benefits">✓ Reduce material waste 15-20% ✓ Automate purchase orders ✓ Track supplier performance</div>
          <div class="template-actions">
            <button class="btn-preview" onclick="previewTemplate('material-tracker')">Preview</button>
            <button class="btn-apply" onclick="applyTemplate('material-tracker')">Apply Template</button>
          </div>
        </div>
        
        <div class="feature-card">
          <div class="feature-title">Labor Productivity Suite</div>
          <div class="feature-description">Complete labor management system with time tracking, productivity analysis, payroll integration, and safety compliance monitoring. Includes overtime calculations and performance benchmarking.</div>
          <div class="feature-benefits">✓ Track labor productivity ✓ Automate payroll calculations ✓ Monitor safety compliance</div>
          <div class="template-actions">
            <button class="btn-preview" onclick="previewTemplate('labor-manager')">Preview</button>
            <button class="btn-apply" onclick="applyTemplate('labor-manager')">Apply Template</button>
          </div>
        </div>
        
        <div class="feature-card">
          <div class="feature-title">Change Order Management</div>
          <div class="feature-description">Professional change order tracking system with cost impact analysis, schedule adjustment calculations, approval workflows, and comprehensive reporting. Control scope creep effectively.</div>
          <div class="feature-benefits">✓ Control scope creep ✓ Track cost impacts ✓ Streamline approvals</div>
          <div class="template-actions">
            <button class="btn-preview" onclick="previewTemplate('change-orders')">Preview</button>
            <button class="btn-apply" onclick="applyTemplate('change-orders')">Apply Template</button>
          </div>
        </div>
      </div>
      
      <div class="card mt-3" style="background: var(--primary-50); border: 1px solid var(--primary-200);">
        <div class="card-title" style="color: var(--primary-700); font-size: 13px;">Construction Features</div>
        <div style="margin-top: 8px; font-size: 11px; color: var(--primary-600); line-height: 1.6;">
          <div>✓ Advanced cost estimation formulas</div>
          <div>✓ 10-15% contingency planning</div>
          <div>✓ Material waste tracking system</div>
          <div>✓ Resource allocation optimization</div>
          <div>✓ Safety compliance monitoring</div>
        </div>
      </div>
    </div>
    
    <!-- Healthcare Templates -->
    <div id="healthcare" class="category-content" style="display: none;">
      <div class="feature-grid">
        <div class="feature-card">
          <div class="feature-title">Advanced Billing Suite</div>
          <div class="feature-description">Complete revenue cycle management with automated denial handling, appeal tracking, and insurance verification workflows for healthcare practices</div>
          <div class="template-actions">
            <button class="btn-preview" onclick="previewTemplate('insurance-verifier')">Preview</button>
            <button class="btn-apply" onclick="applyTemplate('insurance-verifier')">Apply Template</button>
          </div>
        </div>
        
        <div class="feature-card">
          <div class="feature-title">Prior Authorization Manager</div>
          <div class="feature-description">Streamlined prior authorization tracking system with automated workflow management and approval status monitoring</div>
          <div class="template-actions">
            <button class="btn-preview" onclick="previewTemplate('prior-auth-tracker')">Preview</button>
            <button class="btn-apply" onclick="applyTemplate('prior-auth-tracker')">Apply Template</button>
          </div>
        </div>
        
        <div class="feature-card">
          <div class="feature-title">Revenue Dashboard</div>
          <div class="feature-description">Comprehensive KPI tracking with accounts receivable aging, collection metrics, and financial performance analytics</div>
          <div class="template-actions">
            <button class="btn-preview" onclick="previewTemplate('revenue-cycle')">Preview</button>
            <button class="btn-apply" onclick="applyTemplate('revenue-cycle')">Apply Template</button>
          </div>
        </div>
        
        <div class="feature-card">
          <div class="feature-title">Denial Analytics System</div>
          <div class="feature-description">Advanced root cause analysis for claim denials with prevention strategies and trend monitoring to reduce rejection rates</div>
          <div class="template-actions">
            <button class="btn-preview" onclick="previewTemplate('denial-analytics')">Preview</button>
            <button class="btn-apply" onclick="applyTemplate('denial-analytics')">Apply Template</button>
          </div>
        </div>
      </div>
      
      <div class="card mt-3">
        <div class="card-title">What's Included</div>
        <ul style="margin-top: 12px; color: var(--gray-700);">
          <li>HIPAA-compliant data handling templates</li>
          <li>Insurance verification from 12.6 min to 5 sec</li>
          <li>Denial tracking (15% average rate reduction)</li>
          <li>Prior auth workflow automation</li>
          <li>$496 billion in addressable admin costs</li>
        </ul>
      </div>
    </div>
    
    <!-- Marketing Templates -->
    <div id="marketing" class="category-content" style="display: none;">
      <div class="feature-grid">
        <div class="feature-card">
          <div class="feature-title">Multi-Channel Attribution Dashboard</div>
          <div class="feature-description">Comprehensive attribution modeling with funnel analysis, conversion tracking, and return on investment calculations across all marketing channels</div>
          <div class="template-actions">
            <button class="btn-preview" onclick="previewTemplate('campaign-dashboard')">Preview</button>
            <button class="btn-apply" onclick="applyTemplate('campaign-dashboard')">Apply Template</button>
          </div>
        </div>
        
        <div class="feature-card">
          <div class="feature-title">Lead Scoring Engine</div>
          <div class="feature-description">Advanced behavioral and demographic lead scoring system with automated qualification workflows and conversion probability analysis</div>
          <div class="template-actions">
            <button class="btn-preview" onclick="previewTemplate('lead-scoring-system')">Preview</button>
            <button class="btn-apply" onclick="applyTemplate('lead-scoring-system')">Apply Template</button>
          </div>
        </div>
        
        <div class="feature-card">
          <div class="feature-title">Content Performance Analyzer</div>
          <div class="feature-description">Content marketing performance tracker with engagement metrics, conversion analysis, and optimization recommendations</div>
          <div class="template-actions">
            <button class="btn-preview" onclick="previewTemplate('content-performance')">Preview</button>
            <button class="btn-apply" onclick="applyTemplate('content-performance')">Apply Template</button>
          </div>
        </div>
        
        <div class="feature-card">
          <div class="feature-title">Customer Journey Mapper</div>
          <div class="feature-description">Complete touchpoint analysis with attribution modeling and customer journey visualization to optimize conversion paths</div>
          <div class="template-actions">
            <button class="btn-preview" onclick="previewTemplate('customer-journey')">Preview</button>
            <button class="btn-apply" onclick="applyTemplate('customer-journey')">Apply Template</button>
          </div>
        </div>
      </div>
      
      <div class="card mt-3">
        <div class="card-title">What's Included</div>
        <ul style="margin-top: 12px; color: var(--gray-700);">
          <li>Google Analytics + Facebook Ads + Google Ads integration</li>
          <li>Attribution modeling with source tracking</li>
          <li>248% ROI with 6-month payback</li>
          <li>Revenue per client tracking (only 49% do this)</li>
          <li>$360,000 annual savings from automation</li>
        </ul>
      </div>
    </div>
    
    <!-- E-Commerce Templates -->
    <div id="ecommerce" class="category-content" style="display: none;">
      <div class="feature-grid">
        <div class="feature-card">
          <div class="feature-title">Multi-Channel Inventory Manager</div>
          <div class="feature-description">Complete inventory synchronization across Amazon, eBay, Shopify and other marketplaces with automated reorder point management</div>
          <div class="template-actions">
            <button class="btn-preview" onclick="previewTemplate('ecommerce-inventory')">Preview</button>
            <button class="btn-apply" onclick="applyTemplate('ecommerce-inventory')">Apply Template</button>
          </div>
        </div>
        
        <div class="feature-card">
          <div class="feature-title">Product Profitability Analyzer</div>
          <div class="feature-description">Advanced SKU profitability analysis with marketplace fees calculation and ABC classification for inventory optimization</div>
          <div class="template-actions">
            <button class="btn-preview" onclick="previewTemplate('profitability-analyzer')">Preview</button>
            <button class="btn-apply" onclick="applyTemplate('profitability-analyzer')">Apply Template</button>
          </div>
        </div>
        
        <div class="feature-card">
          <div class="feature-title">Sales Forecasting System</div>
          <div class="feature-description">Intelligent sales velocity tracking with seasonal demand prediction and stock level optimization recommendations</div>
          <div class="template-actions">
            <button class="btn-preview" onclick="previewTemplate('sales-forecasting')">Preview</button>
            <button class="btn-apply" onclick="applyTemplate('sales-forecasting')">Apply Template</button>
          </div>
        </div>
      </div>
      
      <div class="card mt-3">
        <div class="card-title">What's Included</div>
        <ul style="margin-top: 12px; color: var(--gray-700);">
          <li>Multi-marketplace inventory sync across 8 platforms</li>
          <li>Automated reorder points with supplier tracking</li>
          <li>SKU profitability analysis with marketplace fees</li>
          <li>Sales velocity forecasting with seasonality</li>
          <li>Returns & refunds tracking by channel</li>
        </ul>
      </div>
    </div>
    
    <!-- Consulting Templates -->
    <div id="consulting" class="category-content" style="display: none;">
      <div class="feature-grid">
        <div class="feature-card">
          <div class="feature-title">Time and Billing Tracker</div>
          <div class="feature-description">Comprehensive billable hours tracking system with automated invoicing workflows and time allocation analysis for consulting practices</div>
          <div class="template-actions">
            <button class="btn-preview" onclick="previewTemplate('time-billing-tracker')">Preview</button>
            <button class="btn-apply" onclick="applyTemplate('time-billing-tracker')">Apply Template</button>
          </div>
        </div>
        
        <div class="feature-card">
          <div class="feature-title">Project Profitability Monitor</div>
          <div class="feature-description">Advanced budget tracking with utilization metrics, performance analysis, and profit margin optimization for consulting projects</div>
          <div class="template-actions">
            <button class="btn-preview" onclick="previewTemplate('project-profitability')">Preview</button>
            <button class="btn-apply" onclick="applyTemplate('project-profitability')">Apply Template</button>
          </div>
        </div>
        
        <div class="feature-card">
          <div class="feature-title">Client Relationship Dashboard</div>
          <div class="feature-description">Complete client management system with retainer tracking, outstanding balance monitoring, and relationship performance metrics</div>
          <div class="template-actions">
            <button class="btn-preview" onclick="previewTemplate('client-dashboard')">Preview</button>
            <button class="btn-apply" onclick="applyTemplate('client-dashboard')">Apply Template</button>
          </div>
        </div>
      </div>
      
      <div class="card mt-3">
        <div class="card-title">What's Included</div>
        <ul style="margin-top: 12px; color: var(--gray-700);">
          <li>Automated time tracking with billable/non-billable split</li>
          <li>Project budget monitoring with completion tracking</li>
          <li>Utilization rates and consultant performance metrics</li>
          <li>Client billing with retainer and payment tracking</li>
          <li>Profitability analysis by project and consultant</li>
        </ul>
      </div>
    </div>
    
    <!-- Implementation Guide -->
    <div class="card" style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.04), rgba(34, 197, 94, 0.08)); margin-top: 24px;">
      <div class="card-title">Quick Start Guide</div>
      <div class="card-description">Get up and running in minutes</div>
      
      <ol style="margin-top: 16px; padding-left: 20px; color: var(--gray-700);">
        <li style="margin-bottom: 8px;">Select your industry template above</li>
        <li style="margin-bottom: 8px;">Template automatically creates sheets and formulas</li>
        <li style="margin-bottom: 8px;">Customize fields for your business</li>
        <li style="margin-bottom: 8px;">Import existing data (we'll help format it)</li>
        <li style="margin-bottom: 8px;">Start saving 15-25 hours weekly!</li>
      </ol>
      
      <div class="alert alert-success mt-3">
        <strong>ROI Guarantee:</strong> Most businesses see positive ROI within 30 days
      </div>
    </div>
  </div>
  
  <script>
    // Check if a default category was passed and switch to it on load
    <? if (typeof defaultCategory !== 'undefined' && defaultCategory) { ?>
      document.addEventListener('DOMContentLoaded', function() {
        // Hide all categories first
        document.querySelectorAll('.category-content').forEach(content => {
          content.style.display = 'none';
        });
        
        // Show the selected category
        const categoryElement = document.getElementById('<?= defaultCategory ?>');
        if (categoryElement) {
          categoryElement.style.display = 'block';
        }
        
        // Update button states
        document.querySelectorAll('.tab-button').forEach(btn => {
          btn.classList.remove('active');
        });
        
        // Find and activate the corresponding button
        const categoryMap = {
          'real-estate': 0,
          'construction': 1,
          'healthcare': 2,
          'marketing': 3,
          'ecommerce': 3,
          'consulting': 3
        };
        
        const tabIndex = categoryMap['<?= defaultCategory ?>'] || 0;
        const buttons = document.querySelectorAll('.tab-button');
        if (buttons[tabIndex]) {
          buttons[tabIndex].classList.add('active');
        }
      });
    <? } ?>
    
    function backToMain() {
      // Clean up preview sheets before going back
      cleanupPreviews();
      google.script.run.showCellPilotSidebar();
    }
    
    function switchCategory(category) {
      // Clean up any preview sheets when switching categories
      cleanupPreviews();
      
      // Update button states for grid layout
      document.querySelectorAll('.industry-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Find and activate the clicked button
      const clickedBtn = event.target.closest('.industry-btn');
      if (clickedBtn) {
        clickedBtn.classList.add('active');
      }
      
      // Show/hide content
      document.querySelectorAll('.category-content').forEach(content => {
        content.style.display = 'none';
      });
      const categoryEl = document.getElementById(category);
      if (categoryEl) {
        categoryEl.style.display = 'block';
      }
    }
    
    function showStatus(message, type = 'info') {
      const statusDiv = document.getElementById('statusMessage');
      statusDiv.className = 'alert alert-' + type;
      statusDiv.textContent = message;
      statusDiv.style.display = 'flex';
      
      if (type === 'success') {
        setTimeout(() => {
          statusDiv.style.display = 'none';
        }, 5000);
      }
    }
    
    function previewTemplate(templateType) {
      showStatus('Creating preview sheets for ' + templateType.replace(/-/g, ' ') + '...', 'info');
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showStatus('Preview sheets created! Check your spreadsheet tabs for [PREVIEW] sheets.', 'success');
            // Optionally show which sheets were created
            if (result.sheets && result.sheets.length > 0) {
              setTimeout(() => {
                showStatus('Created preview sheets: ' + result.sheets.join(', '), 'info');
              }, 2000);
            }
          } else {
            showStatus(result.error || result.message || 'Failed to create preview', 'error');
          }
        })
        .withFailureHandler(function(error) {
          showStatus('Error: ' + error.message, 'error');
        })
        .previewTemplate(templateType);
    }
    
    // Modal functions removed - preview now creates actual sheets
    // Keeping stubs in case they're referenced elsewhere
    function showTemplatePreview(preview) {
      // Deprecated - preview creates actual sheets now
    }
    
    function closeTemplatePreview() {
      // Deprecated - no modal to close
    }
    
    function applyTemplateFromPreview(templateType) {
      applyTemplate(templateType);
    }

    function applyTemplate(templateType) {
      showStatus('Applying ' + templateType.replace('-', ' ') + ' template...', 'info');
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showStatus('Template applied successfully! Check your new sheets.', 'success');
            
            // Optionally navigate to the first sheet created
            if (result.sheets && result.sheets.length > 0) {
              setTimeout(() => {
                google.script.run.navigateToSheet(result.sheets[0]);
              }, 2000);
            }
          } else {
            showStatus(result.error || 'Failed to apply template', 'error');
          }
        })
        .withFailureHandler(function(error) {
          showStatus('Error: ' + error.message, 'error');
        })
        .applyIndustryTemplate(templateType);
    }
    
    // Clean up preview sheets when switching sectors or back button
    function cleanupPreviews() {
      google.script.run
        .withSuccessHandler(function(result) {
          console.log('Preview sheets cleaned up');
        })
        .withFailureHandler(function(error) {
          console.error('Cleanup error:', error);
        })
        .cleanupIndustryPreviews();
    }
    
    // Add cleanup when switching sectors
    window.addEventListener('DOMContentLoaded', function() {
      // Clean up when switching between sectors
      const sectorButtons = document.querySelectorAll('.sector-item');
      sectorButtons.forEach(button => {
        button.addEventListener('click', function() {
          // Clean up any existing preview sheets when switching sectors
          cleanupPreviews();
        });
      });
      
      // Clean up when clicking back button
      const backBtn = document.querySelector('.nav-back');
      if (backBtn) {
        backBtn.addEventListener('click', function() {
          cleanupPreviews();
        });
      }
    });
    
    // Try to clean up when sidebar is about to close
    window.addEventListener('beforeunload', function(e) {
      // Note: This may not always work due to browser restrictions
      cleanupPreviews();
    });
    
    // Also clean up when visibility changes (sidebar hidden)
    document.addEventListener('visibilitychange', function() {
      if (document.hidden) {
        cleanupPreviews();
      }
    });
  </script>
</body>
</html>