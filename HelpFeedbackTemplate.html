<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <?!= include('SharedStyles'); ?>
  <style>
    /* Help & Feedback Styles */
    .help-section {
      margin-bottom: 20px;
    }
    
    .help-category {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 16px;
    }
    
    .help-card {
      background: white;
      border: 1.5px solid var(--gray-200);
      border-radius: 10px;
      padding: 14px;
      cursor: pointer;
      transition: all var(--transition-fast);
      text-align: center;
      position: relative;
    }
    
    .help-card:hover {
      border-color: var(--primary-400);
      background: var(--gray-50);
      transform: translateY(-2px);
      box-shadow: var(--elevation-2);
    }
    
    .help-card.selected {
      border-color: var(--primary-500);
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(99, 102, 241, 0.1));
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }
    
    .help-icon {
      width: 32px;
      height: 32px;
      margin: 0 auto 8px;
      background: var(--primary-100);
      color: var(--primary-600);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }
    
    .help-card.bug .help-icon {
      background: var(--danger-100);
      color: var(--danger-600);
    }
    
    .help-card.feature .help-icon {
      background: var(--success-100);
      color: var(--success-600);
    }
    
    .help-card.question .help-icon {
      background: var(--warning-100);
      color: var(--warning-600);
    }
    
    .help-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--gray-800);
      margin-bottom: 4px;
    }
    
    .help-desc {
      font-size: 10px;
      color: var(--gray-500);
      line-height: 1.3;
    }
    
    /* Feedback Form */
    .feedback-form {
      display: none;
    }
    
    .feedback-form.active {
      display: block;
    }
    
    .priority-selector {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }
    
    .priority-btn {
      flex: 1;
      padding: 8px;
      border: 1.5px solid var(--gray-200);
      border-radius: 6px;
      background: white;
      font-size: 11px;
      cursor: pointer;
      transition: all var(--transition-fast);
      text-align: center;
    }
    
    .priority-btn:hover {
      border-color: var(--primary-300);
      background: var(--gray-50);
    }
    
    .priority-btn.selected {
      background: var(--primary-500);
      border-color: var(--primary-500);
      color: white;
    }
    
    .priority-btn.low {
      border-color: var(--success-300);
    }
    
    .priority-btn.low.selected {
      background: var(--success-500);
      border-color: var(--success-500);
    }
    
    .priority-btn.medium {
      border-color: var(--warning-300);
    }
    
    .priority-btn.medium.selected {
      background: var(--warning-500);
      border-color: var(--warning-500);
    }
    
    .priority-btn.high {
      border-color: var(--danger-300);
    }
    
    .priority-btn.high.selected {
      background: var(--danger-500);
      border-color: var(--danger-500);
    }
    
    /* Quick Links */
    .quick-links {
      display: grid;
      gap: 8px;
    }
    
    .quick-link {
      display: flex;
      align-items: center;
      padding: 10px 12px;
      background: var(--gray-50);
      border-radius: 8px;
      text-decoration: none;
      color: var(--gray-700);
      font-size: 12px;
      transition: all var(--transition-fast);
    }
    
    .quick-link:hover {
      background: var(--primary-50);
      color: var(--primary-700);
      transform: translateX(4px);
    }
    
    .quick-link-icon {
      width: 20px;
      height: 20px;
      margin-right: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--primary-500);
    }
    
    /* Feature Request Tags */
    .tag-selector {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }
    
    .tag-chip {
      padding: 4px 10px;
      background: var(--gray-100);
      border: 1px solid var(--gray-200);
      border-radius: 12px;
      font-size: 10px;
      cursor: pointer;
      transition: all var(--transition-fast);
    }
    
    .tag-chip:hover {
      border-color: var(--primary-300);
      background: var(--primary-50);
    }
    
    .tag-chip.selected {
      background: var(--primary-500);
      border-color: var(--primary-500);
      color: white;
    }
    
    /* Submission Status */
    .submission-success {
      display: none;
      text-align: center;
      padding: 24px;
    }
    
    .success-icon {
      width: 48px;
      height: 48px;
      margin: 0 auto 12px;
      background: var(--success-500);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }
    
    .success-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--gray-800);
      margin-bottom: 8px;
    }
    
    .success-message {
      font-size: 12px;
      color: var(--gray-600);
      line-height: 1.4;
    }
    
    /* Character counter */
    .char-counter {
      text-align: right;
      font-size: 10px;
      color: var(--gray-400);
      margin-top: 4px;
    }
    
    .char-counter.warning {
      color: var(--warning-500);
    }
    
    .char-counter.error {
      color: var(--danger-500);
    }
  </style>
</head>
<body>
  <div class="nav-header">
    <button class="nav-back" onclick="backToMain()">‚Üê</button>
    <div class="nav-title">
      <h2>Help & Feedback</h2>
      <p>Get help or share your suggestions</p>
    </div>
  </div>
  
  <div class="container">
    <div id="statusMessage" style="display: none;"></div>
    
    <!-- Main Help Menu -->
    <div id="helpMenu" class="help-section">
      <div class="card">
        <div class="card-title">How can we help?</div>
        <div class="card-description">Select an option below</div>
        
        <div class="help-category">
          <div class="help-card bug" onclick="showFeedbackForm('bug')">
            <div class="help-icon">üêõ</div>
            <div class="help-title">Report a Bug</div>
            <div class="help-desc">Something not working?</div>
          </div>
          
          <div class="help-card feature" onclick="showFeedbackForm('feature')">
            <div class="help-icon">üí°</div>
            <div class="help-title">Request Feature</div>
            <div class="help-desc">Have an idea?</div>
          </div>
          
          <div class="help-card question" onclick="showFeedbackForm('question')">
            <div class="help-icon">‚ùì</div>
            <div class="help-title">Ask a Question</div>
            <div class="help-desc">Need help?</div>
          </div>
          
          <div class="help-card" onclick="showFeedbackForm('feedback')">
            <div class="help-icon">üí¨</div>
            <div class="help-title">General Feedback</div>
            <div class="help-desc">Share your thoughts</div>
          </div>
        </div>
      </div>
      
      <!-- Quick Links -->
      <div class="card">
        <div class="card-title">Quick Links</div>
        
        <div class="quick-links">
          <a href="https://www.cellpilot.io/docs" target="_blank" class="quick-link">
            <span class="quick-link-icon">‚ñ∂</span>
            Documentation
          </a>
          
          <a href="https://www.cellpilot.io/tutorials" target="_blank" class="quick-link">
            <span class="quick-link-icon">‚ñ∂</span>
            Video Tutorials
          </a>
          
          <a href="https://www.cellpilot.io/changelog" target="_blank" class="quick-link">
            <span class="quick-link-icon">‚ñ∂</span>
            What's New
          </a>
          
          <a href="#" onclick="showKeyboardShortcuts()" class="quick-link">
            <span class="quick-link-icon">‚ñ∂</span>
            Keyboard Shortcuts
          </a>
        </div>
      </div>
      
      <!-- Version Info -->
      <div class="card">
        <div class="card-title">About CellPilot</div>
        <div style="font-size: 11px; color: var(--gray-600); line-height: 1.5;">
          <div style="margin-bottom: 4px;">Version: 2.0.1</div>
          <div style="margin-bottom: 4px;">Last Updated: <?!= new Date().toLocaleDateString() ?></div>
          <div style="margin-bottom: 8px;">License: Free Tier (100 operations/month)</div>
          <button class="btn btn-primary btn-block" onclick="google.script.run.showUpgradeOptions()">
            Upgrade for Unlimited Access
          </button>
        </div>
      </div>
    </div>
    
    <!-- Bug Report Form -->
    <div id="bugForm" class="feedback-form">
      <div class="card">
        <div class="card-title">Report a Bug</div>
        <div class="card-description">Help us improve by reporting issues</div>
        
        <div class="form-group">
          <label class="form-label">What went wrong? <span style="color: var(--danger-500);">*</span></label>
          <input type="text" id="bugTitle" class="form-input" placeholder="Brief description of the issue" maxlength="100">
        </div>
        
        <div class="form-group">
          <label class="form-label">Steps to reproduce</label>
          <textarea id="bugSteps" class="form-input" rows="3" placeholder="1. Click on...&#10;2. Then...&#10;3. Error appears..." maxlength="500"></textarea>
          <div class="char-counter" id="bugStepsCounter">0/500</div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Expected behavior</label>
          <input type="text" id="bugExpected" class="form-input" placeholder="What should have happened?" maxlength="200">
        </div>
        
        <div class="form-group">
          <label class="form-label">Priority</label>
          <div class="priority-selector">
            <button class="priority-btn low" onclick="setPriority('low', this)">Low</button>
            <button class="priority-btn medium selected" onclick="setPriority('medium', this)">Medium</button>
            <button class="priority-btn high" onclick="setPriority('high', this)">High</button>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Your email (optional)</label>
          <input type="email" id="bugEmail" class="form-input" placeholder="email@example.com">
          <div class="form-help">We'll notify you when this is fixed</div>
        </div>
        
        <div class="btn-group">
          <button class="btn btn-secondary" onclick="cancelFeedback()">Cancel</button>
          <button class="btn btn-danger" onclick="submitBugReport()">Submit Bug Report</button>
        </div>
      </div>
    </div>
    
    <!-- Feature Request Form -->
    <div id="featureForm" class="feedback-form">
      <div class="card">
        <div class="card-title">Request a Feature</div>
        <div class="card-description">Tell us what would make CellPilot better</div>
        
        <div class="form-group">
          <label class="form-label">Feature title <span style="color: var(--danger-500);">*</span></label>
          <input type="text" id="featureTitle" class="form-input" placeholder="What would you like to see?" maxlength="100">
        </div>
        
        <div class="form-group">
          <label class="form-label">Describe the feature</label>
          <textarea id="featureDescription" class="form-input" rows="4" placeholder="How would this feature work? Why would it be useful?" maxlength="1000"></textarea>
          <div class="char-counter" id="featureDescCounter">0/1000</div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Category</label>
          <div class="tag-selector">
            <div class="tag-chip" onclick="toggleTag(this)">Formulas</div>
            <div class="tag-chip" onclick="toggleTag(this)">Data Cleaning</div>
            <div class="tag-chip" onclick="toggleTag(this)">Automation</div>
            <div class="tag-chip" onclick="toggleTag(this)">Visualization</div>
            <div class="tag-chip" onclick="toggleTag(this)">Import/Export</div>
            <div class="tag-chip" onclick="toggleTag(this)">Templates</div>
            <div class="tag-chip" onclick="toggleTag(this)">UI/UX</div>
            <div class="tag-chip" onclick="toggleTag(this)">Performance</div>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">How often would you use this?</label>
          <select id="featureFrequency" class="form-select">
            <option value="">Select frequency...</option>
            <option value="daily">Daily</option>
            <option value="weekly">Weekly</option>
            <option value="monthly">Monthly</option>
            <option value="occasionally">Occasionally</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">Your email (optional)</label>
          <input type="email" id="featureEmail" class="form-input" placeholder="email@example.com">
          <div class="form-help">We'll notify you if this feature is added</div>
        </div>
        
        <div class="btn-group">
          <button class="btn btn-secondary" onclick="cancelFeedback()">Cancel</button>
          <button class="btn btn-success" onclick="submitFeatureRequest()">Submit Request</button>
        </div>
      </div>
    </div>
    
    <!-- Question Form -->
    <div id="questionForm" class="feedback-form">
      <div class="card">
        <div class="card-title">Ask a Question</div>
        <div class="card-description">Get help with CellPilot</div>
        
        <div class="form-group">
          <label class="form-label">What do you need help with? <span style="color: var(--danger-500);">*</span></label>
          <select id="questionCategory" class="form-select">
            <option value="">Select a topic...</option>
            <option value="getting-started">Getting Started</option>
            <option value="formulas">Formula Builder</option>
            <option value="data-cleaning">Data Cleaning</option>
            <option value="automation">Automation</option>
            <option value="templates">Industry Templates</option>
            <option value="account">Account & Billing</option>
            <option value="other">Other</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">Your question</label>
          <textarea id="questionText" class="form-input" rows="4" placeholder="Type your question here..." maxlength="500"></textarea>
          <div class="char-counter" id="questionCounter">0/500</div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Your email <span style="color: var(--danger-500);">*</span></label>
          <input type="email" id="questionEmail" class="form-input" placeholder="email@example.com" required>
          <div class="form-help">We'll send the answer to this email</div>
        </div>
        
        <div class="btn-group">
          <button class="btn btn-secondary" onclick="cancelFeedback()">Cancel</button>
          <button class="btn btn-primary" onclick="submitQuestion()">Submit Question</button>
        </div>
      </div>
    </div>
    
    <!-- General Feedback Form -->
    <div id="feedbackForm" class="feedback-form">
      <div class="card">
        <div class="card-title">General Feedback</div>
        <div class="card-description">Share your thoughts about CellPilot</div>
        
        <div class="form-group">
          <label class="form-label">How's your experience so far?</label>
          <div class="priority-selector">
            <button class="priority-btn" onclick="setRating(1, this)">üòû</button>
            <button class="priority-btn" onclick="setRating(2, this)">üòê</button>
            <button class="priority-btn" onclick="setRating(3, this)">üôÇ</button>
            <button class="priority-btn selected" onclick="setRating(4, this)">üòä</button>
            <button class="priority-btn" onclick="setRating(5, this)">ü§©</button>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Your feedback</label>
          <textarea id="feedbackText" class="form-input" rows="4" placeholder="What do you like? What could be better?" maxlength="1000"></textarea>
          <div class="char-counter" id="feedbackCounter">0/1000</div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Your email (optional)</label>
          <input type="email" id="feedbackEmail" class="form-input" placeholder="email@example.com">
        </div>
        
        <div class="btn-group">
          <button class="btn btn-secondary" onclick="cancelFeedback()">Cancel</button>
          <button class="btn btn-primary" onclick="submitFeedback()">Submit Feedback</button>
        </div>
      </div>
    </div>
    
    <!-- Success Message -->
    <div id="successMessage" class="submission-success">
      <div class="card">
        <div class="success-icon">‚úì</div>
        <div class="success-title">Thank You!</div>
        <div class="success-message" id="successText">
          Your feedback has been submitted successfully. We appreciate your input and will review it soon.
        </div>
        <button class="btn btn-primary btn-block" onclick="resetForm()" style="margin-top: 16px;">
          Submit Another
        </button>
      </div>
    </div>
  </div>
  
  <script>
    let currentPriority = 'medium';
    let currentRating = 4;
    let selectedTags = [];
    
    function backToMain() {
      google.script.run.showCellPilotSidebar();
    }
    
    function showFeedbackForm(type) {
      // Hide menu
      document.getElementById('helpMenu').style.display = 'none';
      
      // Hide all forms
      document.querySelectorAll('.feedback-form').forEach(form => {
        form.classList.remove('active');
      });
      
      // Show selected form
      document.getElementById(type + 'Form').classList.add('active');
    }
    
    function cancelFeedback() {
      // Show menu
      document.getElementById('helpMenu').style.display = 'block';
      
      // Hide all forms
      document.querySelectorAll('.feedback-form').forEach(form => {
        form.classList.remove('active');
      });
      
      // Reset form fields
      document.querySelectorAll('.form-input').forEach(input => {
        input.value = '';
      });
      
      // Reset selections
      currentPriority = 'medium';
      currentRating = 4;
      selectedTags = [];
    }
    
    function setPriority(priority, button) {
      currentPriority = priority;
      button.parentElement.querySelectorAll('.priority-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      button.classList.add('selected');
    }
    
    function setRating(rating, button) {
      currentRating = rating;
      button.parentElement.querySelectorAll('.priority-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      button.classList.add('selected');
    }
    
    function toggleTag(chip) {
      chip.classList.toggle('selected');
      const tag = chip.textContent;
      
      if (chip.classList.contains('selected')) {
        selectedTags.push(tag);
      } else {
        selectedTags = selectedTags.filter(t => t !== tag);
      }
    }
    
    function submitBugReport() {
      const data = {
        type: 'bug',
        title: document.getElementById('bugTitle').value,
        steps: document.getElementById('bugSteps').value,
        expected: document.getElementById('bugExpected').value,
        priority: currentPriority,
        email: document.getElementById('bugEmail').value,
        timestamp: new Date().toISOString(),
        version: '2.0.1'
      };
      
      if (!data.title) {
        showStatus('Please provide a brief description of the issue', 'error');
        return;
      }
      
      submitToBackend(data);
    }
    
    function submitFeatureRequest() {
      const data = {
        type: 'feature',
        title: document.getElementById('featureTitle').value,
        description: document.getElementById('featureDescription').value,
        tags: selectedTags,
        frequency: document.getElementById('featureFrequency').value,
        email: document.getElementById('featureEmail').value,
        timestamp: new Date().toISOString(),
        version: '2.0.1'
      };
      
      if (!data.title) {
        showStatus('Please provide a feature title', 'error');
        return;
      }
      
      submitToBackend(data);
    }
    
    function submitQuestion() {
      const data = {
        type: 'question',
        category: document.getElementById('questionCategory').value,
        question: document.getElementById('questionText').value,
        email: document.getElementById('questionEmail').value,
        timestamp: new Date().toISOString(),
        version: '2.0.1'
      };
      
      if (!data.category || !data.email) {
        showStatus('Please select a topic and provide your email', 'error');
        return;
      }
      
      submitToBackend(data);
    }
    
    function submitFeedback() {
      const data = {
        type: 'feedback',
        rating: currentRating,
        feedback: document.getElementById('feedbackText').value,
        email: document.getElementById('feedbackEmail').value,
        timestamp: new Date().toISOString(),
        version: '2.0.1'
      };
      
      submitToBackend(data);
    }
    
    function submitToBackend(data) {
      showStatus('Submitting...', 'info');
      
      google.script.run
        .withSuccessHandler(function(result) {
          showSuccessMessage(data.type);
        })
        .withFailureHandler(function(error) {
          showStatus('Submission failed. Please try again.', 'error');
        })
        .submitFeedback(data);
    }
    
    function showSuccessMessage(type) {
      // Hide all forms
      document.querySelectorAll('.feedback-form').forEach(form => {
        form.classList.remove('active');
      });
      
      // Customize success message
      const messages = {
        bug: 'Your bug report has been submitted. We\'ll investigate and fix it as soon as possible.',
        feature: 'Your feature request has been submitted. We review all suggestions to improve CellPilot.',
        question: 'Your question has been submitted. We\'ll respond to your email within 24 hours.',
        feedback: 'Thank you for your feedback! It helps us make CellPilot better for everyone.'
      };
      
      document.getElementById('successText').textContent = messages[type];
      document.getElementById('successMessage').style.display = 'block';
    }
    
    function resetForm() {
      document.getElementById('successMessage').style.display = 'none';
      document.getElementById('helpMenu').style.display = 'block';
      cancelFeedback();
    }
    
    function showKeyboardShortcuts() {
      const shortcuts = `
        <div style="font-size: 12px; line-height: 1.6;">
          <strong>Keyboard Shortcuts:</strong><br>
          <div style="margin-top: 8px;">
            <code>Ctrl/Cmd + Shift + C</code> - Open CellPilot<br>
            <code>Ctrl/Cmd + Shift + D</code> - Data Cleaning<br>
            <code>Ctrl/Cmd + Shift + T</code> - Tableize Data<br>
            <code>Ctrl/Cmd + Shift + F</code> - Formula Builder<br>
            <code>Esc</code> - Close sidebar
          </div>
        </div>
      `;
      
      showStatus(shortcuts, 'info');
    }
    
    function showStatus(message, type) {
      const statusDiv = document.getElementById('statusMessage');
      statusDiv.className = 'alert alert-' + type;
      statusDiv.innerHTML = message;
      statusDiv.style.display = 'block';
      
      if (type === 'success') {
        setTimeout(function() {
          statusDiv.style.display = 'none';
        }, 3000);
      }
    }
    
    // Character counters
    document.getElementById('bugSteps')?.addEventListener('input', function() {
      updateCharCounter('bugStepsCounter', this.value.length, 500);
    });
    
    document.getElementById('featureDescription')?.addEventListener('input', function() {
      updateCharCounter('featureDescCounter', this.value.length, 1000);
    });
    
    document.getElementById('questionText')?.addEventListener('input', function() {
      updateCharCounter('questionCounter', this.value.length, 500);
    });
    
    document.getElementById('feedbackText')?.addEventListener('input', function() {
      updateCharCounter('feedbackCounter', this.value.length, 1000);
    });
    
    function updateCharCounter(counterId, current, max) {
      const counter = document.getElementById(counterId);
      counter.textContent = current + '/' + max;
      
      counter.classList.remove('warning', 'error');
      if (current > max * 0.8) {
        counter.classList.add('warning');
      }
      if (current >= max) {
        counter.classList.add('error');
      }
    }
  </script>
</body>
</html>