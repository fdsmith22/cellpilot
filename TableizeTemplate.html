<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <?!= include('SharedStyles'); ?>
  <style>
    /* Prevent horizontal scrolling */
    body {
      overflow-x: hidden;
      max-width: 100%;
    }
    
    .container {
      max-width: 100%;
      overflow-x: hidden;
    }
    
    .parse-option {
      background: white;
      border: 1.5px solid var(--gray-200);
      border-radius: 10px;
      padding: 14px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all var(--transition-fast);
      max-width: 100%;
      box-sizing: border-box;
      position: relative;
    }
    
    .parse-option:hover {
      border-color: var(--primary-300);
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.02), rgba(99, 102, 241, 0.05));
      transform: translateY(-1px);
      box-shadow: var(--elevation-1);
    }
    
    .parse-option.selected {
      border-color: var(--primary-500);
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.06), rgba(99, 102, 241, 0.10));
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }
    
    .parse-option.selected::after {
      content: '‚úì';
      position: absolute;
      top: 10px;
      right: 12px;
      width: 20px;
      height: 20px;
      background: var(--primary-500);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
    }
    
    .smart-option {
      border: 1.5px solid var(--success-400);
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.03), rgba(34, 197, 94, 0.06));
    }
    
    .smart-option:hover {
      border-color: var(--success-500);
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.05), rgba(34, 197, 94, 0.08));
    }
    
    .smart-option.selected {
      border-color: var(--success-500);
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.08), rgba(34, 197, 94, 0.12));
      box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.15);
    }
    
    .smart-option.selected::after {
      background: var(--success-500);
    }
    
    .recommended-badge {
      position: absolute;
      top: -8px;
      right: 16px;
      background: var(--success-500);
      color: white;
      padding: 3px 8px;
      border-radius: 10px;
      font-size: 9px;
      font-weight: 700;
      letter-spacing: 0.5px;
    }
    
    .parse-method-title {
      font-weight: 600;
      font-size: 13px;
      color: var(--gray-700);
      margin-bottom: 4px;
    }
    
    .parse-method-desc {
      font-size: 11px;
      color: var(--gray-500);
    }
    
    .preview-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
      margin-top: 12px;
      background: white;
      border-radius: 6px;
      overflow: hidden;
    }
    
    .preview-table th {
      background: var(--gray-100);
      padding: 8px;
      text-align: left;
      font-weight: 600;
      border: 1px solid var(--gray-200);
    }
    
    .preview-table td {
      padding: 6px 8px;
      border: 1px solid var(--gray-200);
      max-width: 150px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .delimiter-options {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-top: 12px;
    }
    
    @media (min-width: 300px) {
      .delimiter-options {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    
    .form-select {
      width: 100%;
      padding: 10px 12px;
      border: 1.5px solid var(--gray-200);
      border-radius: 8px;
      background: white;
      font-size: 13px;
      color: var(--gray-700);
      cursor: pointer;
      transition: all var(--transition-fast);
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%236B7280' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 36px;
    }
    
    .form-select:hover {
      border-color: var(--primary-300);
    }
    
    .form-select:focus {
      outline: none;
      border-color: var(--primary-500);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }
    
    .custom-delimiter-input {
      margin-top: 8px;
      display: none;
    }
    
    .column-adjuster {
      margin-top: 12px;
      padding: 12px;
      background: var(--gray-50);
      border-radius: 6px;
    }
    
    .column-control {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    
    .column-width-input {
      width: 60px;
      padding: 4px 6px;
      border: 1px solid var(--gray-300);
      border-radius: 4px;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="nav-header">
    <button class="nav-back" onclick="backToMain()">‚Üê</button>
    <div class="nav-title">
      <h2>Tableize Data</h2>
      <p>Structure your data into proper columns</p>
    </div>
  </div>
  
  <div class="container">
    <div id="statusMessage"></div>
    
    <!-- Initial Instructions Card -->
    <div id="instructionsSection" class="card">
      <div class="card-title">Tableize Your Data</div>
      <div class="card-description">Transform unstructured data into organized columns</div>
      
      <div style="margin: 20px 0;">
        <h4 style="font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 12px;">How to use:</h4>
        <ol style="margin: 0; padding-left: 20px; font-size: 12px; color: var(--gray-600); line-height: 1.8;">
          <li>Select the data in your spreadsheet that needs structuring</li>
          <li>Click "Analyze Data" below to detect patterns</li>
          <li>Choose how to split your data into columns</li>
          <li>Preview and apply the transformation</li>
        </ol>
      </div>
      
      <div style="background: var(--primary-50); border: 1px solid var(--primary-200); border-radius: 8px; padding: 12px; margin: 16px 0;">
        <p style="font-size: 11px; color: var(--primary-700); margin: 0;">
          <strong>üí° Tip:</strong> Tableize works best with data that has consistent patterns like delimiters (commas, tabs) or fixed-width formatting.
        </p>
      </div>
      
      <button class="btn btn-primary btn-block" onclick="startAnalysis()">
        Analyze Selected Data
      </button>
      <button class="btn btn-secondary btn-block" style="margin-top: 8px;" onclick="backToMain()">
        Back to Main Menu
      </button>
    </div>
    
    <div id="analysisSection" class="card" style="display: none;">
      <div class="card-title">Data Analysis</div>
      <div class="card-description">Analyzing your data structure...</div>
      <div class="progress">
        <div class="progress-bar" style="width: 0%"></div>
      </div>
    </div>
    
    <div id="optionsSection" style="display: none;">
      <div class="card">
        <div class="card-title">Choose Parsing Method</div>
        <div class="card-description">Select how to split your data into columns</div>
        
        <div id="parseOptions"></div>
        
        <div id="delimiterSection" style="display: none;">
          <div class="form-group">
            <label class="form-label">Choose Delimiter</label>
            <select id="delimiterSelect" class="form-select" onchange="handleDelimiterChange(this.value)">
              <option value="comma">Comma (,)</option>
              <option value="tab">Tab</option>
              <option value="space">Space</option>
              <option value="pipe">Pipe (|)</option>
              <option value="semicolon">Semicolon (;)</option>
              <option value="colon">Colon (:)</option>
              <option value="custom">Custom...</option>
            </select>
            <div id="customDelimiterInput" style="display: none; margin-top: 8px;">
              <input type="text" id="customDelimiter" class="form-input" placeholder="Enter custom delimiter" maxlength="5">
            </div>
          </div>
        </div>
        
        <div id="fixedWidthSection" style="display: none;">
          <div class="column-adjuster">
            <div class="form-label">Column Widths</div>
            <div class="form-help">Specify the width of each column in characters</div>
            <div id="columnWidthControls"></div>
            <button class="btn btn-secondary" onclick="addColumnWidth()">Add Column</button>
          </div>
        </div>
        
        <div class="form-group">
          <div class="form-checkbox-group">
            <input type="checkbox" id="hasHeaders" class="form-checkbox" checked>
            <label for="hasHeaders" class="form-checkbox-label">First row contains headers</label>
          </div>
        </div>
        
        <div class="form-group">
          <div class="form-checkbox-group">
            <input type="checkbox" id="trimSpaces" class="form-checkbox" checked>
            <label for="trimSpaces" class="form-checkbox-label">Trim extra spaces from cells</label>
          </div>
        </div>
        
        <button class="btn btn-primary btn-block" onclick="previewParsing()">
          <span class="spinner" id="previewSpinner" style="display:none"></span>
          Preview Results
        </button>
      </div>
    </div>
    
    <div id="previewSection" style="display: none;">
      <div class="card">
        <div class="card-title">Preview</div>
        <div class="card-description">
          <span id="previewStats"></span>
        </div>
        <div style="overflow-x: auto;">
          <table class="preview-table" id="previewTable"></table>
        </div>
        
        <div class="btn-group mt-2">
          <button class="btn btn-secondary" onclick="adjustSettings()">Adjust Settings</button>
          <button class="btn btn-success" onclick="applyTableize()">
            <span class="spinner" id="applySpinner" style="display:none"></span>
            Apply Structure
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    let analysisResult = null;
    let currentMethod = 'delimiter';
    let currentDelimiter = 'comma';
    let columnWidths = [10, 10, 10];
    let previewData = null;
    
    // Don't auto-analyze on load
    window.onload = function() {
      // Page is ready, user can now click to analyze
      console.log('Tableize page loaded - waiting for user action');
    };
    
    function startAnalysis() {
      // Hide instructions and show analysis section
      document.getElementById('instructionsSection').style.display = 'none';
      document.getElementById('analysisSection').style.display = 'block';
      
      // Small delay to ensure UI updates before starting analysis
      setTimeout(function() {
        checkAndAnalyze();
      }, 100);
    }
    
    function checkAndAnalyze() {
      // First check if there's actually a selection
      google.script.run
        .withSuccessHandler(function(hasSelection) {
          if (hasSelection) {
            analyzeData();
          } else {
            document.getElementById('analysisSection').style.display = 'none';
            // Show error with option to retry
            document.getElementById('optionsSection').innerHTML = `
              <div class="card">
                <div class="card-title">‚ö†Ô∏è No Data Selected</div>
                <div class="card-description">Please select data in your spreadsheet first</div>
                <div style="margin: 16px 0; padding: 12px; background: var(--warning-50); border: 1px solid var(--warning-200); border-radius: 6px;">
                  <p style="font-size: 12px; color: var(--warning-700); margin: 0;">
                    To use Tableize, you need to select the cells containing the data you want to structure.
                  </p>
                </div>
                <button class="btn btn-primary btn-block" onclick="location.reload()">Try Again</button>
                <button class="btn btn-secondary btn-block" style="margin-top: 8px;" onclick="backToMain()">Back to Main Menu</button>
              </div>
            `;
            document.getElementById('optionsSection').style.display = 'block';
            showStatus('No data selected. Please select cells in your spreadsheet.', 'warning');
          }
        })
        .withFailureHandler(function(error) {
          console.error('Failed to check selection:', error);
          analyzeData(); // Fallback to regular analysis
        })
        .hasDataSelection();
    }
    
    function backToMain() {
      google.script.run.showCellPilotSidebar();
    }
    
    function showStatus(message, type = 'info') {
      const statusDiv = document.getElementById('statusMessage');
      statusDiv.className = 'alert alert-' + type;
      statusDiv.textContent = message;
      statusDiv.style.display = 'block';
      
      if (type === 'success') {
        setTimeout(function() {
          statusDiv.style.display = 'none';
        }, 3000);
      }
    }
    
    function analyzeData() {
      const progressBar = document.querySelector('.progress-bar');
      let progress = 0;
      
      console.log('Starting analysis...');
      showStatus('Analyzing data...', 'info');
      
      const progressInterval = setInterval(function() {
        progress += 10;
        progressBar.style.width = progress + '%';
        if (progress >= 90) {
          clearInterval(progressInterval);
        }
      }, 100);
      
      // Add timeout to detect hanging
      const timeoutId = setTimeout(function() {
        clearInterval(progressInterval);
        console.error('Analysis timed out');
        progressBar.style.width = '100%';
        document.getElementById('analysisSection').style.display = 'none';
        
        // Show manual options when analysis times out
        showStatus('Analysis is taking longer than expected. You can proceed with manual configuration.', 'warning');
        
        // Show simplified options
        analysisResult = { hasData: true, manual: true };
        displayManualOptions();
        document.getElementById('optionsSection').style.display = 'block';
      }, 8000); // 8 second timeout - give more time for large datasets
      
      google.script.run
        .withSuccessHandler(function(result) {
          console.log('Analysis succeeded:', result);
          clearTimeout(timeoutId);
          clearInterval(progressInterval);
          progressBar.style.width = '100%';
          
          if (!result || !result.hasData) {
            showStatus('No data found in selection', 'error');
            return;
          }
          
          analysisResult = result;
          displayOptions(result);
          
          document.getElementById('analysisSection').style.display = 'none';
          document.getElementById('optionsSection').style.display = 'block';
        })
        .withFailureHandler(function(error) {
          console.error('Analysis failed:', error);
          clearTimeout(timeoutId);
          clearInterval(progressInterval);
          showStatus('Failed to analyze data: ' + error.message, 'error');
        })
        .analyzeDataForTableize();
    }
    
    function displayOptions(analysis) {
      const optionsHtml = [];
      
      // Check if data is already in columns
      if (analysis.hasMultipleColumns) {
        optionsHtml.push(`
          <div class="alert alert-info" style="margin-bottom: 16px;">
            <strong>Data already in ${analysis.columnCount} columns</strong><br>
            Your data appears to already be structured. You can clean it up or reorganize it below.
          </div>
        `);
        
        optionsHtml.push(`
          <div class="parse-option selected" onclick="selectMethod('preserve', this)">
            <div class="parse-method-title">Clean & Preserve Current Structure</div>
            <div class="parse-method-desc">
              Keep the existing ${analysis.columnCount} columns, just clean up formatting
            </div>
          </div>
        `);
      }
      
      // Delimiter option (always show, even for multi-column data)
      if (analysis.suggestedDelimiter && analysis.suggestedDelimiter !== 'none') {
        optionsHtml.push(`
          <div class="parse-option ${!analysis.hasMultipleColumns ? 'selected' : ''}" onclick="selectMethod('delimiter', this)">
            <div class="parse-method-title">Split by Delimiter</div>
            <div class="parse-method-desc">
              Detected: ${analysis.suggestedDelimiter} delimiter 
              (‚âà${analysis.estimatedColumns} columns)
            </div>
          </div>
        `);
        currentDelimiter = analysis.suggestedDelimiter;
      } else if (!analysis.hasMultipleColumns) {
        optionsHtml.push(`
          <div class="parse-option" onclick="selectMethod('delimiter', this)">
            <div class="parse-method-title">Split by Delimiter</div>
            <div class="parse-method-desc">Choose a character to split columns</div>
          </div>
        `);
      }
      
      // Key-value option
      if (analysis.patterns && analysis.patterns.keyValue) {
        optionsHtml.push(`
          <div class="parse-option" onclick="selectMethod('keyvalue', this)">
            <div class="parse-method-title">Key-Value Pairs</div>
            <div class="parse-method-desc">Parse "Name: John, Age: 25" format</div>
          </div>
        `);
      }
      
      // Fixed width option
      optionsHtml.push(`
        <div class="parse-option" onclick="selectMethod('fixedwidth', this)">
          <div class="parse-method-title">Fixed Width Columns</div>
          <div class="parse-method-desc">Split at specific character positions</div>
        </div>
      `);
      
      // Smart detection option - make it prominent with badge
      optionsHtml.push(`
        <div class="parse-option smart-option" onclick="selectMethod('smart', this)">
          <span class="recommended-badge">RECOMMENDED</span>
          <div class="parse-method-title">
            Smart Detection
          </div>
          <div class="parse-method-desc">
            Intelligently groups multi-word names, detects regions and numbers
          </div>
        </div>
      `);
      
      document.getElementById('parseOptions').innerHTML = optionsHtml.join('');
      
      // Show delimiter section by default if delimiter detected
      if (analysis.suggestedDelimiter && analysis.suggestedDelimiter !== 'none') {
        currentMethod = 'delimiter';
        document.getElementById('delimiterSection').style.display = 'block';
        
        // Set the dropdown to the suggested delimiter
        const delimiterSelect = document.getElementById('delimiterSelect');
        if (delimiterSelect) {
          delimiterSelect.value = analysis.suggestedDelimiter;
          currentDelimiter = analysis.suggestedDelimiter;
        }
      }
      
      // Set headers checkbox based on detection
      document.getElementById('hasHeaders').checked = analysis.hasHeaders;
    }
    
    function selectMethod(method, element) {
      currentMethod = method;
      
      // Update UI
      document.querySelectorAll('.parse-option').forEach(el => el.classList.remove('selected'));
      
      // Handle both event and direct element cases
      const targetElement = element || (event && event.target ? event.target.closest('.parse-option') : null);
      if (targetElement) {
        targetElement.classList.add('selected');
      }
      
      // Show/hide relevant sections based on method
      document.getElementById('delimiterSection').style.display = 
        method === 'delimiter' ? 'block' : 'none';
      document.getElementById('fixedWidthSection').style.display = 
        method === 'fixedwidth' ? 'block' : 'none';
        
      // For preserve method, hide both sections
      if (method === 'preserve') {
        document.getElementById('delimiterSection').style.display = 'none';
        document.getElementById('fixedWidthSection').style.display = 'none';
      }
        
      if (method === 'fixedwidth') {
        setupColumnWidthControls();
      }
    }
    
    function handleDelimiterChange(value) {
      currentDelimiter = value;
      if (value === 'custom') {
        document.getElementById('customDelimiterInput').style.display = 'block';
        document.getElementById('customDelimiter').focus();
        document.getElementById('customDelimiter').addEventListener('input', function(e) {
          currentDelimiter = e.target.value || 'custom';
        });
      } else {
        document.getElementById('customDelimiterInput').style.display = 'none';
      }
    }
    
    function displayManualOptions() {
      const optionsHtml = `
        <div class="parse-option selected" onclick="selectMethod('delimiter', this)">
          <div class="parse-method-title">Split by Delimiter</div>
          <div class="parse-method-desc">Choose a character to split columns</div>
        </div>
        <div class="parse-option" onclick="selectMethod('smart', this)">
          <div class="parse-method-title" style="color: var(--success-600);">Smart Detection</div>
          <div class="parse-method-desc">Intelligently detect and structure your data</div>
        </div>
        <div class="parse-option" onclick="selectMethod('fixedwidth', this)">
          <div class="parse-method-title">Fixed Width Columns</div>
          <div class="parse-method-desc">Split at specific character positions</div>
        </div>
      `;
      
      document.getElementById('parseOptions').innerHTML = optionsHtml;
      document.getElementById('delimiterSection').style.display = 'block';
    }
    
    function setupColumnWidthControls() {
      const container = document.getElementById('columnWidthControls');
      container.innerHTML = '';
      
      columnWidths.forEach((width, index) => {
        const control = document.createElement('div');
        control.className = 'column-control';
        control.innerHTML = `
          <span style="font-size: 12px;">Column ${index + 1}:</span>
          <input type="number" class="column-width-input" value="${width}" 
                 onchange="updateColumnWidth(${index}, this.value)">
          <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 11px;"
                  onclick="removeColumn(${index})">Remove</button>
        `;
        container.appendChild(control);
      });
    }
    
    function updateColumnWidth(index, value) {
      columnWidths[index] = parseInt(value) || 10;
    }
    
    function addColumnWidth() {
      columnWidths.push(10);
      setupColumnWidthControls();
    }
    
    function removeColumn(index) {
      if (columnWidths.length > 1) {
        columnWidths.splice(index, 1);
        setupColumnWidthControls();
      }
    }
    
    function previewParsing() {
      document.getElementById('previewSpinner').style.display = 'inline-block';
      document.getElementById('previewSection').style.display = 'none';
      
      const options = {
        method: currentMethod,
        delimiter: currentDelimiter === 'custom' ? 
                  document.getElementById('customDelimiter').value : currentDelimiter,
        hasHeaders: document.getElementById('hasHeaders').checked,
        trimSpaces: document.getElementById('trimSpaces').checked,
        columnWidths: columnWidths,
        preserveColumns: currentMethod === 'preserve'
      };
      
      google.script.run
        .withSuccessHandler(function(result) {
          document.getElementById('previewSpinner').style.display = 'none';
          
          if (result.success && result.data) {
            previewData = result.data;
            displayPreview(result.data, result.columns, result.method || options.method);
            document.getElementById('previewSection').style.display = 'block';
          } else {
            showStatus(result.error || 'Failed to parse data', 'error');
          }
        })
        .withFailureHandler(function(error) {
          document.getElementById('previewSpinner').style.display = 'none';
          showStatus('Error: ' + error.message, 'error');
        })
        .previewTableize(options);
    }
    
    function displayPreview(data, columns, method) {
      const table = document.getElementById('previewTable');
      const hasHeaders = document.getElementById('hasHeaders').checked;
      const maxRows = Math.min(10, data.length);
      
      // Update stats with method info
      let statsText = `${data.length} rows √ó ${columns} columns`;
      if (method === 'smart') {
        statsText += ' (Smart Detection Applied)';
      }
      document.getElementById('previewStats').textContent = statsText;
      
      let html = '';
      
      // Add headers
      if (data.length > 0) {
        html += '<thead><tr>';
        
        // For smart detection, always show the first row as headers
        if (method === 'smart' || hasHeaders) {
          data[0].forEach(header => {
            html += `<th style="background: var(--primary-500); color: white; font-weight: 600;">${escapeHtml(header)}</th>`;
          });
        } else {
          // Create generic headers
          for (let i = 0; i < columns; i++) {
            html += `<th>Column ${i + 1}</th>`;
          }
        }
        html += '</tr></thead>';
      }
      
      // Add data rows
      html += '<tbody>';
      const startRow = (method === 'smart' || hasHeaders) ? 1 : 0;
      
      for (let i = startRow; i < Math.min(data.length, startRow + maxRows); i++) {
        html += '<tr>';
        
        // Ensure we have the right number of columns
        for (let j = 0; j < columns; j++) {
          const cell = data[i] && data[i][j] !== undefined ? data[i][j] : '';
          
          // Highlight different data types for smart detection
          let cellStyle = '';
          if (method === 'smart' && cell) {
            // Check if it's a number
            if (!isNaN(cell) || /^[$¬£‚Ç¨¬•]?[\d,]+\.?\d*$/.test(cell)) {
              cellStyle = 'style="background: rgba(251, 191, 36, 0.1); font-weight: 600;"';
            }
            // Check if it might be a region
            else if (/north|south|east|west|central/i.test(cell)) {
              cellStyle = 'style="background: rgba(99, 102, 241, 0.08);"';
            }
          }
          
          html += `<td ${cellStyle} title="${escapeHtml(cell)}">${escapeHtml(cell)}</td>`;
        }
        html += '</tr>';
      }
      
      if (data.length > startRow + maxRows) {
        html += `<tr><td colspan="${columns}" style="text-align: center; font-style: italic; color: var(--gray-500);">
                 ... and ${data.length - startRow - maxRows} more rows</td></tr>`;
      }
      
      html += '</tbody>';
      table.innerHTML = html;
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = String(text);
      return div.innerHTML;
    }
    
    function adjustSettings() {
      document.getElementById('previewSection').style.display = 'none';
    }
    
    function applyTableize() {
      if (!confirm('This will restructure your selected data. Continue?')) {
        return;
      }
      
      document.getElementById('applySpinner').style.display = 'inline-block';
      
      google.script.run
        .withSuccessHandler(function(result) {
          document.getElementById('applySpinner').style.display = 'none';
          
          if (result.success) {
            showStatus(`Successfully structured ${result.rows} rows into ${result.columns} columns`, 'success');
            setTimeout(function() {
              backToMain();
            }, 2000);
          } else {
            showStatus(result.error || 'Failed to apply structure', 'error');
          }
        })
        .withFailureHandler(function(error) {
          document.getElementById('applySpinner').style.display = 'none';
          showStatus('Error: ' + error.message, 'error');
        })
        .applyTableize(previewData);
    }
  </script>
</body>
</html>