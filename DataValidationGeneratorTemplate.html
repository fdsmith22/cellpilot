<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <?!= include('SharedStyles'); ?>
  <style>
    .validation-generator {
      padding: 20px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
    }

    .generator-header {
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid #e0e0e0;
    }

    .generator-title {
      font-size: 24px;
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 8px;
    }

    .generator-subtitle {
      color: #7f8c8d;
      font-size: 14px;
    }

    .validation-section {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .section-title {
      font-size: 16px;
      font-weight: 600;
      color: #34495e;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-icon {
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .range-selector {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 15px;
    }

    .input-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .input-label {
      font-size: 12px;
      color: #7f8c8d;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .input-field {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      transition: all 0.2s;
    }

    .input-field:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    .validation-types {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }

    .validation-card {
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      cursor: pointer;
      transition: all 0.2s;
      background: white;
    }

    .validation-card:hover {
      border-color: #3498db;
      background: #f8f9fa;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .validation-card.selected {
      border-color: #3498db;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .card-title {
      font-weight: 600;
      margin-bottom: 4px;
      font-size: 14px;
    }

    .card-description {
      font-size: 12px;
      opacity: 0.8;
    }

    .validation-card.selected .card-description {
      opacity: 0.9;
    }

    .rule-config {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      margin-top: 15px;
    }

    .config-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
      margin-bottom: 12px;
    }

    .list-input-container {
      margin-bottom: 15px;
    }

    .list-items {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
      min-height: 40px;
      padding: 10px;
      background: white;
      border: 1px dashed #ddd;
      border-radius: 6px;
    }

    .list-item {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .remove-item {
      cursor: pointer;
      background: rgba(255,255,255,0.3);
      border-radius: 50%;
      width: 18px;
      height: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }

    .remove-item:hover {
      background: rgba(255,255,255,0.5);
    }

    .add-item-container {
      display: flex;
      gap: 8px;
    }

    .add-item-input {
      flex: 1;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }

    .add-item-btn {
      padding: 8px 16px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }

    .add-item-btn:hover {
      background: #2980b9;
      transform: translateY(-1px);
    }

    .preview-section {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      margin-top: 20px;
    }

    .preview-title {
      font-size: 14px;
      font-weight: 600;
      color: #34495e;
      margin-bottom: 10px;
    }

    .preview-content {
      background: white;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 12px;
      font-family: monospace;
      font-size: 12px;
      color: #2c3e50;
      line-height: 1.6;
      max-height: 150px;
      overflow-y: auto;
    }

    .action-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
      margin-top: 20px;
    }

    .action-btn {
      padding: 12px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }

    .apply-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .apply-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .apply-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .test-btn {
      background: #27ae60;
      color: white;
    }

    .test-btn:hover {
      background: #229954;
      transform: translateY(-2px);
    }

    .clear-btn {
      background: #95a5a6;
      color: white;
    }

    .clear-btn:hover {
      background: #7f8c8d;
      transform: translateY(-2px);
    }

    .template-btn {
      background: #e67e22;
      color: white;
    }

    .template-btn:hover {
      background: #d35400;
      transform: translateY(-2px);
    }

    .checkbox-container {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
    }

    .checkbox-container input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .checkbox-label {
      font-size: 14px;
      color: #34495e;
      cursor: pointer;
    }

    .template-gallery {
      display: none;
      margin-top: 20px;
    }

    .template-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
    }

    .template-item {
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .template-item:hover {
      border-color: #3498db;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .template-name {
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 8px;
    }

    .template-preview {
      font-size: 12px;
      color: #7f8c8d;
      line-height: 1.4;
    }

    .success-message {
      display: none;
      background: #27ae60;
      color: white;
      padding: 12px;
      border-radius: 6px;
      margin-top: 15px;
      text-align: center;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .error-message {
      display: none;
      background: #e74c3c;
      color: white;
      padding: 12px;
      border-radius: 6px;
      margin-top: 15px;
      text-align: center;
    }

    .loading-spinner {
      display: none;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .help-text {
      font-size: 12px;
      color: #95a5a6;
      margin-top: 5px;
      font-style: italic;
    }

    .advanced-options {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #e0e0e0;
    }

    .toggle-advanced {
      color: #3498db;
      cursor: pointer;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    .toggle-advanced:hover {
      text-decoration: underline;
    }

    .advanced-content {
      display: none;
      margin-top: 15px;
    }

    .advanced-content.show {
      display: block;
    }
  </style>
</head>
<body>
  <div class="validation-generator">
    <div class="generator-header">
      <div class="generator-title">Data Validation Rule Generator</div>
      <div class="generator-subtitle">Create smart validation rules to ensure data quality and consistency</div>
    </div>

    <!-- Range Selection -->
    <div class="validation-section">
      <div class="section-title">
        <span class="section-icon">üìç</span>
        <span>Select Range</span>
      </div>
      <div class="range-selector">
        <div class="input-group">
          <label class="input-label">Start Cell</label>
          <input type="text" id="startCell" class="input-field" placeholder="e.g., A2" value="">
        </div>
        <div class="input-group">
          <label class="input-label">End Cell</label>
          <input type="text" id="endCell" class="input-field" placeholder="e.g., A100" value="">
        </div>
      </div>
      <button class="action-btn test-btn" onclick="useCurrentSelection()" style="width: 100%;">
        Use Current Selection
      </button>
    </div>

    <!-- Validation Type Selection -->
    <div class="validation-section">
      <div class="section-title">
        <span class="section-icon">‚úì</span>
        <span>Validation Type</span>
      </div>
      <div class="validation-types">
        <div class="validation-card" data-type="list" onclick="selectValidationType('list')">
          <div class="card-title">List of Items</div>
          <div class="card-description">Dropdown with predefined options</div>
        </div>
        <div class="validation-card" data-type="number" onclick="selectValidationType('number')">
          <div class="card-title">Number Range</div>
          <div class="card-description">Between min and max values</div>
        </div>
        <div class="validation-card" data-type="text" onclick="selectValidationType('text')">
          <div class="card-title">Text Length</div>
          <div class="card-description">Character count limits</div>
        </div>
        <div class="validation-card" data-type="date" onclick="selectValidationType('date')">
          <div class="card-title">Date Range</div>
          <div class="card-description">Valid date boundaries</div>
        </div>
        <div class="validation-card" data-type="custom" onclick="selectValidationType('custom')">
          <div class="card-title">Custom Formula</div>
          <div class="card-description">Complex validation logic</div>
        </div>
        <div class="validation-card" data-type="checkbox" onclick="selectValidationType('checkbox')">
          <div class="card-title">Checkbox</div>
          <div class="card-description">True/False values</div>
        </div>
        <div class="validation-card" data-type="email" onclick="selectValidationType('email')">
          <div class="card-title">Email Address</div>
          <div class="card-description">Valid email format</div>
        </div>
        <div class="validation-card" data-type="range" onclick="selectValidationType('range')">
          <div class="card-title">From Range</div>
          <div class="card-description">Values from another range</div>
        </div>
      </div>

      <!-- Dynamic Configuration Panel -->
      <div id="ruleConfig" class="rule-config" style="display: none;">
        <!-- Configuration options will be inserted here dynamically -->
      </div>
    </div>

    <!-- Advanced Options -->
    <div class="validation-section">
      <div class="toggle-advanced" onclick="toggleAdvanced()">
        <span id="advancedArrow">‚ñ∂</span>
        <span>Advanced Options</span>
      </div>
      <div id="advancedContent" class="advanced-content">
        <div class="checkbox-container">
          <input type="checkbox" id="showDropdown" checked>
          <label for="showDropdown" class="checkbox-label">Show dropdown arrow in cells</label>
        </div>
        <div class="checkbox-container">
          <input type="checkbox" id="rejectInvalid" checked>
          <label for="rejectInvalid" class="checkbox-label">Reject invalid input</label>
        </div>
        <div class="checkbox-container">
          <input type="checkbox" id="showHelp">
          <label for="showHelp" class="checkbox-label">Show validation help text</label>
        </div>
        <div class="input-group" id="helpTextGroup" style="display: none; margin-top: 10px;">
          <label class="input-label">Help Text</label>
          <textarea id="helpText" class="input-field" rows="3" placeholder="Enter help text to display when cell is selected"></textarea>
        </div>
      </div>
    </div>

    <!-- Preview Section -->
    <div class="validation-section">
      <div class="section-title">
        <span class="section-icon">üëÅ</span>
        <span>Rule Preview</span>
      </div>
      <div class="preview-content" id="rulePreview">
        No validation rule configured yet. Select a validation type above.
      </div>
    </div>

    <!-- Template Gallery -->
    <div class="validation-section template-gallery" id="templateGallery">
      <div class="section-title">
        <span class="section-icon">üìö</span>
        <span>Quick Templates</span>
      </div>
      <div class="template-grid">
        <div class="template-item" onclick="applyTemplate('status')">
          <div class="template-name">Project Status</div>
          <div class="template-preview">Not Started, In Progress, Review, Complete, On Hold</div>
        </div>
        <div class="template-item" onclick="applyTemplate('priority')">
          <div class="template-name">Priority Levels</div>
          <div class="template-preview">Low, Medium, High, Critical</div>
        </div>
        <div class="template-item" onclick="applyTemplate('rating')">
          <div class="template-name">Rating Scale</div>
          <div class="template-preview">1-5 star rating system</div>
        </div>
        <div class="template-item" onclick="applyTemplate('yesno')">
          <div class="template-name">Yes/No</div>
          <div class="template-preview">Simple Yes or No choice</div>
        </div>
        <div class="template-item" onclick="applyTemplate('department')">
          <div class="template-name">Departments</div>
          <div class="template-preview">Sales, Marketing, Engineering, HR, Finance</div>
        </div>
        <div class="template-item" onclick="applyTemplate('country')">
          <div class="template-name">Countries</div>
          <div class="template-preview">Common country list</div>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
      <button class="action-btn template-btn" onclick="toggleTemplates()">
        Browse Templates
      </button>
      <button class="action-btn test-btn" onclick="testValidation()">
        Test Rule
      </button>
      <button class="action-btn clear-btn" onclick="clearValidation()">
        Clear Existing
      </button>
      <button class="action-btn apply-btn" id="applyBtn" onclick="applyValidation()" disabled>
        Apply Validation
      </button>
    </div>

    <!-- Messages -->
    <div class="success-message" id="successMessage"></div>
    <div class="error-message" id="errorMessage"></div>
    <div class="loading-spinner" id="loadingSpinner"></div>
  </div>

  <script>
    let selectedType = null;
    let validationRule = {};
    let currentRange = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      // Check if help text checkbox changes
      document.getElementById('showHelp').addEventListener('change', function(e) {
        document.getElementById('helpTextGroup').style.display = e.target.checked ? 'block' : 'none';
      });

      // Get current selection on load
      useCurrentSelection();
    });

    function useCurrentSelection() {
      google.script.run
        .withSuccessHandler(function(selection) {
          if (selection) {
            currentRange = selection;
            document.getElementById('startCell').value = selection.startCell;
            document.getElementById('endCell').value = selection.endCell;
            updatePreview();
          }
        })
        .withFailureHandler(function(error) {
          console.error('Error getting selection:', error);
        })
        .getCurrentSelection();
    }

    function selectValidationType(type) {
      selectedType = type;
      
      // Update UI
      document.querySelectorAll('.validation-card').forEach(card => {
        card.classList.remove('selected');
      });
      document.querySelector(`.validation-card[data-type="${type}"]`).classList.add('selected');
      
      // Show configuration panel
      const configPanel = document.getElementById('ruleConfig');
      configPanel.style.display = 'block';
      configPanel.innerHTML = getConfigHTML(type);
      
      // Enable apply button
      document.getElementById('applyBtn').disabled = false;
      
      // Update preview
      updatePreview();
    }

    function getConfigHTML(type) {
      switch(type) {
        case 'list':
          return `
            <div class="list-input-container">
              <div class="input-label">List Items</div>
              <div class="add-item-container">
                <input type="text" id="newItem" class="add-item-input" placeholder="Enter item and press Add">
                <button class="add-item-btn" onclick="addListItem()">Add</button>
              </div>
              <div class="list-items" id="listItems">
                <span style="color: #95a5a6;">No items added yet</span>
              </div>
              <div class="help-text">Add items that will appear in the dropdown</div>
            </div>
          `;
        
        case 'number':
          return `
            <div class="config-row">
              <div class="input-group">
                <label class="input-label">Minimum Value</label>
                <input type="number" id="minValue" class="input-field" placeholder="e.g., 0" onchange="updatePreview()">
              </div>
              <div class="input-group">
                <label class="input-label">Maximum Value</label>
                <input type="number" id="maxValue" class="input-field" placeholder="e.g., 100" onchange="updatePreview()">
              </div>
            </div>
            <div class="checkbox-container">
              <input type="checkbox" id="allowDecimals" checked onchange="updatePreview()">
              <label for="allowDecimals" class="checkbox-label">Allow decimal numbers</label>
            </div>
          `;
        
        case 'text':
          return `
            <div class="config-row">
              <div class="input-group">
                <label class="input-label">Minimum Length</label>
                <input type="number" id="minLength" class="input-field" placeholder="e.g., 1" min="0" onchange="updatePreview()">
              </div>
              <div class="input-group">
                <label class="input-label">Maximum Length</label>
                <input type="number" id="maxLength" class="input-field" placeholder="e.g., 255" min="1" onchange="updatePreview()">
              </div>
            </div>
            <div class="input-group">
              <label class="input-label">Pattern (Optional - Regular Expression)</label>
              <input type="text" id="textPattern" class="input-field" placeholder="e.g., ^[A-Z].*" onchange="updatePreview()">
              <div class="help-text">Use regex for advanced text validation</div>
            </div>
          `;
        
        case 'date':
          return `
            <div class="config-row">
              <div class="input-group">
                <label class="input-label">Start Date</label>
                <input type="date" id="startDate" class="input-field" onchange="updatePreview()">
              </div>
              <div class="input-group">
                <label class="input-label">End Date</label>
                <input type="date" id="endDate" class="input-field" onchange="updatePreview()">
              </div>
            </div>
            <div class="checkbox-container">
              <input type="checkbox" id="allowPastDates" onchange="updatePreview()">
              <label for="allowPastDates" class="checkbox-label">Allow past dates only</label>
            </div>
            <div class="checkbox-container">
              <input type="checkbox" id="allowFutureDates" onchange="updatePreview()">
              <label for="allowFutureDates" class="checkbox-label">Allow future dates only</label>
            </div>
          `;
        
        case 'custom':
          return `
            <div class="input-group">
              <label class="input-label">Custom Formula</label>
              <textarea id="customFormula" class="input-field" rows="4" placeholder="e.g., =AND(A1>0, A1<100)" onchange="updatePreview()"></textarea>
              <div class="help-text">Enter a formula that returns TRUE for valid values</div>
            </div>
            <div class="input-group">
              <label class="input-label">Error Message</label>
              <input type="text" id="errorMessage" class="input-field" placeholder="Value does not meet requirements" onchange="updatePreview()">
            </div>
          `;
        
        case 'checkbox':
          return `
            <div class="help-text">This will add checkbox validation to the selected cells</div>
            <div class="checkbox-container">
              <input type="checkbox" id="defaultChecked" onchange="updatePreview()">
              <label for="defaultChecked" class="checkbox-label">Default to checked</label>
            </div>
          `;
        
        case 'email':
          return `
            <div class="help-text">Validates email addresses in format: user@domain.com</div>
            <div class="checkbox-container">
              <input type="checkbox" id="allowMultiple" onchange="updatePreview()">
              <label for="allowMultiple" class="checkbox-label">Allow multiple emails (comma-separated)</label>
            </div>
          `;
        
        case 'range':
          return `
            <div class="input-group">
              <label class="input-label">Source Range</label>
              <input type="text" id="sourceRange" class="input-field" placeholder="e.g., Sheet2!A1:A10" onchange="updatePreview()">
              <div class="help-text">Values must match items in this range</div>
            </div>
            <div class="checkbox-container">
              <input type="checkbox" id="allowBlank" checked onchange="updatePreview()">
              <label for="allowBlank" class="checkbox-label">Allow blank values</label>
            </div>
          `;
        
        default:
          return '<div class="help-text">Select a validation type to configure</div>';
      }
    }

    function addListItem() {
      const input = document.getElementById('newItem');
      const value = input.value.trim();
      
      if (!value) return;
      
      const container = document.getElementById('listItems');
      
      // Clear placeholder text if exists
      if (container.innerHTML.includes('No items added yet')) {
        container.innerHTML = '';
      }
      
      // Create item element
      const item = document.createElement('div');
      item.className = 'list-item';
      item.innerHTML = `
        <span>${value}</span>
        <span class="remove-item" onclick="removeListItem(this)">√ó</span>
      `;
      
      container.appendChild(item);
      input.value = '';
      input.focus();
      
      updatePreview();
    }

    function removeListItem(element) {
      element.parentElement.remove();
      
      const container = document.getElementById('listItems');
      if (container.children.length === 0) {
        container.innerHTML = '<span style="color: #95a5a6;">No items added yet</span>';
      }
      
      updatePreview();
    }

    function updatePreview() {
      const preview = document.getElementById('rulePreview');
      
      if (!selectedType) {
        preview.textContent = 'No validation rule configured yet. Select a validation type above.';
        return;
      }
      
      const startCell = document.getElementById('startCell').value || 'A1';
      const endCell = document.getElementById('endCell').value || 'A100';
      let previewText = `Type: ${selectedType.charAt(0).toUpperCase() + selectedType.slice(1)}\n`;
      previewText += `Range: ${startCell}:${endCell}\n\n`;
      
      switch(selectedType) {
        case 'list':
          const items = Array.from(document.querySelectorAll('#listItems .list-item span:first-child'))
                              .map(span => span.textContent);
          previewText += items.length > 0 
            ? `Allowed values:\n‚Ä¢ ${items.join('\n‚Ä¢ ')}`
            : 'No items configured';
          break;
        
        case 'number':
          const min = document.getElementById('minValue').value;
          const max = document.getElementById('maxValue').value;
          const decimals = document.getElementById('allowDecimals').checked;
          previewText += `Range: ${min || 'any'} to ${max || 'any'}\n`;
          previewText += `Decimals: ${decimals ? 'Allowed' : 'Not allowed'}`;
          break;
        
        case 'text':
          const minLen = document.getElementById('minLength').value;
          const maxLen = document.getElementById('maxLength').value;
          const pattern = document.getElementById('textPattern').value;
          previewText += `Length: ${minLen || '0'} to ${maxLen || 'unlimited'} characters\n`;
          if (pattern) previewText += `Pattern: ${pattern}`;
          break;
        
        case 'date':
          const startDate = document.getElementById('startDate').value;
          const endDate = document.getElementById('endDate').value;
          previewText += `Date range: ${startDate || 'any'} to ${endDate || 'any'}`;
          break;
        
        case 'custom':
          const formula = document.getElementById('customFormula').value;
          previewText += formula ? `Formula: ${formula}` : 'No formula configured';
          break;
        
        case 'checkbox':
          previewText += 'Checkbox validation (TRUE/FALSE values)';
          break;
        
        case 'email':
          previewText += 'Email validation (user@domain.com format)';
          break;
        
        case 'range':
          const sourceRange = document.getElementById('sourceRange').value;
          previewText += sourceRange ? `Source: ${sourceRange}` : 'No source range configured';
          break;
      }
      
      preview.textContent = previewText;
    }

    function toggleAdvanced() {
      const content = document.getElementById('advancedContent');
      const arrow = document.getElementById('advancedArrow');
      
      if (content.classList.contains('show')) {
        content.classList.remove('show');
        arrow.textContent = '‚ñ∂';
      } else {
        content.classList.add('show');
        arrow.textContent = '‚ñº';
      }
    }

    function toggleTemplates() {
      const gallery = document.getElementById('templateGallery');
      gallery.style.display = gallery.style.display === 'none' ? 'block' : 'none';
    }

    function applyTemplate(template) {
      switch(template) {
        case 'status':
          selectValidationType('list');
          setTimeout(() => {
            const items = ['Not Started', 'In Progress', 'Review', 'Complete', 'On Hold'];
            const container = document.getElementById('listItems');
            container.innerHTML = '';
            items.forEach(item => {
              container.innerHTML += `
                <div class="list-item">
                  <span>${item}</span>
                  <span class="remove-item" onclick="removeListItem(this)">√ó</span>
                </div>
              `;
            });
            updatePreview();
          }, 100);
          break;
        
        case 'priority':
          selectValidationType('list');
          setTimeout(() => {
            const items = ['Low', 'Medium', 'High', 'Critical'];
            const container = document.getElementById('listItems');
            container.innerHTML = '';
            items.forEach(item => {
              container.innerHTML += `
                <div class="list-item">
                  <span>${item}</span>
                  <span class="remove-item" onclick="removeListItem(this)">√ó</span>
                </div>
              `;
            });
            updatePreview();
          }, 100);
          break;
        
        case 'rating':
          selectValidationType('number');
          setTimeout(() => {
            document.getElementById('minValue').value = '1';
            document.getElementById('maxValue').value = '5';
            document.getElementById('allowDecimals').checked = false;
            updatePreview();
          }, 100);
          break;
        
        case 'yesno':
          selectValidationType('list');
          setTimeout(() => {
            const items = ['Yes', 'No'];
            const container = document.getElementById('listItems');
            container.innerHTML = '';
            items.forEach(item => {
              container.innerHTML += `
                <div class="list-item">
                  <span>${item}</span>
                  <span class="remove-item" onclick="removeListItem(this)">√ó</span>
                </div>
              `;
            });
            updatePreview();
          }, 100);
          break;
        
        case 'department':
          selectValidationType('list');
          setTimeout(() => {
            const items = ['Sales', 'Marketing', 'Engineering', 'HR', 'Finance', 'Operations', 'Support'];
            const container = document.getElementById('listItems');
            container.innerHTML = '';
            items.forEach(item => {
              container.innerHTML += `
                <div class="list-item">
                  <span>${item}</span>
                  <span class="remove-item" onclick="removeListItem(this)">√ó</span>
                </div>
              `;
            });
            updatePreview();
          }, 100);
          break;
        
        case 'country':
          selectValidationType('list');
          setTimeout(() => {
            const items = ['United States', 'Canada', 'United Kingdom', 'Australia', 'Germany', 'France', 'Japan', 'China', 'India', 'Brazil'];
            const container = document.getElementById('listItems');
            container.innerHTML = '';
            items.forEach(item => {
              container.innerHTML += `
                <div class="list-item">
                  <span>${item}</span>
                  <span class="remove-item" onclick="removeListItem(this)">√ó</span>
                </div>
              `;
            });
            updatePreview();
          }, 100);
          break;
      }
      
      // Hide template gallery after selection
      document.getElementById('templateGallery').style.display = 'none';
    }

    function buildValidationRule() {
      const rule = {
        type: selectedType,
        range: {
          start: document.getElementById('startCell').value || 'A1',
          end: document.getElementById('endCell').value || 'A100'
        },
        showDropdown: document.getElementById('showDropdown').checked,
        rejectInvalid: document.getElementById('rejectInvalid').checked,
        showHelp: document.getElementById('showHelp').checked,
        helpText: document.getElementById('showHelp').checked ? document.getElementById('helpText').value : ''
      };
      
      // Add type-specific configuration
      switch(selectedType) {
        case 'list':
          const items = Array.from(document.querySelectorAll('#listItems .list-item span:first-child'))
                              .map(span => span.textContent);
          rule.items = items;
          break;
        
        case 'number':
          rule.min = document.getElementById('minValue').value;
          rule.max = document.getElementById('maxValue').value;
          rule.allowDecimals = document.getElementById('allowDecimals').checked;
          break;
        
        case 'text':
          rule.minLength = document.getElementById('minLength').value;
          rule.maxLength = document.getElementById('maxLength').value;
          rule.pattern = document.getElementById('textPattern').value;
          break;
        
        case 'date':
          rule.startDate = document.getElementById('startDate').value;
          rule.endDate = document.getElementById('endDate').value;
          rule.allowPastDates = document.getElementById('allowPastDates').checked;
          rule.allowFutureDates = document.getElementById('allowFutureDates').checked;
          break;
        
        case 'custom':
          rule.formula = document.getElementById('customFormula').value;
          rule.errorMessage = document.getElementById('errorMessage').value;
          break;
        
        case 'checkbox':
          rule.defaultChecked = document.getElementById('defaultChecked').checked;
          break;
        
        case 'email':
          rule.allowMultiple = document.getElementById('allowMultiple').checked;
          break;
        
        case 'range':
          rule.sourceRange = document.getElementById('sourceRange').value;
          rule.allowBlank = document.getElementById('allowBlank').checked;
          break;
      }
      
      return rule;
    }

    function applyValidation() {
      if (!selectedType) {
        showError('Please select a validation type');
        return;
      }
      
      const rule = buildValidationRule();
      
      // Show loading
      document.getElementById('loadingSpinner').style.display = 'block';
      document.getElementById('applyBtn').disabled = true;
      
      google.script.run
        .withSuccessHandler(function(result) {
          document.getElementById('loadingSpinner').style.display = 'none';
          document.getElementById('applyBtn').disabled = false;
          
          if (result.success) {
            showSuccess(result.message || 'Validation rule applied successfully!');
          } else {
            showError(result.error || 'Failed to apply validation rule');
          }
        })
        .withFailureHandler(function(error) {
          document.getElementById('loadingSpinner').style.display = 'none';
          document.getElementById('applyBtn').disabled = false;
          showError('Error: ' + error.toString());
        })
        .applyDataValidation(rule);
    }

    function testValidation() {
      const testValue = prompt('Enter a test value to validate:');
      if (testValue === null) return;
      
      const rule = buildValidationRule();
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.isValid) {
            showSuccess(`"${testValue}" is valid!`);
          } else {
            showError(`"${testValue}" is invalid. ${result.reason || ''}`);
          }
        })
        .withFailureHandler(function(error) {
          showError('Test failed: ' + error.toString());
        })
        .testDataValidation(rule, testValue);
    }

    function clearValidation() {
      const startCell = document.getElementById('startCell').value || 'A1';
      const endCell = document.getElementById('endCell').value || 'A100';
      
      if (confirm(`Clear all validation rules in range ${startCell}:${endCell}?`)) {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              showSuccess('Validation rules cleared successfully!');
            } else {
              showError('Failed to clear validation rules');
            }
          })
          .withFailureHandler(function(error) {
            showError('Error: ' + error.toString());
          })
          .clearDataValidation(startCell, endCell);
      }
    }

    function showSuccess(message) {
      const elem = document.getElementById('successMessage');
      elem.textContent = message;
      elem.style.display = 'block';
      setTimeout(() => {
        elem.style.display = 'none';
      }, 3000);
    }

    function showError(message) {
      const elem = document.getElementById('errorMessage');
      elem.textContent = message;
      elem.style.display = 'block';
      setTimeout(() => {
        elem.style.display = 'none';
      }, 5000);
    }
  </script>
</body>
</html>